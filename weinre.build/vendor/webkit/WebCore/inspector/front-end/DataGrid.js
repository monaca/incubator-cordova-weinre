/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *        notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *        notice, this list of conditions and the following disclaimer in the
 *        documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.         IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.DataGrid=function(e,t,i){this.element=document.createElement("div"),this.element.className="data-grid",this.element.tabIndex=0,this.element.addEventListener("keydown",this._keyDown.bind(this),!1),this._headerTable=document.createElement("table"),this._headerTable.className="header",this._headerTableHeaders={},this._dataTable=document.createElement("table"),this._dataTable.className="data",this._dataTable.addEventListener("mousedown",this._mouseDownInDataTable.bind(this),!0),this._dataTable.addEventListener("click",this._clickInDataTable.bind(this),!0),this._dataTable.addEventListener("contextmenu",this._contextMenuInDataTable.bind(this),!0),
// FIXME: Add a createCallback which is different from editCallback and has different
// behavior when creating a new node.
t&&(this._dataTable.addEventListener("dblclick",this._ondblclick.bind(this),!1),this._editCallback=t),i&&(this._deleteCallback=i),this.aligned={},this._scrollContainer=document.createElement("div"),this._scrollContainer.className="data-container",this._scrollContainer.appendChild(this._dataTable),this.element.appendChild(this._headerTable),this.element.appendChild(this._scrollContainer);var n=document.createElement("tr"),s=document.createElement("colgroup");for(var d in this._columnCount=0,e){(o=e[d]).disclosure&&(this.disclosureColumnIdentifier=d);var a=document.createElement("col");o.width&&(a.style.width=o.width),o.element=a,s.appendChild(a),(h=document.createElement("th")).className=d+"-column",h.columnIdentifier=d,this._headerTableHeaders[d]=h;var r=document.createElement("div");o.titleDOMFragment?r.appendChild(o.titleDOMFragment):r.textContent=o.title,h.appendChild(r),o.sort&&(h.addStyleClass("sort-"+o.sort),this._sortColumnCell=h),o.sortable&&(h.addEventListener("click",this._clickInHeaderCell.bind(this),!1),h.addStyleClass("sortable")),o.aligned&&(this.aligned[d]=o.aligned),n.appendChild(h),++this._columnCount}s.span=this._columnCount,(h=document.createElement("th")).className="corner",n.appendChild(h),this._headerTableColumnGroup=s,this._headerTable.appendChild(this._headerTableColumnGroup),this.headerTableBody.appendChild(n);var l=document.createElement("tr");for(var d in l.className="filler",e){var h,o=e[d];(h=document.createElement("td")).className=d+"-column",l.appendChild(h)}for(var d in this._dataTableColumnGroup=s.cloneNode(!0),this._dataTable.appendChild(this._dataTableColumnGroup),this.dataTableBody.appendChild(l),this.columns=e||{},this._columnsArray=[],e)e[d].ordinal=this._columnsArray.length,this._columnsArray.push(e[d]);for(var c=0;c<this._columnsArray.length;++c)this._columnsArray[c].bodyElement=this._dataTableColumnGroup.children[c];this.children=[],this.selectedNode=null,this.expandNodesWhenArrowing=!1,this.root=!0,this.hasChildren=!1,this.expanded=!0,this.revealed=!0,this.selected=!1,(this.dataGrid=this).indentWidth=15,this.resizers=[],this._columnWidthsInitialized=!1},WebInspector.DataGrid.prototype={_ondblclick:function(e){this._editing||this._editingNode||this._startEditing(e.target)},_startEditingColumnOfDataGridNode:function(e,t){this._editing=!0,this._editingNode=e,this._editingNode.select();var i=this._editingNode._element.children[t];WebInspector.startEditing(i,{context:i.textContent,commitHandler:this._editingCommitted.bind(this),cancelHandler:this._editingCancelled.bind(this)}),window.getSelection().setBaseAndExtent(i,0,i,1)},_startEditing:function(e){var t=e.enclosingNodeOrSelfWithNodeName("td");if(t){if(this._editingNode=this.dataGridNodeFromNode(e),!this._editingNode){if(!this.creationNode)return;this._editingNode=this.creationNode}
// Force editing the 1st column when editing the creation node
if(this._editingNode.isCreationNode)return this._startEditingColumnOfDataGridNode(this._editingNode,0);this._editing=!0,WebInspector.startEditing(t,{context:t.textContent,commitHandler:this._editingCommitted.bind(this),cancelHandler:this._editingCancelled.bind(this)}),window.getSelection().setBaseAndExtent(t,0,t,1)}},_editingCommitted:function(e,t,i,n,s){
// FIXME: We need more column identifiers here throughout this function.
// Not needed yet since only editable DataGrid is DOM Storage, which is Key - Value.
// FIXME: Better way to do this than regular expressions?
var d=parseInt(e.className.match(/\b(\d+)-column\b/)[1]),a=this._editingNode.data[d],r=this._editingNode;function l(e){if(s){if("forward"===s){if(r.isCreationNode&&0===d&&!e)return;return 0===d?this._startEditingColumnOfDataGridNode(r,1):(t=r.traverseNextNode(!0,null,!0))?this._startEditingColumnOfDataGridNode(t,0):r.isCreationNode&&e?(addCreationNode(!1),this._startEditingColumnOfDataGridNode(this.creationNode,0)):void 0}var t;if("backward"===s)return 1===d?this._startEditingColumnOfDataGridNode(r,0):(t=r.traversePreviousNode(!0,null,!0))?this._startEditingColumnOfDataGridNode(t,1):void 0}}if(a==t)return this._editingCancelled(e),void l.call(this,!1);
// Update the text in the datagrid that we typed
this._editingNode.data[d]=t,
// Make the callback - expects an editing node (table row), the column number that is being edited,
// the text that used to be there, and the new text.
this._editCallback(this._editingNode,d,a,t),this._editingNode.isCreationNode&&this.addCreationNode(!1),this._editingCancelled(e),l.call(this,!0)},_editingCancelled:function(e,t){delete this._editing,this._editingNode=null},get sortColumnIdentifier(){return this._sortColumnCell?this._sortColumnCell.columnIdentifier:null},get sortOrder(){return!this._sortColumnCell||this._sortColumnCell.hasStyleClass("sort-ascending")?"ascending":this._sortColumnCell.hasStyleClass("sort-descending")?"descending":null},get headerTableBody(){return"_headerTableBody"in this||(this._headerTableBody=this._headerTable.getElementsByTagName("tbody")[0],this._headerTableBody||(this._headerTableBody=this.element.ownerDocument.createElement("tbody"),this._headerTable.insertBefore(this._headerTableBody,this._headerTable.tFoot))),this._headerTableBody},get dataTableBody(){return"_dataTableBody"in this||(this._dataTableBody=this._dataTable.getElementsByTagName("tbody")[0],this._dataTableBody||(this._dataTableBody=this.element.ownerDocument.createElement("tbody"),this._dataTable.insertBefore(this._dataTableBody,this._dataTable.tFoot))),this._dataTableBody},autoSizeColumns:function(e,t,i){e&&(e=Math.min(e,Math.floor(100/this._columnCount)));var n={},s=this.columns;for(var d in s)n[d]=(s[d].title||"").length;for(var a=i?this._enumerateChildren(this,[],i+1):this.children,r=0;r<a.length;++r){var l=a[r];for(var d in s){var h=l.data[d]||"";h.length>n[d]&&(n[d]=h.length)}}var o=0;for(var d in s)o+=n[d];var c=0;for(var d in s){var u=Math.round(100*n[d]/o);e&&u<e?(c+=e-u,u=e):t&&t<u&&(c-=u-t,u=t),n[d]=u}for(;e&&0<c;)for(var d in s)if(n[d]>e&&(--n[d],!--c))break;for(;t&&c<0;)for(var d in s)if(n[d]<t&&(++n[d],!++c))break;for(var d in s)s[d].element.style.width=n[d]+"%";this._columnWidthsInitialized=!1,this.updateWidths()},_enumerateChildren:function(e,t,i){if(e.root||t.push(e),i){for(var n=0;n<e.children.length;++n)this._enumerateChildren(e.children[n],t,i-1);return t}},
// Updates the widths of the table, including the positions of the column
// resizers.
//
// IMPORTANT: This function MUST be called once after the element of the
// DataGrid is attached to its parent element and every subsequent time the
// width of the parent element is changed in order to make it possible to
// resize the columns.
//
// If this function is not called after the DataGrid is attached to its
// parent element, then the DataGrid's columns will not be resizable.
updateWidths:function(){var e=this._headerTableColumnGroup.children,t=this._dataTable.offsetWidth,i=e.length;
// Do not attempt to use offsetes if we're not attached to the document tree yet.
if(!this._columnWidthsInitialized&&this.element.offsetWidth){
// Give all the columns initial widths now so that during a resize,
// when the two columns that get resized get a percent value for
// their widths, all the other columns already have percent values
// for their widths.
for(var n=0;n<i;n++){var s=this.headerTableBody.rows[0].cells[n].offsetWidth/t*100+"%";this._headerTableColumnGroup.children[n].style.width=s,this._dataTableColumnGroup.children[n].style.width=s}this._columnWidthsInitialized=!0}this._positionResizers(),this.dispatchEventToListeners("width changed")},columnWidthsMap:function(){for(var e={},t=0;t<this._columnsArray.length;++t){var i=this._headerTableColumnGroup.children[t].style.width;e[this._columnsArray[t].columnIdentifier]=parseFloat(i)}return e},applyColumnWidthsMap:function(e){for(var t in this.columns){var i=this.columns[t],n=(e[t]||0)+"%";this._headerTableColumnGroup.children[i.ordinal].style.width=n,this._dataTableColumnGroup.children[i.ordinal].style.width=n}
// Normalize widths
delete this._columnWidthsInitialized,this.updateWidths()},isColumnVisible:function(e){return!this.columns[e].element.hidden},showColumn:function(e){var t=this.columns[e],i=t.element;if(i.hidden){i.hidden=!1,i.removeStyleClass("hidden");var n=t.bodyElement;n.hidden=!1,n.removeStyleClass("hidden")}},hideColumn:function(e){var t=this.columns[e],i=t.element;if(!i.hidden){parseFloat(i.style.width);i.hidden=!0,i.addStyleClass("hidden"),i.style.width=0;var n=t.bodyElement;n.hidden=!0,n.addStyleClass("hidden"),n.style.width=0,this._columnWidthsInitialized=!1}},get scrollContainer(){return this._scrollContainer},isScrolledToLastRow:function(){return this._scrollContainer.isScrolledToBottom()},scrollToLastRow:function(){this._scrollContainer.scrollTop=this._scrollContainer.scrollHeight-this._scrollContainer.offsetHeight},_positionResizers:function(){
// Make n - 1 resizers for n columns. 
for(var e=this._headerTableColumnGroup.children.length,t=0,i=null,n=0;n<e-1;n++){var s=this.resizers[n];s||(
// This is the first call to updateWidth, so the resizers need
// to be created.
(s=document.createElement("div")).addStyleClass("data-grid-resizer"),
// This resizer is associated with the column to its right.
s.addEventListener("mousedown",this._startResizerDragging.bind(this),!1),this.element.appendChild(s),this.resizers[n]=s),
// Get the width of the cell in the first (and only) row of the
// header table in order to determine the width of the column, since
// it is not possible to query a column for its width.
t+=this.headerTableBody.rows[0].cells[n].offsetWidth,!this._headerTableColumnGroup.children[n].hidden?(s.style.removeProperty("display"),s.style.left=t+"px",s.leftNeighboringColumnID=n,i&&(i.rightNeighboringColumnID=n),i=s):(s.style.setProperty("display","none"),s.leftNeighboringColumnID=0,s.rightNeighboringColumnID=0)}i&&(i.rightNeighboringColumnID=e-1)},addCreationNode:function(e){this.creationNode&&this.creationNode.makeNormal();var t={};for(var i in this.columns)t[i]="";this.creationNode=new WebInspector.CreationDataGridNode(t,e),this.appendChild(this.creationNode)},appendChild:function(e){this.insertChild(e,this.children.length)},insertChild:function(e,t){if(!e)throw"insertChild: Node can't be undefined or null.";if(e.parent===this)throw"insertChild: Node is already a child of this node.";e.parent&&e.parent.removeChild(e),this.children.splice(t,0,e),this.hasChildren=!0,e.parent=this,e.dataGrid=this.dataGrid,e._recalculateSiblings(t),delete e._depth,delete e._revealed,delete e._attached,e._shouldRefreshChildren=!0;for(var i=e.children[0];i;)i.dataGrid=this.dataGrid,delete i._depth,delete i._revealed,delete i._attached,i._shouldRefreshChildren=!0,i=i.traverseNextNode(!1,e,!0);this.expanded&&e._attach()},removeChild:function(e){if(!e)throw"removeChild: Node can't be undefined or null.";if(e.parent!==this)throw"removeChild: Node is not a child of this node.";e.deselect(),e._detach(),this.children.remove(e,!0),e.previousSibling&&(e.previousSibling.nextSibling=e.nextSibling),e.nextSibling&&(e.nextSibling.previousSibling=e.previousSibling),e.dataGrid=null,e.parent=null,e.nextSibling=null,e.previousSibling=null,this.children.length<=0&&(this.hasChildren=!1)},removeChildren:function(){for(var e=0;e<this.children.length;++e){var t=this.children[e];t.deselect(),t._detach(),t.dataGrid=null,t.parent=null,t.nextSibling=null,t.previousSibling=null}this.children=[],this.hasChildren=!1},removeChildrenRecursive:function(){for(var e=this.children,t=this.children[0];t;)t.children.length&&(e=e.concat(t.children)),t=t.traverseNextNode(!1,this,!0);for(var i=0;i<e.length;++i){(t=e[i]).deselect(),t._detach(),t.children=[],t.dataGrid=null,t.parent=null,t.nextSibling=null,t.previousSibling=null}this.children=[]},sortNodes:function(s,d){var e=this.dataTableBody,t=e.parentElement;t.removeChild(e);var i=e.childNodes,n=i[i.length-1],a=Array.prototype.slice.call(i,0,i.length-1);a.sort(function(e,t){if(e._dataGridNode._data.summaryRow)return 1;if(t._dataGridNode._data.summaryRow)return-1;var i=e._dataGridNode,n=t._dataGridNode;return d?s(n,i):s(i,n)});var r=a.length;e.removeChildren();for(var l=null,h=0;h<r;++h){var o=a[h],c=o._dataGridNode;(c.previousSibling=l)&&(l.nextSibling=c),e.appendChild(o),l=c}l&&(l.nextSibling=null),e.appendChild(n),t.appendChild(e)},_keyDown:function(e){if(!(!this.selectedNode||e.shiftKey||e.metaKey||e.ctrlKey||this._editing)){var t,i=!1;if("Up"!==e.keyIdentifier||e.altKey)if("Down"!==e.keyIdentifier||e.altKey)"Left"===e.keyIdentifier?this.selectedNode.expanded?(e.altKey?this.selectedNode.collapseRecursively():this.selectedNode.collapse(),i=!0):this.selectedNode.parent&&!this.selectedNode.parent.root&&(i=!0,this.selectedNode.parent.selectable?i=!!(t=this.selectedNode.parent):this.selectedNode.parent&&this.selectedNode.parent.collapse()):"Right"===e.keyIdentifier?this.selectedNode.revealed?this.selectedNode.hasChildren&&(i=!0,this.selectedNode.expanded?i=!!(t=this.selectedNode.children[0]):e.altKey?this.selectedNode.expandRecursively():this.selectedNode.expand()):(this.selectedNode.reveal(),i=!0):8===e.keyCode||46===e.keyCode?this._deleteCallback&&(i=!0,this._deleteCallback(this.selectedNode)):isEnterKey(e)&&this._editCallback&&(i=!0,
// The first child of the selected element is the <td class="0-column">,
// and that's what we want to edit.
this._startEditing(this.selectedNode._element.children[0]));else{for(t=this.selectedNode.traverseNextNode(!0);t&&!t.selectable;)t=t.traverseNextNode(!this.expandTreeNodesWhenArrowing);i=!!t}else{for(t=this.selectedNode.traversePreviousNode(!0);t&&!t.selectable;)t=t.traversePreviousNode(!this.expandTreeNodesWhenArrowing);i=!!t}t&&(t.reveal(),t.select()),i&&(e.preventDefault(),e.stopPropagation())}},expand:function(){
// This is the root, do nothing.
},collapse:function(){
// This is the root, do nothing.
},reveal:function(){
// This is the root, do nothing.
},dataGridNodeFromNode:function(e){return e.enclosingNodeOrSelfWithNodeName("tr")._dataGridNode},dataGridNodeFromPoint:function(e,t){return this._dataTable.ownerDocument.elementFromPoint(e,t).enclosingNodeOrSelfWithNodeName("tr")._dataGridNode},_clickInHeaderCell:function(e){var t=e.target.enclosingNodeOrSelfWithNodeName("th");if(t&&t.columnIdentifier&&t.hasStyleClass("sortable")){var i=this.sortOrder;this._sortColumnCell&&this._sortColumnCell.removeMatchingStyleClasses("sort-\\w+"),t==this._sortColumnCell&&(i="ascending"===i?"descending":"ascending"),(this._sortColumnCell=t).addStyleClass("sort-"+i),this.dispatchEventToListeners("sorting changed")}},markColumnAsSortedBy:function(e,t){this._sortColumnCell&&this._sortColumnCell.removeMatchingStyleClasses("sort-\\w+"),this._sortColumnCell=this._headerTableHeaders[e],this._sortColumnCell.addStyleClass("sort-"+t)},headerTableHeader:function(e){return this._headerTableHeaders[e]},_mouseDownInDataTable:function(e){var t=this.dataGridNodeFromNode(e.target);t&&t.selectable&&(t.isEventWithinDisclosureTriangle(e)||(e.metaKey&&t.selected?t.deselect():t.select()))},_contextMenuInDataTable:function(e){var t=this.dataGridNodeFromNode(e.target);if(t&&t.selectable&&!t.isEventWithinDisclosureTriangle(e)){var i=new WebInspector.ContextMenu;
// FIXME: Use the column names for Editing, instead of just "Edit".
this.dataGrid._editCallback&&(t===this.creationNode?i.appendItem(WebInspector.UIString("Add New"),this._startEditing.bind(this,e.target)):i.appendItem(WebInspector.UIString("Edit"),this._startEditing.bind(this,e.target))),this.dataGrid._deleteCallback&&t!==this.creationNode&&i.appendItem(WebInspector.UIString("Delete"),this._deleteCallback.bind(this,t)),i.show(e)}},_clickInDataTable:function(e){var t=this.dataGridNodeFromNode(e.target);t&&t.hasChildren&&t.isEventWithinDisclosureTriangle(e)&&(t.expanded?e.altKey?t.collapseRecursively():t.collapse():e.altKey?t.expandRecursively():t.expand())},_startResizerDragging:function(e){this.currentResizer=e.target,this.currentResizer.rightNeighboringColumnID&&WebInspector.elementDragStart(this.lastResizer,this._resizerDragging.bind(this),this._endResizerDragging.bind(this),e,"col-resize")},_resizerDragging:function(e){var t=this.currentResizer;if(t){for(
// Constrain the dragpoint to be within the containing div of the
// datagrid.
var i=e.clientX-this.element.totalOffsetLeft,n=0,s=this.headerTableBody.rows[0].cells,d=0
// Constrain the dragpoint to be within the space made up by the
// column directly to the left and the column directly to the right.
;d<t.leftNeighboringColumnID;d++)n+=s[d].offsetWidth;var a=n+s[t.leftNeighboringColumnID].offsetWidth+s[t.rightNeighboringColumnID].offsetWidth,r=n+this.ColumnResizePadding,l=a-this.ColumnResizePadding;
// Give each column some padding so that they don't disappear.
i=Number.constrain(i,r,l),t.style.left=i-this.CenterResizerOverBorderAdjustment+"px";var h=(i-n)/this._dataTable.offsetWidth*100+"%";this._headerTableColumnGroup.children[t.leftNeighboringColumnID].style.width=h,this._dataTableColumnGroup.children[t.leftNeighboringColumnID].style.width=h;var o=(a-i)/this._dataTable.offsetWidth*100+"%";this._headerTableColumnGroup.children[t.rightNeighboringColumnID].style.width=o,this._dataTableColumnGroup.children[t.rightNeighboringColumnID].style.width=o,this._positionResizers(),e.preventDefault(),this.dispatchEventToListeners("width changed")}},_endResizerDragging:function(e){WebInspector.elementDragEnd(e),this.currentResizer=null,this.dispatchEventToListeners("width changed")},ColumnResizePadding:10,CenterResizerOverBorderAdjustment:3},WebInspector.DataGrid.prototype.__proto__=WebInspector.Object.prototype,WebInspector.DataGridNode=function(e,t){this._expanded=!1,this._selected=!1,this._shouldRefreshChildren=!0,this._data=e||{},this.hasChildren=t||!1,this.children=[],this.dataGrid=null,this.parent=null,this.previousSibling=null,this.nextSibling=null,this.disclosureToggleWidth=10},WebInspector.DataGridNode.prototype={selectable:!0,get element(){return this._element?this._element:this.dataGrid?(this._element=document.createElement("tr"),(this._element._dataGridNode=this).hasChildren&&this._element.addStyleClass("parent"),this.expanded&&this._element.addStyleClass("expanded"),this.selected&&this._element.addStyleClass("selected"),this.revealed&&this._element.addStyleClass("revealed"),this.createCells(),this._element):null},createCells:function(){for(var e in this.dataGrid.columns){var t=this.createCell(e);this._element.appendChild(t)}},get data(){return this._data},set data(e){this._data=e||{},this.refresh()},get revealed(){if("_revealed"in this)return this._revealed;for(var e=this.parent;e&&!e.root;){if(!e.expanded)return this._revealed=!1;e=e.parent}return this._revealed=!0},set hasChildren(e){this._hasChildren!==e&&(this._hasChildren=e,this._element&&(this._hasChildren?(this._element.addStyleClass("parent"),this.expanded&&this._element.addStyleClass("expanded")):(this._element.removeStyleClass("parent"),this._element.removeStyleClass("expanded"))))},get hasChildren(){return this._hasChildren},set revealed(e){if(this._revealed!==e){this._revealed=e,this._element&&(this._revealed?this._element.addStyleClass("revealed"):this._element.removeStyleClass("revealed"));for(var t=0;t<this.children.length;++t)this.children[t].revealed=e&&this.expanded}},get depth(){return"_depth"in this||(this.parent&&!this.parent.root?this._depth=this.parent.depth+1:this._depth=0),this._depth},get shouldRefreshChildren(){return this._shouldRefreshChildren},set shouldRefreshChildren(e){(this._shouldRefreshChildren=e)&&this.expanded&&this.expand()},get selected(){return this._selected},set selected(e){e?this.select():this.deselect()},get expanded(){return this._expanded},set expanded(e){e?this.expand():this.collapse()},refresh:function(){this._element&&this.dataGrid&&(this._element.removeChildren(),this.createCells())},createCell:function(e){var t=document.createElement("td");t.className=e+"-column";var i=this.dataGrid.aligned[e];i&&t.addStyleClass(i);var n=document.createElement("div");return n.textContent=this.data[e],t.appendChild(n),e===this.dataGrid.disclosureColumnIdentifier&&(t.addStyleClass("disclosure"),this.depth&&t.style.setProperty("padding-left",this.depth*this.dataGrid.indentWidth+"px")),t},
// Share these functions with DataGrid. They are written to work with a DataGridNode this object.
appendChild:WebInspector.DataGrid.prototype.appendChild,insertChild:WebInspector.DataGrid.prototype.insertChild,removeChild:WebInspector.DataGrid.prototype.removeChild,removeChildren:WebInspector.DataGrid.prototype.removeChildren,removeChildrenRecursive:WebInspector.DataGrid.prototype.removeChildrenRecursive,_recalculateSiblings:function(e){if(this.parent){var t=0<e?this.parent.children[e-1]:null;t?(t.nextSibling=this).previousSibling=t:this.previousSibling=null;var i=this.parent.children[e+1];i?(i.previousSibling=this).nextSibling=i:this.nextSibling=null}},collapse:function(){this._element&&this._element.removeStyleClass("expanded"),this._expanded=!1;for(var e=0;e<this.children.length;++e)this.children[e].revealed=!1;this.dispatchEventToListeners("collapsed")},collapseRecursively:function(){for(var e=this;e;)e.expanded&&e.collapse(),e=e.traverseNextNode(!1,this,!0)},expand:function(){if(this.hasChildren&&!this.expanded){if(this.revealed&&!this._shouldRefreshChildren)for(var e=0;e<this.children.length;++e)this.children[e].revealed=!0;if(this._shouldRefreshChildren){for(e=0;e<this.children.length;++e)this.children[e]._detach();if(this.dispatchEventToListeners("populate"),this._attached)for(e=0;e<this.children.length;++e){var t=this.children[e];this.revealed&&(t.revealed=!0),t._attach()}delete this._shouldRefreshChildren}this._element&&this._element.addStyleClass("expanded"),this._expanded=!0,this.dispatchEventToListeners("expanded")}},expandRecursively:function(){for(var e=this;e;)e.expand(),e=e.traverseNextNode(!1,this)},reveal:function(){for(var e=this.parent;e&&!e.root;)e.expanded||e.expand(),e=e.parent;this.element.scrollIntoViewIfNeeded(!1),this.dispatchEventToListeners("revealed")},select:function(e){this.dataGrid&&this.selectable&&!this.selected&&(this.dataGrid.selectedNode&&this.dataGrid.selectedNode.deselect(),this._selected=!0,(this.dataGrid.selectedNode=this)._element&&this._element.addStyleClass("selected"),e||this.dispatchEventToListeners("selected"))},deselect:function(e){this.dataGrid&&this.dataGrid.selectedNode===this&&this.selected&&(this._selected=!1,this.dataGrid.selectedNode=null,this._element&&this._element.removeStyleClass("selected"),e||this.dispatchEventToListeners("deselected"))},traverseNextNode:function(e,t,i,n){!i&&this.hasChildren&&this.dispatchEventToListeners("populate"),n&&(n.depthChange=0);var s=!e||this.revealed?this.children[0]:null;if(s&&(!e||this.expanded))return n&&(n.depthChange=1),s;if(this===t)return null;if(s=!e||this.revealed?this.nextSibling:null)return s;for(s=this;s&&!s.root&&(e&&!s.revealed||!s.nextSibling)&&s.parent!==t;)n&&(n.depthChange-=1),s=s.parent;return s&&(!e||s.revealed)?s.nextSibling:null},traversePreviousNode:function(e,t){var i=!e||this.revealed?this.previousSibling:null;for(!t&&i&&i.hasChildren&&i.dispatchEventToListeners("populate");i&&(!e||i.revealed&&i.expanded)&&i.children[i.children.length-1];)!t&&i.hasChildren&&i.dispatchEventToListeners("populate"),i=!e||i.revealed&&i.expanded?i.children[i.children.length-1]:null;return i||(!this.parent||this.parent.root?null:this.parent)},isEventWithinDisclosureTriangle:function(e){if(!this.hasChildren)return!1;var t=e.target.enclosingNodeOrSelfWithNodeName("td");if(!t.hasStyleClass("disclosure"))return!1;var i=window.getComputedStyle(t).getPropertyCSSValue("padding-left").getFloatValue(CSSPrimitiveValue.CSS_PX),n=t.totalOffsetLeft+i;return e.pageX>=n&&e.pageX<=n+this.disclosureToggleWidth},_attach:function(){if(this.dataGrid&&!this._attached){this._attached=!0;var e=null,t=this.traversePreviousNode(!0,!0);if(t&&t.element.parentNode&&t.element.nextSibling)e=t.element.nextSibling;if(e||(e=this.dataGrid.dataTableBody.lastChild),this.dataGrid.dataTableBody.insertBefore(this.element,e),this.expanded)for(var i=0;i<this.children.length;++i)this.children[i]._attach()}},_detach:function(){if(this._attached){this._attached=!1,this._element&&this._element.parentNode&&this._element.parentNode.removeChild(this._element);for(var e=0;e<this.children.length;++e)this.children[e]._detach()}},savePosition:function(){if(!this._savedPosition){if(!this.parent)throw"savePosition: Node must have a parent.";this._savedPosition={parent:this.parent,index:this.parent.children.indexOf(this)}}},restorePosition:function(){this._savedPosition&&(this.parent!==this._savedPosition.parent&&this._savedPosition.parent.insertChild(this,this._savedPosition.index),delete this._savedPosition)}},WebInspector.DataGridNode.prototype.__proto__=WebInspector.Object.prototype,WebInspector.CreationDataGridNode=function(e,t){WebInspector.DataGridNode.call(this,e,t),this.isCreationNode=!0},WebInspector.CreationDataGridNode.prototype={makeNormal:function(){delete this.isCreationNode,delete this.makeNormal}},WebInspector.CreationDataGridNode.prototype.__proto__=WebInspector.DataGridNode.prototype;