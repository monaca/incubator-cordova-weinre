/*
 * Copyright (C) 2009 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.TimelinePanel=function(){WebInspector.Panel.call(this,"timeline"),this.element.appendChild(this._createTopPane()),this.element.tabIndex=0,this._sidebarBackgroundElement=document.createElement("div"),this._sidebarBackgroundElement.className="sidebar timeline-sidebar-background",this.element.appendChild(this._sidebarBackgroundElement),this._containerElement=document.createElement("div"),this._containerElement.id="timeline-container",this._containerElement.addEventListener("scroll",this._onScroll.bind(this),!1),this.element.appendChild(this._containerElement),this.createSidebar(this._containerElement,this._containerElement);var e=new WebInspector.SidebarSectionTreeElement(WebInspector.UIString("RECORDS"),{},!0);e.expanded=!0,this.sidebarTree.appendChild(e),this._sidebarListElement=document.createElement("div"),this.sidebarElement.appendChild(this._sidebarListElement),this._containerContentElement=document.createElement("div"),this._containerContentElement.id="resources-container-content",this._containerElement.appendChild(this._containerContentElement),this._timelineGrid=new WebInspector.TimelineGrid,this._itemsGraphsElement=this._timelineGrid.itemsGraphsElement,this._itemsGraphsElement.id="timeline-graphs",this._containerContentElement.appendChild(this._timelineGrid.element),this._topGapElement=document.createElement("div"),this._topGapElement.className="timeline-gap",this._itemsGraphsElement.appendChild(this._topGapElement),this._graphRowsElement=document.createElement("div"),this._itemsGraphsElement.appendChild(this._graphRowsElement),this._bottomGapElement=document.createElement("div"),this._bottomGapElement.className="timeline-gap",this._itemsGraphsElement.appendChild(this._bottomGapElement),this._expandElements=document.createElement("div"),this._expandElements.id="orphan-expand-elements",this._itemsGraphsElement.appendChild(this._expandElements),this._rootRecord=this._createRootRecord(),this._sendRequestRecords={},this._scheduledResourceRequests={},this._timerRecords={},this._calculator=new WebInspector.TimelineCalculator,this._calculator._showShortEvents=!1;var t=Number.secondsToString(WebInspector.TimelinePanel.shortRecordThreshold);this._showShortRecordsTitleText=WebInspector.UIString("Show the records that are shorter than %s",t),this._hideShortRecordsTitleText=WebInspector.UIString("Hide the records that are shorter than %s",t),this._createStatusbarButtons(),this._boundariesAreValid=!0,this._scrollTop=0,this._popoverHelper=new WebInspector.PopoverHelper(this._containerElement,this._getPopoverAnchor.bind(this),this._showPopover.bind(this),!0),
// Disable short events filter by default.
this.toggleFilterButton.toggled=!0,this._calculator._showShortEvents=this.toggleFilterButton.toggled,this._markTimelineRecords=[],this._expandOffset=15,InspectorBackend.registerDomainDispatcher("Timeline",new WebInspector.TimelineDispatcher(this))}
// Define row height, should be in sync with styles for timeline graphs.
,WebInspector.TimelinePanel.rowHeight=18,WebInspector.TimelinePanel.shortRecordThreshold=.015,WebInspector.TimelinePanel.prototype={_createTopPane:function(){var e=document.createElement("div");e.id="timeline-overview-panel",this._topPaneSidebarElement=document.createElement("div"),this._topPaneSidebarElement.id="timeline-overview-sidebar";var t=document.createElement("ol");t.className="sidebar-tree",this._topPaneSidebarElement.appendChild(t),e.appendChild(this._topPaneSidebarElement);var i=new TreeOutline(t),n=new WebInspector.SidebarTreeElement("resources-time-graph-sidebar-item",WebInspector.UIString("Timelines"));i.appendChild(n),n.onselect=this._timelinesOverviewItemSelected.bind(this),n.select(!0);var s=new WebInspector.SidebarTreeElement("resources-size-graph-sidebar-item",WebInspector.UIString("Memory"));i.appendChild(s),s.onselect=this._memoryOverviewItemSelected.bind(this),this._overviewPane=new WebInspector.TimelineOverviewPane(this.categories),this._overviewPane.addEventListener("window changed",this._windowChanged,this),this._overviewPane.addEventListener("filter changed",this._refresh,this),e.appendChild(this._overviewPane.element);var r=document.createElement("div");return r.id="timeline-overview-separator",e.appendChild(r),e},get toolbarItemLabel(){return WebInspector.UIString("Timeline")},get statusBarItems(){return[this.toggleFilterButton.element,this.toggleTimelineButton.element,this.clearButton.element,this._overviewPane.statusBarFilters]},get categories(){return this._categories||(this._categories={loading:new WebInspector.TimelineCategory("loading",WebInspector.UIString("Loading"),"rgb(47,102,236)"),scripting:new WebInspector.TimelineCategory("scripting",WebInspector.UIString("Scripting"),"rgb(157,231,119)"),rendering:new WebInspector.TimelineCategory("rendering",WebInspector.UIString("Rendering"),"rgb(164,60,255)")}),this._categories},get defaultFocusedElement(){return this.element},get _recordStyles(){if(!this._recordStylesArray){var e=WebInspector.TimelineAgent.RecordType,t={};t[e.EventDispatch]={title:WebInspector.UIString("Event"),category:this.categories.scripting},t[e.Layout]={title:WebInspector.UIString("Layout"),category:this.categories.rendering},t[e.RecalculateStyles]={title:WebInspector.UIString("Recalculate Style"),category:this.categories.rendering},t[e.Paint]={title:WebInspector.UIString("Paint"),category:this.categories.rendering},t[e.ParseHTML]={title:WebInspector.UIString("Parse"),category:this.categories.loading},t[e.TimerInstall]={title:WebInspector.UIString("Install Timer"),category:this.categories.scripting},t[e.TimerRemove]={title:WebInspector.UIString("Remove Timer"),category:this.categories.scripting},t[e.TimerFire]={title:WebInspector.UIString("Timer Fired"),category:this.categories.scripting},t[e.XHRReadyStateChange]={title:WebInspector.UIString("XHR Ready State Change"),category:this.categories.scripting},t[e.XHRLoad]={title:WebInspector.UIString("XHR Load"),category:this.categories.scripting},t[e.EvaluateScript]={title:WebInspector.UIString("Evaluate Script"),category:this.categories.scripting},t[e.MarkTimeline]={title:WebInspector.UIString("Mark"),category:this.categories.scripting},t[e.ResourceSendRequest]={title:WebInspector.UIString("Send Request"),category:this.categories.loading},t[e.ResourceReceiveResponse]={title:WebInspector.UIString("Receive Response"),category:this.categories.loading},t[e.ResourceFinish]={title:WebInspector.UIString("Finish Loading"),category:this.categories.loading},t[e.FunctionCall]={title:WebInspector.UIString("Function Call"),category:this.categories.scripting},t[e.ResourceReceiveData]={title:WebInspector.UIString("Receive Data"),category:this.categories.loading},t[e.GCEvent]={title:WebInspector.UIString("GC Event"),category:this.categories.scripting},t[e.MarkDOMContentEventType]={title:WebInspector.UIString("DOMContent event"),category:this.categories.scripting},t[e.MarkLoadEventType]={title:WebInspector.UIString("Load event"),category:this.categories.scripting},t[e.ScheduleResourceRequest]={title:WebInspector.UIString("Schedule Request"),category:this.categories.loading},this._recordStylesArray=t}return this._recordStylesArray},_createStatusbarButtons:function(){this.toggleTimelineButton=new WebInspector.StatusBarButton(WebInspector.UIString("Record"),"record-profile-status-bar-item"),this.toggleTimelineButton.addEventListener("click",this._toggleTimelineButtonClicked.bind(this),!1),this.clearButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear"),"clear-status-bar-item"),this.clearButton.addEventListener("click",this._clearPanel.bind(this),!1),this.toggleFilterButton=new WebInspector.StatusBarButton(this._hideShortRecordsTitleText,"timeline-filter-status-bar-item"),this.toggleFilterButton.addEventListener("click",this._toggleFilterButtonClicked.bind(this),!1),this.recordsCounter=document.createElement("span"),this.recordsCounter.className="timeline-records-counter"},_updateRecordsCounter:function(){this.recordsCounter.textContent=WebInspector.UIString("%d of %d captured records are visible",this._rootRecord._visibleRecordsCount,this._rootRecord._allRecordsCount)},_updateEventDividers:function(){this._timelineGrid.removeEventDividers();for(var e=this._graphRowsElement.offsetWidth-this._expandOffset,t=[],i=0;i<this._markTimelineRecords.length;++i){var n=this._markTimelineRecords[i],s=this._calculator.computeBarGraphWindowPosition(n,e),r=Math.round(s.left);if(!(r<0||e<=r||t[r])){var a=this._createEventDivider(n);a.style.left=r+this._expandOffset+"px",t[r]=a}}this._timelineGrid.addEventDividers(t),this._overviewPane.updateEventDividers(this._markTimelineRecords,this._createEventDivider.bind(this))},_createEventDivider:function(e){var t=document.createElement("div");t.className="resources-event-divider";var i=WebInspector.TimelineAgent.RecordType,n=document.createElement("div");return n.className="resources-event-divider-padding",n.title=e.title,e.type===i.MarkDOMContentEventType?t.className+=" resources-blue-divider":e.type===i.MarkLoadEventType?t.className+=" resources-red-divider":e.type===i.MarkTimeline&&(t.className+=" resources-orange-divider",n.title=e.data.message),n.appendChild(t),n},_timelinesOverviewItemSelected:function(e){this._overviewPane.showTimelines()},_memoryOverviewItemSelected:function(e){this._overviewPane.showMemoryGraph(this._rootRecord.children)},_toggleTimelineButtonClicked:function(){this.toggleTimelineButton.toggled?InspectorBackend.stopTimelineProfiler():(this._clearPanel(),InspectorBackend.startTimelineProfiler())},_toggleFilterButtonClicked:function(){this.toggleFilterButton.toggled=!this.toggleFilterButton.toggled,this._calculator._showShortEvents=this.toggleFilterButton.toggled,this.toggleFilterButton.element.title=this._calculator._showShortEvents?this._hideShortRecordsTitleText:this._showShortRecordsTitleText,this._scheduleRefresh(!0)},_timelineProfilerWasStarted:function(){this.toggleTimelineButton.toggled=!0},_timelineProfilerWasStopped:function(){this.toggleTimelineButton.toggled=!1},_addRecordToTimeline:function(e){e.type==WebInspector.TimelineAgent.RecordType.ResourceSendRequest&&(e.data.identifier===WebInspector.mainResource.identifier&&this._mainResourceIdentifier!==e.data.identifier&&(
// We are loading new main resource -> clear the panel. Check above is necessary since
// there may be several resource loads with main resource marker upon redirects, redirects are reported with
// the original identifier.
this._mainResourceIdentifier=e.data.identifier,this._clearPanel()));this._innerAddRecordToTimeline(e,this._rootRecord),this._scheduleRefresh()},_findParentRecord:function(e){var t,i=WebInspector.TimelineAgent.RecordType;return e.type===i.ResourceReceiveResponse||e.type===i.ResourceFinish||e.type===i.ResourceReceiveData?t=this._sendRequestRecords[e.data.identifier]:e.type===i.TimerFire?t=this._timerRecords[e.data.timerId]:e.type===i.ResourceSendRequest&&(t=this._scheduledResourceRequests[e.data.url]),t},_innerAddRecordToTimeline:function(e,t){var i=!1,n=WebInspector.TimelineAgent.RecordType;if(e.type===n.MarkDOMContentEventType||e.type===n.MarkLoadEventType)t=null;// No bar entry for load events.
else if(t===this._rootRecord){var s=this._findParentRecord(e);s&&(t=s,i=!0)}if(e.type==n.TimerFire&&e.children&&e.children.length){var r=e.children[0];r.type===n.FunctionCall&&(e.data.scriptName=r.data.scriptName,e.data.scriptLine=r.data.scriptLine,e.children.shift(),e.children=r.children.concat(e.children))}var a=new WebInspector.TimelinePanel.FormattedRecord(e,t,this);if(e.type!==n.MarkDOMContentEventType&&e.type!==n.MarkLoadEventType){++this._rootRecord._allRecordsCount,a.collapsed=t===this._rootRecord;for(var o=e.children?e.children.length:0,l=0;l<o;++l)this._innerAddRecordToTimeline(e.children[l],a);if(a._calculateAggregatedStats(this.categories),i){e=a;do{var d=e.parent;for(var c in d._cpuTime+=a._cpuTime,d._lastChildEndTime<e._lastChildEndTime&&(d._lastChildEndTime=e._lastChildEndTime),a._aggregatedStats)d._aggregatedStats[c]+=a._aggregatedStats[c];e=d}while(e.parent)}else t!==this._rootRecord&&(t._selfTime-=a.endTime-a.startTime);
// Keep bar entry for mark timeline since nesting might be interesting to the user.
e.type===n.MarkTimeline&&this._markTimelineRecords.push(a)}else this._markTimelineRecords.push(a)},setSidebarWidth:function(e){WebInspector.Panel.prototype.setSidebarWidth.call(this,e),this._sidebarBackgroundElement.style.width=e+"px",this._topPaneSidebarElement.style.width=e+"px"},updateMainViewWidth:function(e){this._containerContentElement.style.left=e+"px",this._scheduleRefresh(),this._overviewPane.updateMainViewWidth(e)},resize:function(){this._closeRecordDetails(),this._scheduleRefresh()},_createRootRecord:function(){var e={children:[],_visibleRecordsCount:0,_allRecordsCount:0,_aggregatedStats:{}};return e},_clearPanel:function(){this._markTimelineRecords=[],this._sendRequestRecords={},this._scheduledResourceRequests={},this._timerRecords={},this._rootRecord=this._createRootRecord(),this._boundariesAreValid=!1,this._overviewPane.reset(),this._adjustScrollPosition(0),this._refresh(),this._closeRecordDetails()},show:function(){WebInspector.Panel.prototype.show.call(this),"number"==typeof this._scrollTop&&(this._containerElement.scrollTop=this._scrollTop),this._refresh(),WebInspector.drawer.currentPanelCounters=this.recordsCounter},hide:function(){WebInspector.Panel.prototype.hide.call(this),this._closeRecordDetails(),WebInspector.drawer.currentPanelCounters=null},_onScroll:function(e){this._closeRecordDetails();var t=this._containerElement.scrollTop,i=Math.max(0,t);this._timelineGrid.setScrollAndDividerTop(t,i),this._scheduleRefresh(!0)},_windowChanged:function(){this._closeRecordDetails(),this._scheduleRefresh()},_scheduleRefresh:function(e){this._closeRecordDetails(),this._boundariesAreValid&=e,this.visible&&(e?this._refresh():this._refreshTimeout||(this._refreshTimeout=setTimeout(this._refresh.bind(this),100)))},_refresh:function(){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),delete this._refreshTimeout),this._overviewPane.update(this._rootRecord.children,this._calculator._showShortEvents),this._refreshRecords(!this._boundariesAreValid),this._updateRecordsCounter(),this._boundariesAreValid||this._updateEventDividers(),this._boundariesAreValid=!0},_updateBoundaries:function(){this._calculator.reset(),this._calculator.windowLeft=this._overviewPane.windowLeft,this._calculator.windowRight=this._overviewPane.windowRight;for(var e=0;e<this._rootRecord.children.length;++e)this._calculator.updateBoundaries(this._rootRecord.children[e]);this._calculator.calculateWindow()},_addToRecordsWindow:function(e,t,i){if(this._calculator._showShortEvents||e.isLong()){var n=this._calculator.computeBarGraphPercentages(e);n.start<100&&0<=n.endWithChildren&&!e.category.hidden&&(++this._rootRecord._visibleRecordsCount,++e.parent._invisibleChildrenCount,i||t.push(e));for(var s=t.length,r=e._invisibleChildrenCount=0;r<e.children.length;++r)this._addToRecordsWindow(e.children[r],t,i||e.collapsed);e._visibleChildrenCount=t.length-s}},_filterRecords:function(){for(var e=[],t=this._rootRecord._visibleRecordsCount=0;t<this._rootRecord.children.length;++t)this._addToRecordsWindow(this._rootRecord.children[t],e);return e},_refreshRecords:function(e){e&&this._updateBoundaries();var t=this._filterRecords();
// Calculate the visible area.
this._scrollTop=this._containerElement.scrollTop;var i=this._scrollTop,n=i+this._containerElement.clientHeight,s=WebInspector.TimelinePanel.rowHeight,r=Math.max(0,Math.min(Math.floor(i/s)-1,t.length-1)),a=Math.min(t.length,Math.ceil(n/s)),o=r*s+"px";this._topGapElement.style.height=o,this.sidebarElement.style.top=o,this.sidebarResizeElement.style.top=o,this._bottomGapElement.style.height=(t.length-a)*s+"px";
// Update visible rows.
var l=this._sidebarListElement.firstChild,d=this._graphRowsElement.offsetWidth;this._itemsGraphsElement.removeChild(this._graphRowsElement);var c=this._graphRowsElement.firstChild,h=this._scheduleRefresh.bind(this,!0);this._itemsGraphsElement.removeChild(this._expandElements),this._expandElements.removeChildren();for(var p=0;p<a;++p){var m=t[p],u=!(p%2);if(p<r){var _=p+m._visibleChildrenCount;if(r<=_&&_<a)new WebInspector.TimelineExpandableElement(this._expandElements)._update(m,p,this._calculator.computeBarGraphWindowPosition(m,d-this._expandOffset))}else l||(l=(new WebInspector.TimelineRecordListRow).element,this._sidebarListElement.appendChild(l)),c||(c=new WebInspector.TimelineRecordGraphRow(this._itemsGraphsElement,h,s).element,this._graphRowsElement.appendChild(c)),l.row.update(m,u,this._calculator,i),c.row.update(m,u,this._calculator,d,this._expandOffset,p),l=l.nextSibling,c=c.nextSibling}
// Remove extra rows.
for(;l;){var g=l.nextSibling;l.row.dispose(),l=g}for(;c;){g=c.nextSibling;c.row.dispose(),c=g}this._itemsGraphsElement.insertBefore(this._graphRowsElement,this._bottomGapElement),this._itemsGraphsElement.appendChild(this._expandElements),this.sidebarResizeElement.style.height=this.sidebarElement.clientHeight+"px";
// Reserve some room for expand / collapse controls to the left for records that start at 0ms.
var b=0===this._calculator.windowLeft?this._expandOffset:0;e&&this._timelineGrid.updateDividers(!0,this._calculator,b),this._adjustScrollPosition((t.length+1)*s)},_adjustScrollPosition:function(e){
// Prevent the container from being scrolled off the end.
this._containerElement.scrollTop+this._containerElement.offsetHeight>e+1&&(this._containerElement.scrollTop=e-this._containerElement.offsetHeight)},_getPopoverAnchor:function(e){return e.enclosingNodeOrSelfWithClass("timeline-graph-bar")||e.enclosingNodeOrSelfWithClass("timeline-tree-item")},_showPopover:function(e){var t=e.row._record,i=new WebInspector.Popover(t._generatePopupContent(this._calculator,this.categories));return i.show(e),i},_closeRecordDetails:function(){this._popoverHelper.hidePopup()}},WebInspector.TimelinePanel.prototype.__proto__=WebInspector.Panel.prototype,WebInspector.TimelineDispatcher=function(e){this._timelinePanel=e},WebInspector.TimelineDispatcher.prototype={timelineProfilerWasStarted:function(){this._timelinePanel._timelineProfilerWasStarted()},timelineProfilerWasStopped:function(){this._timelinePanel._timelineProfilerWasStopped()},addRecordToTimeline:function(e){this._timelinePanel._addRecordToTimeline(e)}},WebInspector.TimelineCategory=function(e,t,i){this.name=e,this.title=t,this.color=i},WebInspector.TimelineCalculator=function(){this.reset(),this.windowLeft=0,this.windowRight=1},WebInspector.TimelineCalculator.prototype={computeBarGraphPercentages:function(e){return{start:(e.startTime-this.minimumBoundary)/this.boundarySpan*100,end:(e.startTime+e._selfTime-this.minimumBoundary)/this.boundarySpan*100,endWithChildren:(e._lastChildEndTime-this.minimumBoundary)/this.boundarySpan*100,cpuWidth:e._cpuTime/this.boundarySpan*100}},computeBarGraphWindowPosition:function(e,t){var i=t-5-4,n=this.computeBarGraphPercentages(e),s=n.start/100*i,r=(n.end-n.start)/100*i+5,a=(n.endWithChildren-n.start)/100*i,o=n.cpuWidth/100*i+5;return n.endWithChildren>n.end&&(a+=9),{left:s,width:r,widthWithChildren:a,cpuWidth:o}},calculateWindow:function(){this.minimumBoundary=this._absoluteMinimumBoundary+this.windowLeft*(this._absoluteMaximumBoundary-this._absoluteMinimumBoundary),this.maximumBoundary=this._absoluteMinimumBoundary+this.windowRight*(this._absoluteMaximumBoundary-this._absoluteMinimumBoundary),this.boundarySpan=this.maximumBoundary-this.minimumBoundary},reset:function(){this._absoluteMinimumBoundary=-1,this._absoluteMaximumBoundary=-1},updateBoundaries:function(e){var t=e.startTime;(-1===this._absoluteMinimumBoundary||t<this._absoluteMinimumBoundary)&&(this._absoluteMinimumBoundary=t);var i=Math.max(e._lastChildEndTime+.01,t+.1);(-1===this._absoluteMaximumBoundary||i>this._absoluteMaximumBoundary)&&(this._absoluteMaximumBoundary=i)},formatValue:function(e){return Number.secondsToString(e+this.minimumBoundary-this._absoluteMinimumBoundary)}},WebInspector.TimelineRecordListRow=function(){this.element=document.createElement("div"),(this.element.row=this).element.style.cursor="pointer";var e=document.createElement("span");e.className="timeline-tree-icon",this.element.appendChild(e),this._typeElement=document.createElement("span"),this._typeElement.className="type",this.element.appendChild(this._typeElement);var t=document.createElement("span");t.className="separator",t.textContent=" ",this._dataElement=document.createElement("span"),this._dataElement.className="data dimmed",this.element.appendChild(t),this.element.appendChild(this._dataElement)},WebInspector.TimelineRecordListRow.prototype={update:function(e,t,i,n){if(this._record=e,this._calculator=i,this._offset=n,this.element.className="timeline-tree-item timeline-category-"+e.category.name+(t?" even":""),this._typeElement.textContent=e.title,this._dataElement.firstChild&&this._dataElement.removeChildren(),e.details){var s=document.createElement("span");"object"==typeof e.details?(s.appendChild(document.createTextNode("(")),s.appendChild(e.details),s.appendChild(document.createTextNode(")"))):s.textContent="("+e.details+")",this._dataElement.appendChild(s)}},dispose:function(){this.element.parentElement.removeChild(this.element)}},WebInspector.TimelineRecordGraphRow=function(e,t){this.element=document.createElement("div"),(this.element.row=this)._barAreaElement=document.createElement("div"),this._barAreaElement.className="timeline-graph-bar-area",this.element.appendChild(this._barAreaElement),this._barWithChildrenElement=document.createElement("div"),this._barWithChildrenElement.className="timeline-graph-bar with-children",(this._barWithChildrenElement.row=this)._barAreaElement.appendChild(this._barWithChildrenElement),this._barCpuElement=document.createElement("div"),this._barCpuElement.className="timeline-graph-bar cpu",(this._barCpuElement.row=this)._barAreaElement.appendChild(this._barCpuElement),this._barElement=document.createElement("div"),this._barElement.className="timeline-graph-bar",(this._barElement.row=this)._barAreaElement.appendChild(this._barElement),this._expandElement=new WebInspector.TimelineExpandableElement(e),this._expandElement._element.addEventListener("click",this._onClick.bind(this)),this._scheduleRefresh=t},WebInspector.TimelineRecordGraphRow.prototype={update:function(e,t,i,n,s,r){this._record=e,this.element.className="timeline-graph-side timeline-category-"+e.category.name+(t?" even":"");var a=i.computeBarGraphWindowPosition(e,n-s);this._barWithChildrenElement.style.left=a.left+s+"px",this._barWithChildrenElement.style.width=a.widthWithChildren+"px",this._barElement.style.left=a.left+s+"px",this._barElement.style.width=a.width+"px",this._barCpuElement.style.left=a.left+s+"px",this._barCpuElement.style.width=a.cpuWidth+"px",this._expandElement._update(e,r,a)},_onClick:function(e){this._record.collapsed=!this._record.collapsed,this._scheduleRefresh()},dispose:function(){this.element.parentElement.removeChild(this.element),this._expandElement._dispose()}},WebInspector.TimelinePanel.FormattedRecord=function(e,t,i){var n=WebInspector.TimelineAgent.RecordType,s=i._recordStyles[e.type];
// Make resource receive record last since request was sent; make finish record last since response received.
if((this.parent=t)&&t.children.push(this),this.category=s.category,this.title=s.title,this.startTime=e.startTime/1e3,this.data=e.data,this.type=e.type,this.endTime=void 0!==e.endTime?e.endTime/1e3:this.startTime,this._selfTime=this.endTime-this.startTime,this._lastChildEndTime=this.endTime,(this.originalRecordForTests=e).stackTrace&&e.stackTrace.length&&(this.stackTrace=e.stackTrace),this.totalHeapSize=e.totalHeapSize,this.usedHeapSize=e.usedHeapSize,e.type===n.ResourceSendRequest)i._sendRequestRecords[e.data.identifier]=this;else if(e.type===n.ScheduleResourceRequest)i._scheduledResourceRequests[e.data.url]=this;else if(e.type===n.ResourceReceiveResponse){(r=i._sendRequestRecords[e.data.identifier])&&(// False if we started instrumentation in the middle of request.
e.data.url=r.data.url,
// Now that we have resource in the collection, recalculate details in order to display short url.
r.details=this._getRecordDetails(r,i._sendRequestRecords),r.parent!==i._rootRecord&&r.parent.type===n.ScheduleResourceRequest&&(r.parent.details=this._getRecordDetails(r,i._sendRequestRecords)))}else if(e.type===n.ResourceReceiveData){(r=i._sendRequestRecords[e.data.identifier])&&(// False for main resource.
e.data.url=r.data.url)}else if(e.type===n.ResourceFinish){var r;(r=i._sendRequestRecords[e.data.identifier])&&(// False for main resource.
e.data.url=r.data.url)}else if(e.type===n.TimerInstall)this.timeout=e.data.timeout,this.singleShot=e.data.singleShot,i._timerRecords[e.data.timerId]=this;else if(e.type===n.TimerFire){var a=i._timerRecords[e.data.timerId];a&&(this.callSiteStackTrace=a.stackTrace,this.timeout=a.timeout,this.singleShot=a.singleShot)}this.details=this._getRecordDetails(e,i._sendRequestRecords)},WebInspector.TimelinePanel.FormattedRecord.prototype={isLong:function(){return this._lastChildEndTime-this.startTime>WebInspector.TimelinePanel.shortRecordThreshold},get children(){return this._children||(this._children=[]),this._children},_generateAggregatedInfo:function(){var e=document.createElement("span");for(var t in e.className="timeline-aggregated-info",this._aggregatedStats){var i=document.createElement("div");i.className="timeline-aggregated-category timeline-"+t,e.appendChild(i);var n=document.createElement("span");n.textContent=Number.secondsToString(this._aggregatedStats[t]+1e-4),e.appendChild(n)}return e},_generatePopupContent:function(e,t){var i=new WebInspector.TimelinePanel.PopupContentHelper(this.title);this._children&&this._children.length&&(i._appendTextRow(WebInspector.UIString("Self Time"),Number.secondsToString(this._selfTime+1e-4)),i._appendElementRow(WebInspector.UIString("Aggregated Time"),this._generateAggregatedInfo()));var n=WebInspector.UIString("%s (at %s)",Number.secondsToString(this._lastChildEndTime-this.startTime),e.formatValue(this.startTime-e.minimumBoundary));i._appendTextRow(WebInspector.UIString("Duration"),n);var s=WebInspector.TimelineAgent.RecordType;switch(this.type){case s.GCEvent:i._appendTextRow(WebInspector.UIString("Collected"),Number.bytesToString(this.data.usedHeapSizeDelta));break;case s.TimerInstall:case s.TimerFire:case s.TimerRemove:i._appendTextRow(WebInspector.UIString("Timer ID"),this.data.timerId),"number"==typeof this.timeout&&(i._appendTextRow(WebInspector.UIString("Timeout"),Number.secondsToString(this.timeout/1e3)),i._appendTextRow(WebInspector.UIString("Repeats"),!this.singleShot));break;case s.FunctionCall:i._appendLinkRow(WebInspector.UIString("Location"),this.data.scriptName,this.data.scriptLine);break;case s.ScheduleResourceRequest:case s.ResourceSendRequest:case s.ResourceReceiveResponse:case s.ResourceReceiveData:case s.ResourceFinish:i._appendLinkRow(WebInspector.UIString("Resource"),this.data.url),this.data.requestMethod&&i._appendTextRow(WebInspector.UIString("Request Method"),this.data.requestMethod),"number"==typeof this.data.statusCode&&i._appendTextRow(WebInspector.UIString("Status Code"),this.data.statusCode),this.data.mimeType&&i._appendTextRow(WebInspector.UIString("MIME Type"),this.data.mimeType),"number"==typeof this.data.expectedContentLength&&-1!==this.data.expectedContentLength&&i._appendTextRow(WebInspector.UIString("Expected Content Length"),this.data.expectedContentLength);break;case s.EvaluateScript:this.data&&this.data.url&&i._appendLinkRow(WebInspector.UIString("Script"),this.data.url,this.data.lineNumber);break;case s.Paint:i._appendTextRow(WebInspector.UIString("Location"),WebInspector.UIString("(%d, %d)",this.data.x,this.data.y)),i._appendTextRow(WebInspector.UIString("Dimensions"),WebInspector.UIString("%d × %d",this.data.width,this.data.height));case s.RecalculateStyles:// We don't want to see default details.
break;default:this.details&&i._appendTextRow(WebInspector.UIString("Details"),this.details)}return this.data.scriptName&&this.type!==s.FunctionCall&&i._appendLinkRow(WebInspector.UIString("Function Call"),this.data.scriptName,this.data.scriptLine),this.usedHeapSize&&i._appendTextRow(WebInspector.UIString("Used Heap Size"),WebInspector.UIString("%s of %s",Number.bytesToString(this.usedHeapSize),Number.bytesToString(this.totalHeapSize))),this.callSiteStackTrace&&this.callSiteStackTrace.length&&i._appendStackTrace(WebInspector.UIString("Call Site stack"),this.callSiteStackTrace),this.stackTrace&&i._appendStackTrace(WebInspector.UIString("Call Stack"),this.stackTrace),i._contentTable},_getRecordDetails:function(e,t){switch(e.type){case WebInspector.TimelineAgent.RecordType.GCEvent:return WebInspector.UIString("%s collected",Number.bytesToString(e.data.usedHeapSizeDelta));case WebInspector.TimelineAgent.RecordType.TimerFire:return e.data.scriptName?WebInspector.linkifyResourceAsNode(e.data.scriptName,"scripts",e.data.scriptLine,"",""):e.data.timerId;case WebInspector.TimelineAgent.RecordType.FunctionCall:return e.data.scriptName?WebInspector.linkifyResourceAsNode(e.data.scriptName,"scripts",e.data.scriptLine,"",""):null;case WebInspector.TimelineAgent.RecordType.EventDispatch:return e.data?e.data.type:null;case WebInspector.TimelineAgent.RecordType.Paint:return e.data.width+" × "+e.data.height;case WebInspector.TimelineAgent.RecordType.TimerInstall:case WebInspector.TimelineAgent.RecordType.TimerRemove:return this.stackTrace?WebInspector.linkifyResourceAsNode(this.stackTrace[0].scriptName,"scripts",this.stackTrace[0].lineNumber,"",""):e.data.timerId;case WebInspector.TimelineAgent.RecordType.ParseHTML:case WebInspector.TimelineAgent.RecordType.RecalculateStyles:return this.stackTrace?WebInspector.linkifyResourceAsNode(this.stackTrace[0].scriptName,"scripts",this.stackTrace[0].lineNumber,"",""):null;case WebInspector.TimelineAgent.RecordType.EvaluateScript:return e.data.url?WebInspector.linkifyResourceAsNode(e.data.url,"scripts",e.data.lineNumber,"",""):null;case WebInspector.TimelineAgent.RecordType.XHRReadyStateChange:case WebInspector.TimelineAgent.RecordType.XHRLoad:case WebInspector.TimelineAgent.RecordType.ScheduleResourceRequest:case WebInspector.TimelineAgent.RecordType.ResourceSendRequest:case WebInspector.TimelineAgent.RecordType.ResourceReceiveData:case WebInspector.TimelineAgent.RecordType.ResourceReceiveResponse:case WebInspector.TimelineAgent.RecordType.ResourceFinish:return WebInspector.displayNameForURL(e.data.url);case WebInspector.TimelineAgent.RecordType.MarkTimeline:return e.data.message;default:return null}},_calculateAggregatedStats:function(e){for(var t in this._aggregatedStats={},e)this._aggregatedStats[t]=0;if(this._cpuTime=this._selfTime,this._children){for(var i=this._children.length;i;--i){var n=this._children[i-1];for(var t in this._aggregatedStats[n.category.name]+=n._selfTime,e)this._aggregatedStats[t]+=n._aggregatedStats[t]}for(var t in this._aggregatedStats)this._cpuTime+=this._aggregatedStats[t]}}},WebInspector.TimelinePanel.PopupContentHelper=function(e){this._contentTable=document.createElement("table");var t=this._createCell(WebInspector.UIString("%s - Details",e),"timeline-details-title");t.colSpan=2;var i=document.createElement("tr");i.appendChild(t),this._contentTable.appendChild(i)},WebInspector.TimelinePanel.PopupContentHelper.prototype={_createCell:function(e,t){document.createElement("label").appendChild(document.createTextNode(e));var i=document.createElement("td");return i.className="timeline-details",t&&(i.className+=" "+t),i.textContent=e,i},_appendTextRow:function(e,t){var i=document.createElement("tr");i.appendChild(this._createCell(e,"timeline-details-row-title")),i.appendChild(this._createCell(t,"timeline-details-row-data")),this._contentTable.appendChild(i)},_appendElementRow:function(e,t,i){var n=document.createElement("tr"),s=this._createCell(e,"timeline-details-row-title");i&&s.addStyleClass(i),n.appendChild(s);var r=document.createElement("td");r.className="timeline-details",r.appendChild(t),n.appendChild(r),this._contentTable.appendChild(n)},_appendLinkRow:function(e,t,i){var n=WebInspector.linkifyResourceAsNode(t,"scripts",i,"timeline-details");this._appendElementRow(e,n)},_appendStackTrace:function(e,t){this._appendTextRow("","");for(var i=document.createElement("table"),n=0;n<t.length;++n){var s=t[n],r=document.createElement("tr");r.className="timeline-details",r.appendChild(this._createCell(s.functionName?s.functionName:WebInspector.UIString("(anonymous function)"),"timeline-function-name")),r.appendChild(this._createCell(" @ "));var a=document.createElement("td");a.appendChild(WebInspector.linkifyResourceAsNode(s.scriptName,"scripts",s.lineNumber,"timeline-details")),r.appendChild(a),i.appendChild(r)}this._appendElementRow(e,i,"timeline-stacktrace-title")}},WebInspector.TimelineExpandableElement=function(e){this._element=document.createElement("div"),this._element.className="timeline-expandable";var t=document.createElement("div");t.className="timeline-expandable-left",this._element.appendChild(t),e.appendChild(this._element)},WebInspector.TimelineExpandableElement.prototype={_update:function(e,t,i){var n=WebInspector.TimelinePanel.rowHeight;e._visibleChildrenCount||e._invisibleChildrenCount?(this._element.style.top=t*n+"px",this._element.style.left=i.left+"px",this._element.style.width=Math.max(12,i.width+25)+"px",e.collapsed?(this._element.style.height=n+"px",this._element.addStyleClass("timeline-expandable-collapsed"),this._element.removeStyleClass("timeline-expandable-expanded")):(this._element.style.height=(e._visibleChildrenCount+1)*n+"px",this._element.addStyleClass("timeline-expandable-expanded"),this._element.removeStyleClass("timeline-expandable-collapsed")),this._element.removeStyleClass("hidden")):this._element.addStyleClass("hidden")},_dispose:function(){this._element.parentElement.removeChild(this._element)}};