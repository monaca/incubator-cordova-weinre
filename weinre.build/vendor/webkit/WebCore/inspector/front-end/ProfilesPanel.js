/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
var UserInitiatedProfileName="org.webkit.profiles.user-initiated";WebInspector.ProfileType=function(e,t){this._id=e,this._name=t},WebInspector.ProfileType.URLRegExp=/webkit-profile:\/\/(.+)\/(.+)#([0-9]+)/,WebInspector.ProfileType.prototype={get buttonTooltip(){return""},get buttonStyle(){},get buttonCaption(){return this.name},get id(){return this._id},get name(){return this._name},buttonClicked:function(){},viewForProfile:function(e){return e._profileView||(e._profileView=this.createView(e)),e._profileView},get welcomeMessage(){return""},
// Must be implemented by subclasses.
createView:function(e){throw new Error("Needs implemented.")},
// Must be implemented by subclasses.
createSidebarTreeElementForProfile:function(e){throw new Error("Needs implemented.")}},WebInspector.ProfilesPanel=function(){WebInspector.Panel.call(this,"profiles"),this.createSidebar(),this._profileTypesByIdMap={},this._profileTypeButtonsByIdMap={};var e=WebInspector.UIString("You need to enable profiling before you can use the Profiles panel."),t=WebInspector.UIString("Enabling profiling will make scripts run slower."),i=WebInspector.UIString("Enable Profiling");this.panelEnablerView=new WebInspector.PanelEnablerView("profiles",e,t,i),this.panelEnablerView.addEventListener("enable clicked",this._enableProfiling,this),this.element.appendChild(this.panelEnablerView.element),this.profileViews=document.createElement("div"),this.profileViews.id="profile-views",this.element.appendChild(this.profileViews),this.enableToggleButton=new WebInspector.StatusBarButton("","enable-toggle-status-bar-item"),this.enableToggleButton.addEventListener("click",this._toggleProfiling.bind(this),!1),this.clearResultsButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear all profiles."),"clear-status-bar-item"),this.clearResultsButton.addEventListener("click",this._clearProfiles.bind(this),!1),this.profileViewStatusBarItemsContainer=document.createElement("div"),this.profileViewStatusBarItemsContainer.className="status-bar-items",this.welcomeView=new WebInspector.WelcomeView("profiles",WebInspector.UIString("Welcome to the Profiles panel")),this.element.appendChild(this.welcomeView.element),this._profiles=[],this._profilerEnabled=Preferences.profilerAlwaysEnabled,this._reset(),InspectorBackend.registerDomainDispatcher("Profiler",new WebInspector.ProfilerDispatcher(this))},WebInspector.ProfilesPanel.prototype={get toolbarItemLabel(){return WebInspector.UIString("Profiles")},get statusBarItems(){function e(e,t){e.buttonClicked.call(e),this.updateProfileTypeButtons()}var t=[this.enableToggleButton.element];
// FIXME: Generate a single "combo-button".
for(var i in this._profileTypesByIdMap){var r=this.getProfileType(i);if(r.buttonStyle){var s=new WebInspector.StatusBarButton(r.buttonTooltip,r.buttonStyle,r.buttonCaption);this._profileTypeButtonsByIdMap[i]=s.element,s.element.addEventListener("click",e.bind(this,r,s.element),!1),t.push(s.element)}}return t.push(this.clearResultsButton.element,this.profileViewStatusBarItemsContainer),t},show:function(){WebInspector.Panel.prototype.show.call(this),this._populateProfiles()},_profilerWasEnabled:function(){this._profilerEnabled||(this._profilerEnabled=!0,this._reset(),this.visible&&this._populateProfiles())},_profilerWasDisabled:function(){this._profilerEnabled&&(this._profilerEnabled=!1,this._reset())},_reset:function(){for(var e=0;e<this._profiles.length;++e)delete this._profiles[e]._profileView;for(var t in delete this.visibleView,delete this.currentQuery,this.searchCanceled(),this._profiles=[],this._profilesIdMap={},this._profileGroups={},this._profileGroupsForLinks={},this._profilesWereRequested=!1,this.sidebarTreeElement.removeStyleClass("some-expandable"),this._profileTypesByIdMap)this.getProfileType(t).treeElement.removeChildren();this.profileViews.removeChildren(),this.profileViewStatusBarItemsContainer.removeChildren(),this.removeAllListeners(),this._updateInterface(),this.welcomeView.show()},_clearProfiles:function(){InspectorBackend.clearProfiles(),this._reset()},registerProfileType:function(e){(this._profileTypesByIdMap[e.id]=e).treeElement=new WebInspector.SidebarSectionTreeElement(e.name,null,!0),this.sidebarTree.appendChild(e.treeElement),e.treeElement.expand(),this._addWelcomeMessage(e)},_addWelcomeMessage:function(e){var t=e.welcomeMessage,i=t.indexOf("%s");
// Message text is supposed to have a '%s' substring as a placeholder
// for a status bar button. If it is there, we split the message in two
// parts, and insert the button between them.
if(-1<i){var r=document.createDocumentFragment(),s=document.createElement("span");s.innerHTML=t.substr(0,i),r.appendChild(s);var o=new WebInspector.StatusBarButton(e.buttonTooltip,e.buttonStyle,e.buttonCaption);r.appendChild(o.element);var l=document.createElement("span");l.innerHTML=t.substr(i+2),r.appendChild(l),this.welcomeView.addMessage(r)}else this.welcomeView.addMessage(t)},_makeKey:function(e,t){return escape(e)+"/"+escape(t)},_addProfileHeader:function(e){this.hasTemporaryProfile(e.typeId)&&(e.typeId===WebInspector.CPUProfileType.TypeId?this._removeProfileHeader(this._temporaryRecordingProfile):this._removeProfileHeader(this._temporaryTakingSnapshot));var t,i=e.typeId,r=this.getProfileType(i),s=r.treeElement,o=!1;if(e.__profilesPanelProfileType=r,this._profiles.push(e),0!==(this._profilesIdMap[this._makeKey(e.uid,i)]=e).title.indexOf(UserInitiatedProfileName)){var l=this._makeKey(e.title,i);l in this._profileGroups||(this._profileGroups[l]=[]);var n=this._profileGroups[l];if(n.push(e),2===n.length){
// Make a group TreeElement now that there are 2 profiles.
n._profilesTreeElement=new WebInspector.ProfileGroupSidebarTreeElement(e.title);
// Insert at the same index for the first profile of the group.
var a=s.children.indexOf(n[0]._profilesTreeElement);s.insertChild(n._profilesTreeElement,a);
// Move the first profile to the group.
var p=n[0]._profilesTreeElement.selected;s.removeChild(n[0]._profilesTreeElement),n._profilesTreeElement.appendChild(n[0]._profilesTreeElement),p&&(n[0]._profilesTreeElement.select(),n[0]._profilesTreeElement.reveal()),n[0]._profilesTreeElement.small=!0,n[0]._profilesTreeElement.mainTitle=WebInspector.UIString("Run %d",1),this.sidebarTreeElement.addStyleClass("some-expandable")}2<=n.length&&(s=n._profilesTreeElement,t=WebInspector.UIString("Run %d",n.length),o=!0)}var h=r.createSidebarTreeElementForProfile(e);(e.sideBarElement=h).small=o,t&&(h.mainTitle=t),e._profilesTreeElement=h,s.appendChild(h),e.isTemporary||(this.welcomeView.hide(),this.visibleView||this.showProfile(e),this.dispatchEventToListeners("profile added"))},_removeProfileHeader:function(e){for(var t=e.typeId,i=this.getProfileType(t).treeElement,r=0;r<this._profiles.length;++r)if(this._profiles[r].uid===e.uid){e=this._profiles[r],this._profiles.splice(r,1);break}delete this._profilesIdMap[this._makeKey(e.uid,t)];var s=this._makeKey(e.title,t);delete this._profileGroups[s],i.removeChild(e._profilesTreeElement),e.isTemporary||InspectorBackend.removeProfile(e.typeId,e.uid),
// No other item will be selected if there aren't any other profiles, so
// make sure that view gets cleared when the last profile is removed.
this._profiles.length||this.closeVisibleView()},showProfile:function(e){if(e&&!e.isTemporary){this.closeVisibleView();var t=e.__profilesPanelProfileType.viewForProfile(e);t.show(this.profileViews),e._profilesTreeElement.select(!0),e._profilesTreeElement.reveal(),this.visibleView=t,this.profileViewStatusBarItemsContainer.removeChildren();var i=t.statusBarItems;if(i)for(var r=0;r<i.length;++r)this.profileViewStatusBarItemsContainer.appendChild(i[r])}},getProfiles:function(e){for(var t=[],i=this._profiles.length,r=0;r<i;++r){var s=this._profiles[r];s.isTemporary||s.typeId!==e||t.push(s)}return t},hasTemporaryProfile:function(e){for(var t=this._profiles.length,i=0;i<t;++i)if(this._profiles[i].typeId===e&&this._profiles[i].isTemporary)return!0;return!1},hasProfile:function(e){return!!this._profilesIdMap[this._makeKey(e.uid,e.typeId)]},loadHeapSnapshot:function(e,t){var i=this._profilesIdMap[this._makeKey(e,WebInspector.HeapSnapshotProfileType.TypeId)];i&&(i._loaded?t(i):i._is_loading?i._callbacks.push(t):(i._is_loading=!0,i._callbacks=[t],i._json="",i.sideBarElement.subtitle=WebInspector.UIString("Loadingâ€¦"),InspectorBackend.getProfile(i.typeId,i.uid)))},_addHeapSnapshotChunk:function(e,t){var i=this._profilesIdMap[this._makeKey(e,WebInspector.HeapSnapshotProfileType.TypeId)];i&&!i._loaded&&i._is_loading&&(i._json+=t)},_finishHeapSnapshot:function(e){var i=this._profilesIdMap[this._makeKey(e,WebInspector.HeapSnapshotProfileType.TypeId)];if(i&&!i._loaded&&i._is_loading){var r=i._callbacks;delete i._callbacks,i.sideBarElement.subtitle=WebInspector.UIString("Parsingâ€¦"),window.setTimeout(function(){var e=JSON.parse(i._json);delete i._json,delete i._is_loading,i._loaded=!0,i.sideBarElement.subtitle="",Preferences.detailedHeapProfiles?WebInspector.DetailedHeapshotView.prototype.processLoadedSnapshot(i,e):WebInspector.HeapSnapshotView.prototype.processLoadedSnapshot(i,e);for(var t=0;t<r.length;++t)r[t](i)},0)}},showView:function(e){this.showProfile(e.profile)},getProfileType:function(e){return this._profileTypesByIdMap[e]},showProfileForURL:function(e){var t=e.match(WebInspector.ProfileType.URLRegExp);t&&this.showProfile(this._profilesIdMap[this._makeKey(t[3],t[1])])},updateProfileTypeButtons:function(){for(var e in this._profileTypeButtonsByIdMap){var t=this._profileTypeButtonsByIdMap[e],i=this.getProfileType(e);t.className=i.buttonStyle,t.title=i.buttonTooltip}},closeVisibleView:function(){this.visibleView&&this.visibleView.hide(),delete this.visibleView},displayTitleForProfileLink:function(e,t){if(0===(e=unescape(e)).indexOf(UserInitiatedProfileName))e=WebInspector.UIString("Profile %d",e.substring(UserInitiatedProfileName.length+1));else{var i=this._makeKey(e,t);i in this._profileGroupsForLinks||(this._profileGroupsForLinks[i]=0);var r=++this._profileGroupsForLinks[i];2<r&&(
// The title is used in the console message announcing that a profile has started so it gets
// incremented twice as often as it's displayed
e+=" "+WebInspector.UIString("Run %d",(r+1)/2))}return e},get searchableViews(){var e=[],t=this.visibleView;t&&t.performSearch&&e.push(t);for(var i=this._profiles.length,r=0;r<i;++r){var s=this._profiles[r],o=s.__profilesPanelProfileType.viewForProfile(s);o.performSearch&&o!==t&&e.push(o)}return e},searchMatchFound:function(e,t){e.profile._profilesTreeElement.searchMatches=t},searchCanceled:function(e){if(WebInspector.Panel.prototype.searchCanceled.call(this,e),this._profiles)for(var t=0;t<this._profiles.length;++t){this._profiles[t]._profilesTreeElement.searchMatches=0}},_updateInterface:function(){
// FIXME: Replace ProfileType-specific button visibility changes by a single ProfileType-agnostic "combo-button" visibility change.
if(this._profilerEnabled){for(var e in this.enableToggleButton.title=WebInspector.UIString("Profiling enabled. Click to disable."),this.enableToggleButton.toggled=!0,this._profileTypeButtonsByIdMap)this._profileTypeButtonsByIdMap[e].removeStyleClass("hidden");this.profileViewStatusBarItemsContainer.removeStyleClass("hidden"),this.clearResultsButton.element.removeStyleClass("hidden"),this.panelEnablerView.visible=!1}else{for(var e in this.enableToggleButton.title=WebInspector.UIString("Profiling disabled. Click to enable."),this.enableToggleButton.toggled=!1,this._profileTypeButtonsByIdMap)this._profileTypeButtonsByIdMap[e].addStyleClass("hidden");this.profileViewStatusBarItemsContainer.addStyleClass("hidden"),this.clearResultsButton.element.addStyleClass("hidden"),this.panelEnablerView.visible=!0}},_enableProfiling:function(){this._profilerEnabled||this._toggleProfiling(this.panelEnablerView.alwaysEnabled)},_toggleProfiling:function(e){this._profilerEnabled?(WebInspector.settings.profilerEnabled=!1,InspectorBackend.disableProfiler(!0)):(WebInspector.settings.profilerEnabled=!!e,InspectorBackend.enableProfiler())},_populateProfiles:function(){this._profilerEnabled&&!this._profilesWereRequested&&(InspectorBackend.getProfileHeaders(function(e){e.sort(function(e,t){return e.uid-t.uid});for(var t=e.length,i=0;i<t;++i)this.hasProfile(e[i])||this._addProfileHeader(e[i])}.bind(this)),this._profilesWereRequested=!0)},updateMainViewWidth:function(e){this.welcomeView.element.style.left=e+"px",this.profileViews.style.left=e+"px",this.profileViewStatusBarItemsContainer.style.left=Math.max(155,e)+"px",this.resize()},_setRecordingProfile:function(e){this.getProfileType(WebInspector.CPUProfileType.TypeId).setRecordingProfile(e),this.hasTemporaryProfile(WebInspector.CPUProfileType.TypeId)!==e&&(this._temporaryRecordingProfile||(this._temporaryRecordingProfile={typeId:WebInspector.CPUProfileType.TypeId,title:WebInspector.UIString("Recordingâ€¦"),uid:-1,isTemporary:!0}),e?this._addProfileHeader(this._temporaryRecordingProfile):this._removeProfileHeader(this._temporaryRecordingProfile)),this.updateProfileTypeButtons()},takeHeapSnapshot:function(e){this.hasTemporaryProfile(WebInspector.HeapSnapshotProfileType.TypeId)||(this._temporaryTakingSnapshot||(this._temporaryTakingSnapshot={typeId:WebInspector.HeapSnapshotProfileType.TypeId,title:WebInspector.UIString("Snapshottingâ€¦"),uid:-1,isTemporary:!0}),this._addProfileHeader(this._temporaryTakingSnapshot)),InspectorBackend.takeHeapSnapshot(e)},_reportHeapSnapshotProgress:function(e,t){this.hasTemporaryProfile(WebInspector.HeapSnapshotProfileType.TypeId)&&(this._temporaryTakingSnapshot.sideBarElement.subtitle=WebInspector.UIString("%.2f%%",e/t*100),t<=e&&this._removeProfileHeader(this._temporaryTakingSnapshot))}},WebInspector.ProfilesPanel.prototype.__proto__=WebInspector.Panel.prototype,WebInspector.ProfilerDispatcher=function(e){this._profiler=e},WebInspector.ProfilerDispatcher.prototype={profilerWasEnabled:function(){this._profiler._profilerWasEnabled()},profilerWasDisabled:function(){this._profiler._profilerWasDisabled()},resetProfiles:function(){this._profiler._reset()},addProfileHeader:function(e){this._profiler._addProfileHeader(e)},addHeapSnapshotChunk:function(e,t){this._profiler._addHeapSnapshotChunk(e,t)},finishHeapSnapshot:function(e){this._profiler._finishHeapSnapshot(e)},setRecordingProfile:function(e){this._profiler._setRecordingProfile(e)},reportHeapSnapshotProgress:function(e,t){this._profiler._reportHeapSnapshotProgress(e,t)}},WebInspector.ProfileSidebarTreeElement=function(e,t,i){this.profile=e,this._titleFormat=t,0===this.profile.title.indexOf(UserInitiatedProfileName)&&(this._profileNumber=this.profile.title.substring(UserInitiatedProfileName.length+1)),WebInspector.SidebarTreeElement.call(this,i,"","",e,!1),this.refreshTitles()},WebInspector.ProfileSidebarTreeElement.prototype={onselect:function(){this.treeOutline.panel.showProfile(this.profile)},ondelete:function(){return this.treeOutline.panel._removeProfileHeader(this.profile),!0},get mainTitle(){return this._mainTitle?this._mainTitle:0===this.profile.title.indexOf(UserInitiatedProfileName)?WebInspector.UIString(this._titleFormat,this._profileNumber):this.profile.title},set mainTitle(e){this._mainTitle=e,this.refreshTitles()},set searchMatches(e){if(!e){if(!this.bubbleElement)return;return this.bubbleElement.removeStyleClass("search-matches"),void(this.bubbleText="")}this.bubbleText=e,this.bubbleElement.addStyleClass("search-matches")}},WebInspector.ProfileSidebarTreeElement.prototype.__proto__=WebInspector.SidebarTreeElement.prototype,WebInspector.ProfileGroupSidebarTreeElement=function(e,t){WebInspector.SidebarTreeElement.call(this,"profile-group-sidebar-tree-item",e,t,null,!0)},WebInspector.ProfileGroupSidebarTreeElement.prototype={onselect:function(){0<this.children.length&&WebInspector.panels.profiles.showProfile(this.children[this.children.length-1].profile)}},WebInspector.ProfileGroupSidebarTreeElement.prototype.__proto__=WebInspector.SidebarTreeElement.prototype;