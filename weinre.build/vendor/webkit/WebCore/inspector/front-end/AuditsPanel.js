/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.AuditsPanel=function(){for(id in WebInspector.Panel.call(this,"audits"),this.createSidebar(),this.auditsTreeElement=new WebInspector.SidebarSectionTreeElement("",{},!0),this.sidebarTree.appendChild(this.auditsTreeElement),this.auditsTreeElement.listItemElement.addStyleClass("hidden"),this.auditsTreeElement.expand(),this.auditsItemTreeElement=new WebInspector.AuditsSidebarTreeElement,this.auditsTreeElement.appendChild(this.auditsItemTreeElement),this.auditResultsTreeElement=new WebInspector.SidebarSectionTreeElement(WebInspector.UIString("RESULTS"),{},!0),this.sidebarTree.appendChild(this.auditResultsTreeElement),this.auditResultsTreeElement.expand(),this.clearResultsButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear audit results."),"clear-status-bar-item"),this.clearResultsButton.addEventListener("click",this._clearButtonClicked.bind(this),!1),this.viewsContainerElement=document.createElement("div"),this.viewsContainerElement.id="audit-views",this.element.appendChild(this.viewsContainerElement),this._constructCategories(),this._launcherView=new WebInspector.AuditLauncherView(this.initiateAudit.bind(this)),this.categoriesById)this._launcherView.addCategory(this.categoriesById[id])},WebInspector.AuditsPanel.prototype={get toolbarItemLabel(){return WebInspector.UIString("Audits")},get statusBarItems(){return[this.clearResultsButton.element]},get mainResourceLoadTime(){return this._mainResourceLoadTime},set mainResourceLoadTime(e){this._mainResourceLoadTime=e,this._didMainResourceLoad()},get mainResourceDOMContentTime(){return this._mainResourceDOMContentTime},set mainResourceDOMContentTime(e){this._mainResourceDOMContentTime=e},get categoriesById(){return this._auditCategoriesById},addCategory:function(e){this.categoriesById[e.id]=e,this._launcherView.addCategory(e)},getCategory:function(e){return this.categoriesById[e]},_constructCategories:function(){for(var e in this._auditCategoriesById={},WebInspector.AuditCategories){var t=new WebInspector.AuditCategories[e];t._id=e,this.categoriesById[e]=t}},_executeAudit:function(e,i){for(var t=WebInspector.networkResources,s=0,n=0;n<e.length;++n)s+=e[n].ruleCount;var r=[],a=WebInspector.mainResource.url;function u(e,t){t&&t.children&&e.addRuleResult(t),!--s&&i&&i(a,r)}if(s)for(n=0;n<e.length;++n){var o=e[n],l=new WebInspector.AuditCategoryResult(o);r.push(l),o.run(t,u.bind(null,l))}else i(a,r)},_auditFinishedCallback:function(e,t,i){for(var s=this.auditResultsTreeElement.children,n=1,r=0;r<s.length;++r)s[r].mainResourceURL===t&&n++;var a=new WebInspector.AuditResultSidebarTreeElement(i,t,n);this.auditResultsTreeElement.appendChild(a),a.reveal(),a.select(),e&&e()},initiateAudit:function(e,t,i){if(e&&e.length){for(var s=[],n=0;n<e.length;++n)s.push(this.categoriesById[e[n]]);t?r.call(this,s,i):this._reloadResources(r.bind(this,s,i))}function r(e,t){this._executeAudit(e,this._auditFinishedCallback.bind(this,t))}},_reloadResources:function(e){this._pageReloadCallback=e,InspectorBackend.reloadPage(!1)},_didMainResourceLoad:function(){if(this._pageReloadCallback){var e=this._pageReloadCallback;delete this._pageReloadCallback,e()}},showResults:function(e){e._resultView||(e._resultView=new WebInspector.AuditResultView(e)),this.visibleView=e._resultView},showLauncherView:function(){this.visibleView=this._launcherView},get visibleView(){return this._visibleView},set visibleView(e){this._visibleView!==e&&(this._visibleView&&this._visibleView.hide(),(this._visibleView=e)&&e.show(this.viewsContainerElement))},attach:function(){WebInspector.Panel.prototype.attach.call(this),this.auditsItemTreeElement.select()},updateMainViewWidth:function(e){this.viewsContainerElement.style.left=e+"px"},_clearButtonClicked:function(){this.auditsItemTreeElement.reveal(),this.auditsItemTreeElement.select(),this.auditResultsTreeElement.removeChildren()}},WebInspector.AuditsPanel.prototype.__proto__=WebInspector.Panel.prototype,WebInspector.AuditCategory=function(e){this._displayName=e,this._rules=[]},WebInspector.AuditCategory.prototype={get id(){
// this._id value is injected at construction time.
return this._id},get displayName(){return this._displayName},get ruleCount(){return this._ensureInitialized(),this._rules.length},addRule:function(e,t){e.severity=t,this._rules.push(e)},run:function(e,t){this._ensureInitialized();for(var i=0;i<this._rules.length;++i)this._rules[i].run(e,t)},_ensureInitialized:function(){this._initialized||("initialize"in this&&this.initialize(),this._initialized=!0)}},WebInspector.AuditRule=function(e,t){this._id=e,this._displayName=t},WebInspector.AuditRule.Severity={Info:"info",Warning:"warning",Severe:"severe"},WebInspector.AuditRule.SeverityOrder={info:3,warning:2,severe:1},WebInspector.AuditRule.prototype={get id(){return this._id},get displayName(){return this._displayName},set severity(e){this._severity=e},run:function(e,t){var i=new WebInspector.AuditRuleResult(this.displayName);i.severity=this._severity,this.doRun(e,i,t)},doRun:function(e,t,i){throw new Error("doRun() not implemented")}},WebInspector.AuditCategoryResult=function(e){this.title=e.displayName,this.ruleResults=[]},WebInspector.AuditCategoryResult.prototype={addRuleResult:function(e){this.ruleResults.push(e)}},WebInspector.AuditRuleResult=function(e,t,i){this.value=e,this.className=i,this.expanded=t,this.violationCount=0},WebInspector.AuditRuleResult.linkifyDisplayName=function(e){return WebInspector.linkifyURL(e,WebInspector.displayNameForURL(e))},WebInspector.AuditRuleResult.resourceDomain=function(e){return e||WebInspector.UIString("[empty domain]")},WebInspector.AuditRuleResult.prototype={addChild:function(e,t,i){this.children||(this.children=[]);var s=new WebInspector.AuditRuleResult(e,t,i);return this.children.push(s),s},addURL:function(e){return this.addChild(WebInspector.AuditRuleResult.linkifyDisplayName(e))},addURLs:function(e){for(var t=0;t<e.length;++t)this.addURL(e[t])},addSnippet:function(e){return this.addChild(e,!1,"source-code")}},WebInspector.AuditsSidebarTreeElement=function(){this.small=!1,WebInspector.SidebarTreeElement.call(this,"audits-sidebar-tree-item",WebInspector.UIString("Audits"),"",null,!1)},WebInspector.AuditsSidebarTreeElement.prototype={onattach:function(){WebInspector.SidebarTreeElement.prototype.onattach.call(this)},onselect:function(){WebInspector.panels.audits.showLauncherView()},get selectable(){return!0},refresh:function(){this.refreshTitles()}},WebInspector.AuditsSidebarTreeElement.prototype.__proto__=WebInspector.SidebarTreeElement.prototype,WebInspector.AuditResultSidebarTreeElement=function(e,t,i){this.results=e,this.mainResourceURL=t,WebInspector.SidebarTreeElement.call(this,"audit-result-sidebar-tree-item",String.sprintf("%s (%d)",t,i),"",{},!1)},WebInspector.AuditResultSidebarTreeElement.prototype={onselect:function(){WebInspector.panels.audits.showResults(this.results)},get selectable(){return!0}},WebInspector.AuditResultSidebarTreeElement.prototype.__proto__=WebInspector.SidebarTreeElement.prototype,
// Contributed audit rules should go into this namespace.
WebInspector.AuditRules={},
// Contributed audit categories should go into this namespace.
WebInspector.AuditCategories={};