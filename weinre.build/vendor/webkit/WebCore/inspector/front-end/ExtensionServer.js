/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.ExtensionServer=function(){this._clientObjects={},this._handlers={},this._subscribers={},this._extraHeaders={},this._status=new WebInspector.ExtensionStatus,this._registerHandler("addRequestHeaders",this._onAddRequestHeaders.bind(this)),this._registerHandler("addAuditCategory",this._onAddAuditCategory.bind(this)),this._registerHandler("addAuditResult",this._onAddAuditResult.bind(this)),this._registerHandler("createPanel",this._onCreatePanel.bind(this)),this._registerHandler("createSidebarPane",this._onCreateSidebar.bind(this)),this._registerHandler("createWatchExpressionSidebarPane",this._onCreateWatchExpressionSidebarPane.bind(this)),this._registerHandler("evaluateOnInspectedPage",this._onEvaluateOnInspectedPage.bind(this)),this._registerHandler("getHAR",this._onGetHAR.bind(this)),this._registerHandler("getResourceContent",this._onGetResourceContent.bind(this)),this._registerHandler("log",this._onLog.bind(this)),this._registerHandler("reload",this._onReload.bind(this)),this._registerHandler("setSidebarHeight",this._onSetSidebarHeight.bind(this)),this._registerHandler("setWatchSidebarContent",this._onSetWatchSidebarContent.bind(this)),this._registerHandler("stopAuditCategoryRun",this._onStopAuditCategoryRun.bind(this)),this._registerHandler("subscribe",this._onSubscribe.bind(this)),this._registerHandler("unsubscribe",this._onUnsubscribe.bind(this)),window.addEventListener("message",this._onWindowMessage.bind(this),!1)},WebInspector.ExtensionServer.prototype={notifyPanelShown:function(e){this._postNotification("panel-shown-"+e)},notifyObjectSelected:function(e,t){this._postNotification("panel-objectSelected-"+e,t)},notifySearchAction:function(e,t,n){this._postNotification("panel-search-"+e,t,n)},notifyPageLoaded:function(e){this._postNotification("inspectedPageLoaded",e)},notifyPageDOMContentLoaded:function(e){this._postNotification("inspectedPageDOMContentLoaded",e)},notifyInspectedURLChanged:function(){this._postNotification("inspectedURLChanged")},notifyInspectorReset:function(){this._postNotification("reset")},notifyExtensionWatchSidebarUpdated:function(e){this._postNotification("watch-sidebar-updated-"+e)},startAuditRun:function(e,t){this._clientObjects[t.id]=t,this._postNotification("audit-started-"+e.id,t.id)},stopAuditRun:function(e){delete this._clientObjects[e.id]},_notifyResourceFinished:function(e){var t=e.data;this._postNotification("resource-finished",t.identifier,new WebInspector.HAREntry(t).build())},_postNotification:function(e,t){var n=this._subscribers[e];if(n)for(var s={command:"notify-"+e,arguments:Array.prototype.slice.call(arguments,1)},i=0;i<n.length;++i)n[i].postMessage(s)},_onSubscribe:function(e,t){var n=this._subscribers[e.type];n?n.push(t):this._subscribers[e.type]=[t]},_onUnsubscribe:function(e,t){var n=this._subscribers[e.type];n&&(n.remove(t),n.length||delete this._subscribers[e.type])},_onAddRequestHeaders:function(e){var t=e.extensionId;if("string"!=typeof t)return this._status.E_BADARGTYPE("extensionId",typeof t,"string");var n=this._extraHeaders[t];for(name in n||(n={},this._extraHeaders[t]=n),e.headers)n[name]=e.headers[name];var s={};for(extension in this._extraHeaders){var i=this._extraHeaders[extension];for(name in i)"string"==typeof i[name]&&(s[name]=i[name])}InspectorBackend.setExtraHeaders(s)},_onCreatePanel:function(e,t){var n=e.id;
// The ids are generated on the client API side and must be unique, so the check below
// shouldn't be hit unless someone is bypassing the API.
if(n in this._clientObjects||n in WebInspector.panels)return this._status.E_EXISTS(n);var s=new WebInspector.ExtensionPanel(n,e.title,e.icon);this._clientObjects[n]=s;var i=document.getElementById("toolbar"),r=WebInspector.panelOrder[WebInspector.panelOrder.length-1].toolbarItem;return WebInspector.addPanelToolbarIcon(i,s,r),WebInspector.panels[n]=s,this._createClientIframe(s.element,e.url).style.height="100%",this._status.OK()},_onCreateSidebar:function(e){var t=this._createSidebar(e,WebInspector.SidebarPane);return t.isError?t:(this._createClientIframe(t.bodyElement,e.url),this._status.OK())},_onCreateWatchExpressionSidebarPane:function(e){var t=this._createSidebar(e,WebInspector.ExtensionWatchSidebarPane);return t.isError?t:this._status.OK()},_createSidebar:function(e,t){var n=WebInspector.panels[e.panel];if(!n)return this._status.E_NOTFOUND(e.panel);if(!n.sidebarElement||!n.sidebarPanes)return this._status.E_NOTSUPPORTED();var s=e.id,i=new t(e.title,e.id);return this._clientObjects[s]=i,n.sidebarPanes[s]=i,n.sidebarElement.appendChild(i.element),i},_createClientIframe:function(e,t,n,s){var i=document.createElement("iframe");return i.src=t,i.style.width="100%",e.appendChild(i),i},_onSetSidebarHeight:function(e){var t=this._clientObjects[e.id];if(!t)return this._status.E_NOTFOUND(e.id);t.bodyElement.firstChild.style.height=e.height},_onSetWatchSidebarContent:function(e){var t=this._clientObjects[e.id];if(!t)return this._status.E_NOTFOUND(e.id);e.evaluateOnPage?t.setExpression(e.expression,e.rootTitle):t.setObject(e.expression,e.rootTitle)},_onLog:function(e){WebInspector.log(e.message)},_onReload:function(e){return"string"==typeof e.userAgent&&InspectorBackend.setUserAgentOverride(e.userAgent),InspectorBackend.reloadPage(!1),this._status.OK()},_onEvaluateOnInspectedPage:function(s,i){var e="JSON.stringify(eval(unescape('"+escape(s.expression)+"')));";InspectorBackend.evaluate(e,"none",!0,function(e){var t=WebInspector.RemoteObject.fromPayload(e),n={};t.isError()&&(n.isException=!0),n.value=t.description,this._dispatchCallback(s.requestId,i,n)}.bind(this))},_onRevealAndSelect:function(e){return"resources"===e.panelId&&"resource"===type?this._onRevealAndSelectResource(e):this._status.E_NOTSUPPORTED(e.panelId,e.type)},_onRevealAndSelectResource:function(e){var t,n=e.id;if(!(t=WebInspector.networkResourceById(n)||WebInspector.resourceForURL(n)))return this._status.E_NOTFOUND(typeof n+": "+n);WebInspector.panels.resources.showResource(t,e.line),WebInspector.showPanel("resources")},_dispatchCallback:function(e,t,n){t.postMessage({command:"callback",requestId:e,result:n})},_onGetHAR:function(e){var t=new WebInspector.HARLog;return t.includeResourceIds=!0,t.build()},_onGetResourceContent:function(s,i){var e=WebInspector.networkResourceById(s.id);if(!e)return this._status.E_NOTFOUND(s.id);e.requestContent(function(e,t){var n={encoding:t?"base64":"",content:e};this._dispatchCallback(s.requestId,i,n)}.bind(this))},_onAddAuditCategory:function(e){var t=new WebInspector.ExtensionAuditCategory(e.id,e.displayName,e.resultCount);if(WebInspector.panels.audits.getCategory(t.id))return this._status.E_EXISTS(t.id);this._clientObjects[e.id]=t,WebInspector.panels.audits.addCategory(t)},_onAddAuditResult:function(e){var t=this._clientObjects[e.resultId];if(!t)return this._status.E_NOTFOUND(e.resultId);try{t.addResult(e.displayName,e.description,e.severity,e.details)}catch(e){return e}return this._status.OK()},_onStopAuditCategoryRun:function(e){var t=this._clientObjects[e.resultId];if(!t)return this._status.E_NOTFOUND(e.resultId);t.cancel()},initExtensions:function(){
// The networkManager is normally created after the ExtensionServer is constructed, but before initExtensions() is called.
WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.ResourceFinished,this._notifyResourceFinished,this),InspectorExtensionRegistry.getExtensionsAsync()},_addExtensions:function(e){
// See ExtensionAPI.js and ExtensionCommon.js for details.
InspectorFrontendHost.setExtensionAPI(this._buildExtensionAPIInjectedScript());for(var t=0;t<e.length;++t){var n=e[t];try{if(!n.startPage)return;var s=document.createElement("iframe");s.src=n.startPage,s.style.display="none",document.body.appendChild(s)}catch(e){console.error("Failed to initialize extension "+n.startPage+":"+e)}}},_buildExtensionAPIInjectedScript:function(){for(var e={},t=Object.getOwnPropertyNames(WebInspector.Resource.Type),n=0;n<t.length;++n){var s=t[n],i=WebInspector.Resource.Type[s];"number"==typeof i&&(e[s]=WebInspector.Resource.Type.toString(i))}var r=WebInspector.buildPlatformExtensionAPI?WebInspector.buildPlatformExtensionAPI():"";return"(function(){ var apiPrivate = {};("+WebInspector.commonExtensionSymbols.toString()+")(apiPrivate);("+WebInspector.injectedExtensionAPI.toString()+").apply(this, arguments);"+r+"})"},_onWindowMessage:function(e){if("registerExtension"===e.data){var t=e.ports[0];t.addEventListener("message",this._onmessage.bind(this),!1),t.start()}},_onmessage:function(e){var t,n=e.data;(t=n.command in this._handlers?this._handlers[n.command](n,e.target):this._status.E_NOTSUPPORTED(n.command))&&n.requestId&&this._dispatchCallback(n.requestId,e.target,t)},_registerHandler:function(e,t){this._handlers[e]=t}},WebInspector.ExtensionServer._statuses={OK:"",E_EXISTS:"Object already exists: %s",E_BADARG:"Invalid argument %s: %s",E_BADARGTYPE:"Invalid type for argument %s: got %s, expected %s",E_NOTFOUND:"Object not found: %s",E_NOTSUPPORTED:"Object does not support requested operation: %s"},WebInspector.ExtensionStatus=function(){function e(e){var t=WebInspector.ExtensionServer._statuses[e]||e,n=Array.prototype.slice.call(arguments,1),s={code:e,description:t,details:n};return"OK"!==e&&(s.isError=!0,console.log("Extension server error: "+String.vsprintf(t,n))),s}for(status in WebInspector.ExtensionServer._statuses)this[status]=e.bind(null,status)},WebInspector.addExtensions=function(e){WebInspector.extensionServer._addExtensions(e)},WebInspector.extensionServer=new WebInspector.ExtensionServer;