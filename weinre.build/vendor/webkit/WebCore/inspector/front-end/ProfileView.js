/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
// FIXME: Rename the file.
WebInspector.CPUProfileView=function(e){WebInspector.View.call(this),this.element.addStyleClass("profile-view"),this.showSelfTimeAsPercent=!0,this.showTotalTimeAsPercent=!0,this.showAverageTimeAsPercent=!0;var t={self:{title:WebInspector.UIString("Self"),width:"72px",sort:"descending",sortable:!0},total:{title:WebInspector.UIString("Total"),width:"72px",sortable:!0},average:{title:WebInspector.UIString("Average"),width:"72px",sortable:!0},calls:{title:WebInspector.UIString("Calls"),width:"54px",sortable:!0},function:{title:WebInspector.UIString("Function"),disclosure:!0,sortable:!0}};Preferences.samplingCPUProfiler&&(delete t.average,delete t.calls),this.dataGrid=new WebInspector.DataGrid(t),this.dataGrid.addEventListener("sorting changed",this._sortData,this),this.dataGrid.element.addEventListener("mousedown",this._mouseDownInDataGrid.bind(this),!0),this.element.appendChild(this.dataGrid.element),this.viewSelectElement=document.createElement("select"),this.viewSelectElement.className="status-bar-item",this.viewSelectElement.addEventListener("change",this._changeView.bind(this),!1),this.view="Heavy";var r=document.createElement("option");r.label=WebInspector.UIString("Heavy (Bottom Up)");var s=document.createElement("option");s.label=WebInspector.UIString("Tree (Top Down)"),this.viewSelectElement.appendChild(r),this.viewSelectElement.appendChild(s),this.percentButton=new WebInspector.StatusBarButton("","percent-time-status-bar-item"),this.percentButton.addEventListener("click",this._percentClicked.bind(this),!1),this.focusButton=new WebInspector.StatusBarButton(WebInspector.UIString("Focus selected function."),"focus-profile-node-status-bar-item"),this.focusButton.disabled=!0,this.focusButton.addEventListener("click",this._focusClicked.bind(this),!1),this.excludeButton=new WebInspector.StatusBarButton(WebInspector.UIString("Exclude selected function."),"exclude-profile-node-status-bar-item"),this.excludeButton.disabled=!0,this.excludeButton.addEventListener("click",this._excludeClicked.bind(this),!1),this.resetButton=new WebInspector.StatusBarButton(WebInspector.UIString("Restore all functions."),"reset-profile-status-bar-item"),this.resetButton.visible=!1,this.resetButton.addEventListener("click",this._resetClicked.bind(this),!1),this.profile=e;var i=this;InspectorBackend.getProfile(this.profile.typeId,this.profile.uid,function(e){i.profile.head=e.head,i._assignParentsInProfile(),i.profileDataGridTree=i.bottomUpProfileDataGridTree,i.profileDataGridTree.sort(WebInspector.ProfileDataGridTree.propertyComparator("selfTime",!1)),i.refresh(),i._updatePercentButton()})},WebInspector.CPUProfileView.prototype={get statusBarItems(){return[this.viewSelectElement,this.percentButton.element,this.focusButton.element,this.excludeButton.element,this.resetButton.element]},get profile(){return this._profile},set profile(e){this._profile=e},get bottomUpProfileDataGridTree(){return this._bottomUpProfileDataGridTree||(this._bottomUpProfileDataGridTree=new WebInspector.BottomUpProfileDataGridTree(this,this.profile.head)),this._bottomUpProfileDataGridTree},get topDownProfileDataGridTree(){return this._topDownProfileDataGridTree||(this._topDownProfileDataGridTree=new WebInspector.TopDownProfileDataGridTree(this,this.profile.head)),this._topDownProfileDataGridTree},get currentTree(){return this._currentTree},set currentTree(e){this._currentTree=e,this.refresh()},get topDownTree(){return this._topDownTree||(this._topDownTree=WebInspector.TopDownTreeFactory.create(this.profile.head),this._sortProfile(this._topDownTree)),this._topDownTree},get bottomUpTree(){return this._bottomUpTree||(this._bottomUpTree=WebInspector.BottomUpTreeFactory.create(this.profile.head),this._sortProfile(this._bottomUpTree)),this._bottomUpTree},show:function(e){WebInspector.View.prototype.show.call(this,e),this.dataGrid.updateWidths()},hide:function(){WebInspector.View.prototype.hide.call(this),this._currentSearchResultIndex=-1},resize:function(){this.dataGrid&&this.dataGrid.updateWidths()},refresh:function(){var e=this.dataGrid.selectedNode?this.dataGrid.selectedNode.profileNode:null;this.dataGrid.removeChildren();for(var t=this.profileDataGridTree.children,r=t.length,s=0;s<r;++s)this.dataGrid.appendChild(t[s]);e&&(e.selected=!0)},refreshVisibleData:function(){for(var e=this.dataGrid.children[0];e;)e.refresh(),e=e.traverseNextNode(!1,null,!0)},refreshShowAsPercents:function(){this._updatePercentButton(),this.refreshVisibleData()},searchCanceled:function(){if(this._searchResults)for(var e=0;e<this._searchResults.length;++e){var t=this._searchResults[e].profileNode;delete t._searchMatchedSelfColumn,delete t._searchMatchedTotalColumn,delete t._searchMatchedCallsColumn,delete t._searchMatchedFunctionColumn,t.refresh()}delete this._searchFinishedCallback,this._currentSearchResultIndex=-1,this._searchResults=[]},performSearch:function(e,t){if(
// Call searchCanceled since it will reset everything we need before doing a new search.
this.searchCanceled(),(e=e.trim()).length){this._searchFinishedCallback=t;var r=0===e.indexOf(">"),s=0===e.indexOf("<"),i=0===e.indexOf("=")||(r||s)&&1===e.indexOf("="),n=e.lastIndexOf("%")===e.length-1,a=2<e.length&&e.lastIndexOf("ms")===e.length-2,o=!a&&e.lastIndexOf("s")===e.length-1,l=parseFloat(e);(r||s||i)&&(l=i&&(r||s)?parseFloat(e.substring(2)):parseFloat(e.substring(1)));var h=o?1e3*l:l;
// Make equalTo implicitly true if it wasn't specified there is no other operator.
isNaN(l)||r||s||(i=!0);for(var/*ProfileDataGridNode*/c,d=this.profileDataGridTree.children[0];d;)delete(c=d)._searchMatchedSelfColumn,delete c._searchMatchedTotalColumn,delete c._searchMatchedAverageColumn,delete c._searchMatchedCallsColumn,delete c._searchMatchedFunctionColumn,n?(s?(c.selfPercent<l&&(c._searchMatchedSelfColumn=!0),c.totalPercent<l&&(c._searchMatchedTotalColumn=!0),c.averagePercent<h&&(c._searchMatchedAverageColumn=!0)):r&&(c.selfPercent>l&&(c._searchMatchedSelfColumn=!0),c.totalPercent>l&&(c._searchMatchedTotalColumn=!0),c.averagePercent<h&&(c._searchMatchedAverageColumn=!0)),i&&(c.selfPercent==l&&(c._searchMatchedSelfColumn=!0),c.totalPercent==l&&(c._searchMatchedTotalColumn=!0),c.averagePercent<h&&(c._searchMatchedAverageColumn=!0))):a||o?(s?(c.selfTime<h&&(c._searchMatchedSelfColumn=!0),c.totalTime<h&&(c._searchMatchedTotalColumn=!0),c.averageTime<h&&(c._searchMatchedAverageColumn=!0)):r&&(c.selfTime>h&&(c._searchMatchedSelfColumn=!0),c.totalTime>h&&(c._searchMatchedTotalColumn=!0),c.averageTime>h&&(c._searchMatchedAverageColumn=!0)),i&&(c.selfTime==h&&(c._searchMatchedSelfColumn=!0),c.totalTime==h&&(c._searchMatchedTotalColumn=!0),c.averageTime==h&&(c._searchMatchedAverageColumn=!0))):(i&&c.numberOfCalls==l&&(c._searchMatchedCallsColumn=!0),r&&c.numberOfCalls>l&&(c._searchMatchedCallsColumn=!0),s&&c.numberOfCalls<l&&(c._searchMatchedCallsColumn=!0)),(c.functionName.hasSubstring(e,!0)||c.url.hasSubstring(e,!0))&&(c._searchMatchedFunctionColumn=!0),(c._searchMatchedSelfColumn||c._searchMatchedTotalColumn||c._searchMatchedAverageColumn||c._searchMatchedCallsColumn||c._searchMatchedFunctionColumn)&&(c.refresh(),1)&&this._searchResults.push({profileNode:d}),d=d.traverseNextNode(!1,null,!1);t(this,this._searchResults.length)}},jumpToFirstSearchResult:function(){this._searchResults&&this._searchResults.length&&(this._currentSearchResultIndex=0,this._jumpToSearchResult(this._currentSearchResultIndex))},jumpToLastSearchResult:function(){this._searchResults&&this._searchResults.length&&(this._currentSearchResultIndex=this._searchResults.length-1,this._jumpToSearchResult(this._currentSearchResultIndex))},jumpToNextSearchResult:function(){this._searchResults&&this._searchResults.length&&(++this._currentSearchResultIndex>=this._searchResults.length&&(this._currentSearchResultIndex=0),this._jumpToSearchResult(this._currentSearchResultIndex))},jumpToPreviousSearchResult:function(){this._searchResults&&this._searchResults.length&&(--this._currentSearchResultIndex<0&&(this._currentSearchResultIndex=this._searchResults.length-1),this._jumpToSearchResult(this._currentSearchResultIndex))},showingFirstSearchResult:function(){return 0===this._currentSearchResultIndex},showingLastSearchResult:function(){return this._searchResults&&this._currentSearchResultIndex===this._searchResults.length-1},_jumpToSearchResult:function(e){var t=this._searchResults[e];if(t){var r=t.profileNode;r.reveal(),r.select()}},_changeView:function(e){e&&this.profile&&(1==e.target.selectedIndex&&"Heavy"==this.view?(this.profileDataGridTree=this.topDownProfileDataGridTree,this._sortProfile(),this.view="Tree"):0==e.target.selectedIndex&&"Tree"==this.view&&(this.profileDataGridTree=this.bottomUpProfileDataGridTree,this._sortProfile(),this.view="Heavy"),this.currentQuery&&this._searchFinishedCallback&&this._searchResults&&(
// The current search needs to be performed again. First negate out previous match
// count by calling the search finished callback with a negative number of matches.
// Then perform the search again the with same query and callback.
this._searchFinishedCallback(this,-this._searchResults.length),this.performSearch(this.currentQuery,this._searchFinishedCallback)))},_percentClicked:function(e){var t=this.showSelfTimeAsPercent&&this.showTotalTimeAsPercent&&this.showAverageTimeAsPercent;this.showSelfTimeAsPercent=!t,this.showTotalTimeAsPercent=!t,this.showAverageTimeAsPercent=!t,this.refreshShowAsPercents()},_updatePercentButton:function(){this.showSelfTimeAsPercent&&this.showTotalTimeAsPercent&&this.showAverageTimeAsPercent?(this.percentButton.title=WebInspector.UIString("Show absolute total and self times."),this.percentButton.toggled=!0):(this.percentButton.title=WebInspector.UIString("Show total and self times as percentages."),this.percentButton.toggled=!1)},_focusClicked:function(e){this.dataGrid.selectedNode&&(this.resetButton.visible=!0,this.profileDataGridTree.focus(this.dataGrid.selectedNode),this.refresh(),this.refreshVisibleData())},_excludeClicked:function(e){var t=this.dataGrid.selectedNode;t&&(t.deselect(),this.resetButton.visible=!0,this.profileDataGridTree.exclude(t),this.refresh(),this.refreshVisibleData())},_resetClicked:function(e){this.resetButton.visible=!1,this.profileDataGridTree.restore(),this.refresh(),this.refreshVisibleData()},_dataGridNodeSelected:function(e){this.focusButton.disabled=!1,this.excludeButton.disabled=!1},_dataGridNodeDeselected:function(e){this.focusButton.disabled=!0,this.excludeButton.disabled=!0},_sortData:function(e){this._sortProfile(this.profile)},_sortProfile:function(){var e="ascending"===this.dataGrid.sortOrder,t={average:"averageTime",self:"selfTime",total:"totalTime",calls:"numberOfCalls",function:"functionName"}[this.dataGrid.sortColumnIdentifier];this.profileDataGridTree.sort(WebInspector.ProfileDataGridTree.propertyComparator(t,e)),this.refresh()},_mouseDownInDataGrid:function(e){if(!(e.detail<2)){var t=e.target.enclosingNodeOrSelfWithNodeName("td");t&&(t.hasStyleClass("total-column")||t.hasStyleClass("self-column")||t.hasStyleClass("average-column"))&&(t.hasStyleClass("total-column")?this.showTotalTimeAsPercent=!this.showTotalTimeAsPercent:t.hasStyleClass("self-column")?this.showSelfTimeAsPercent=!this.showSelfTimeAsPercent:t.hasStyleClass("average-column")&&(this.showAverageTimeAsPercent=!this.showAverageTimeAsPercent),this.refreshShowAsPercents(),e.preventDefault(),e.stopPropagation())}},_assignParentsInProfile:function(){var e=this.profile.head;e.parent=null,e.head=null;for(var t=[{parent:e,children:e.children}];0<t.length;)for(var r=t.shift(),s=r.parent,i=r.children,n=i.length,a=0;a<n;++a)i[a].head=e,i[a].parent=s,0<i[a].children.length&&t.push({parent:i[a],children:i[a].children})}},WebInspector.CPUProfileView.prototype.__proto__=WebInspector.View.prototype,WebInspector.CPUProfileType=function(){WebInspector.ProfileType.call(this,WebInspector.CPUProfileType.TypeId,WebInspector.UIString("CPU PROFILES")),this._recording=!1},WebInspector.CPUProfileType.TypeId="CPU",WebInspector.CPUProfileType.prototype={get buttonTooltip(){return this._recording?WebInspector.UIString("Stop profiling."):WebInspector.UIString("Start profiling.")},get buttonStyle(){return this._recording?"record-profile-status-bar-item status-bar-item toggled-on":"record-profile-status-bar-item status-bar-item"},buttonClicked:function(){this._recording=!this._recording,this._recording?InspectorBackend.startProfiling():InspectorBackend.stopProfiling()},get welcomeMessage(){return WebInspector.UIString("Control CPU profiling by pressing the %s button on the status bar.")},setRecordingProfile:function(e){this._recording=e},createSidebarTreeElementForProfile:function(e){return new WebInspector.ProfileSidebarTreeElement(e,WebInspector.UIString("Profile %d"),"profile-sidebar-tree-item")},createView:function(e){return new WebInspector.CPUProfileView(e)}},WebInspector.CPUProfileType.prototype.__proto__=WebInspector.ProfileType.prototype;