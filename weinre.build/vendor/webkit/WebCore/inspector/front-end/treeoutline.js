/*
 * Copyright (C) 2007 Apple Inc.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer. 
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution. 
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission. 
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
function TreeOutline(e){this.children=[],this.selectedTreeElement=null,this._childrenListNode=e,this._childrenListNode.removeChildren(),this._knownTreeElements=[],this._treeElementsExpandedState=[],this.expandTreeElementsWhenArrowing=!1,this.root=!0,this.hasChildren=!1,this.expanded=!0,this.selected=!1,(this.treeOutline=this)._childrenListNode.tabIndex=0,this._childrenListNode.addEventListener("keydown",this._treeKeyDown.bind(this),!0)}function TreeElement(e,t,i){this._title=e,this.representedObject=t||{},this.representedObject.__treeElementIdentifier?this.identifier=this.representedObject.__treeElementIdentifier:(this.identifier=TreeOutline._knownTreeElementNextIdentifier++,this.representedObject.__treeElementIdentifier=this.identifier),this._hidden=!1,this.expanded=!1,this.selected=!1,this.hasChildren=i,this.children=[],this.treeOutline=null,this.parent=null,this.previousSibling=null,this.nextSibling=null,this._listItemNode=null}TreeOutline._knownTreeElementNextIdentifier=1,TreeOutline._appendChild=function(e){if(!e)throw"child can't be undefined or null";var t=this.children[this.children.length-1];t?(t.nextSibling=e).previousSibling=t:(e.previousSibling=null,e.nextSibling=null),this.children.push(e),this.hasChildren=!0,e.parent=this,e.treeOutline=this.treeOutline,e.treeOutline._rememberTreeElement(e);for(var i=e.children[0];i;)i.treeOutline=this.treeOutline,i.treeOutline._rememberTreeElement(i),i=i.traverseNextTreeElement(!1,e,!0);e.hasChildren&&void 0!==e.treeOutline._treeElementsExpandedState[e.identifier]&&(e.expanded=e.treeOutline._treeElementsExpandedState[e.identifier]),this._childrenListNode||(this._childrenListNode=this.treeOutline._childrenListNode.ownerDocument.createElement("ol"),(this._childrenListNode.parentTreeElement=this)._childrenListNode.addStyleClass("children"),this.hidden&&this._childrenListNode.addStyleClass("hidden")),e._attach()},TreeOutline._insertChild=function(e,t){if(!e)throw"child can't be undefined or null";var i=0<t?this.children[t-1]:null;i?(i.nextSibling=e).previousSibling=i:e.previousSibling=null;var n=this.children[t];n?(n.previousSibling=e).nextSibling=n:e.nextSibling=null,this.children.splice(t,0,e),this.hasChildren=!0,e.parent=this,e.treeOutline=this.treeOutline,e.treeOutline._rememberTreeElement(e);for(var l=e.children[0];l;)l.treeOutline=this.treeOutline,l.treeOutline._rememberTreeElement(l),l=l.traverseNextTreeElement(!1,e,!0);e.hasChildren&&void 0!==e.treeOutline._treeElementsExpandedState[e.identifier]&&(e.expanded=e.treeOutline._treeElementsExpandedState[e.identifier]),this._childrenListNode||(this._childrenListNode=this.treeOutline._childrenListNode.ownerDocument.createElement("ol"),(this._childrenListNode.parentTreeElement=this)._childrenListNode.addStyleClass("children"),this.hidden&&this._childrenListNode.addStyleClass("hidden")),e._attach()},TreeOutline._removeChildAtIndex=function(e){if(e<0||e>=this.children.length)throw"childIndex out of range";var t=this.children[e];this.children.splice(e,1);var i=t.parent;t.deselect()&&(t.previousSibling?t.previousSibling.select():t.nextSibling?t.nextSibling.select():i.select()),t.previousSibling&&(t.previousSibling.nextSibling=t.nextSibling),t.nextSibling&&(t.nextSibling.previousSibling=t.previousSibling),t.treeOutline&&(t.treeOutline._forgetTreeElement(t),t.treeOutline._forgetChildrenRecursive(t)),t._detach(),t.treeOutline=null,t.parent=null,t.nextSibling=null,t.previousSibling=null},TreeOutline._removeChild=function(e){if(!e)throw"child can't be undefined or null";var t=this.children.indexOf(e);if(-1===t)throw"child not found in this node's children";TreeOutline._removeChildAtIndex.call(this,t)},TreeOutline._removeChildren=function(){for(var e=0;e<this.children.length;++e){var t=this.children[e];t.deselect(),t.treeOutline&&(t.treeOutline._forgetTreeElement(t),t.treeOutline._forgetChildrenRecursive(t)),t._detach(),t.treeOutline=null,t.parent=null,t.nextSibling=null,t.previousSibling=null}this.children=[]},TreeOutline._removeChildrenRecursive=function(){for(var e=this.children,t=this.children[0];t;)t.children.length&&(e=e.concat(t.children)),t=t.traverseNextTreeElement(!1,this,!0);for(var i=0;i<e.length;++i){(t=e[i]).deselect(),t.treeOutline&&t.treeOutline._forgetTreeElement(t),t._detach(),t.children=[],t.treeOutline=null,t.parent=null,t.nextSibling=null,t.previousSibling=null}this.children=[]},TreeOutline.prototype._rememberTreeElement=function(e){this._knownTreeElements[e.identifier]||(this._knownTreeElements[e.identifier]=[]);
// check if the element is already known
var t=this._knownTreeElements[e.identifier];-1===t.indexOf(e)&&
// add the element
t.push(e)},TreeOutline.prototype._forgetTreeElement=function(e){this._knownTreeElements[e.identifier]&&this._knownTreeElements[e.identifier].remove(e,!0)},TreeOutline.prototype._forgetChildrenRecursive=function(e){for(var t=e.children[0];t;)this._forgetTreeElement(t),t=t.traverseNextTreeElement(!1,this,!0)},TreeOutline.prototype.getCachedTreeElement=function(e){if(!e)return null;if("__treeElementIdentifier"in e){
// If this representedObject has a tree element identifier, and it is a known TreeElement
// in our tree we can just return that tree element.
var t=this._knownTreeElements[e.__treeElementIdentifier];if(t)for(var i=0;i<t.length;++i)if(t[i].representedObject===e)return t[i]}return null},TreeOutline.prototype.findTreeElement=function(e,t,i){if(!e)return null;var n,l=this.getCachedTreeElement(e);if(l)return l;
// The representedObject isn't known, so we start at the top of the tree and work down to find the first
// tree element that represents representedObject or one of its ancestors.
for(var r=!1,s=0;s<this.children.length;++s)if((n=this.children[s]).representedObject===e||t(n.representedObject,e)){r=!0;break}if(!r)return null;
// Make sure the item that we found is connected to the root of the tree.
// Build up a list of representedObject's ancestors that aren't already in our tree.
for(var d=[],h=e;h&&(d.unshift(h),h!==n.representedObject);)h=i(h);
// For each of those ancestors we populate them to fill in the tree.
for(s=0;s<d.length;++s)
// Make sure we don't call findTreeElement with the same representedObject
// again, to prevent infinite recursion.
d[s]!==e&&(
// FIXME: we could do something faster than findTreeElement since we will know the next
// ancestor exists in the tree.
n=this.findTreeElement(d[s],t,i))&&n.onpopulate&&n.onpopulate(n);return this.getCachedTreeElement(e)},TreeOutline.prototype.treeElementFromPoint=function(e,t){var i=this._childrenListNode.ownerDocument.elementFromPoint(e,t).enclosingNodeOrSelfWithNodeNameInArray(["ol","li"]);return i?i.parentTreeElement||i.treeElement:null},TreeOutline.prototype._treeKeyDown=function(e){if(e.target===this._childrenListNode&&this.selectedTreeElement&&!e.shiftKey&&!e.metaKey&&!e.ctrlKey){var t,i=!1;if("Up"!==e.keyIdentifier||e.altKey)if("Down"!==e.keyIdentifier||e.altKey)"Left"===e.keyIdentifier?this.selectedTreeElement.expanded?(e.altKey?this.selectedTreeElement.collapseRecursively():this.selectedTreeElement.collapse(),i=!0):this.selectedTreeElement.parent&&!this.selectedTreeElement.parent.root&&(i=!0,this.selectedTreeElement.parent.selectable?i=!!(t=this.selectedTreeElement.parent):this.selectedTreeElement.parent&&this.selectedTreeElement.parent.collapse()):"Right"===e.keyIdentifier?this.selectedTreeElement.revealed()?this.selectedTreeElement.hasChildren&&(i=!0,this.selectedTreeElement.expanded?i=!!(t=this.selectedTreeElement.children[0]):e.altKey?this.selectedTreeElement.expandRecursively():this.selectedTreeElement.expand()):(this.selectedTreeElement.reveal(),i=!0):e.keyCode===WebInspector.KeyboardShortcut.Keys.Backspace.code||e.keyCode===WebInspector.KeyboardShortcut.Keys.Delete.code?this.selectedTreeElement.ondelete&&(i=this.selectedTreeElement.ondelete()):isEnterKey(e)&&this.selectedTreeElement.onenter&&(i=this.selectedTreeElement.onenter());else{for(t=this.selectedTreeElement.traverseNextTreeElement(!0);t&&!t.selectable;)t=t.traverseNextTreeElement(!this.expandTreeElementsWhenArrowing);i=!!t}else{for(t=this.selectedTreeElement.traversePreviousTreeElement(!0);t&&!t.selectable;)t=t.traversePreviousTreeElement(!this.expandTreeElementsWhenArrowing);i=!!t}t&&(t.reveal(),t.select(!1,!0)),i&&(e.preventDefault(),e.stopPropagation())}},TreeOutline.prototype.expand=function(){
// this is the root, do nothing
},TreeOutline.prototype.collapse=function(){
// this is the root, do nothing
},TreeOutline.prototype.revealed=function(){return!0},TreeOutline.prototype.reveal=function(){
// this is the root, do nothing
},TreeOutline.prototype.select=function(){
// this is the root, do nothing
},TreeOutline.prototype.appendChild=TreeOutline._appendChild,TreeOutline.prototype.insertChild=TreeOutline._insertChild,TreeOutline.prototype.removeChild=TreeOutline._removeChild,TreeOutline.prototype.removeChildAtIndex=TreeOutline._removeChildAtIndex,TreeOutline.prototype.removeChildren=TreeOutline._removeChildren,TreeOutline.prototype.removeChildrenRecursive=TreeOutline._removeChildrenRecursive,TreeElement.prototype={selectable:!0,arrowToggleWidth:10,get listItemElement(){return this._listItemNode},get childrenListElement(){return this._childrenListNode},get title(){return this._title},set title(e){this._title=e,this._setListItemNodeContent()},get titleHTML(){return this._titleHTML},set titleHTML(e){this._titleHTML=e,this._setListItemNodeContent()},get tooltip(){return this._tooltip},set tooltip(e){this._tooltip=e,this._listItemNode&&(this._listItemNode.title=e||"")},get hasChildren(){return this._hasChildren},set hasChildren(e){this._hasChildren!==e&&(this._hasChildren=e,this._listItemNode&&(e?this._listItemNode.addStyleClass("parent"):(this._listItemNode.removeStyleClass("parent"),this.collapse())))},get hidden(){return this._hidden},set hidden(e){this._hidden!==e&&((this._hidden=e)?(this._listItemNode&&this._listItemNode.addStyleClass("hidden"),this._childrenListNode&&this._childrenListNode.addStyleClass("hidden")):(this._listItemNode&&this._listItemNode.removeStyleClass("hidden"),this._childrenListNode&&this._childrenListNode.removeStyleClass("hidden")))},get shouldRefreshChildren(){return this._shouldRefreshChildren},set shouldRefreshChildren(e){(this._shouldRefreshChildren=e)&&this.expanded&&this.expand()},_setListItemNodeContent:function(){this._listItemNode&&(this._titleHTML||this._title?"string"==typeof this._titleHTML?this._listItemNode.innerHTML=this._titleHTML:"string"==typeof this._title?this._listItemNode.textContent=this._title:(this._listItemNode.removeChildren(),this._title.parentNode&&this._title.parentNode.removeChild(this._title),this._listItemNode.appendChild(this._title)):this._listItemNode.removeChildren())}},TreeElement.prototype.appendChild=TreeOutline._appendChild,TreeElement.prototype.insertChild=TreeOutline._insertChild,TreeElement.prototype.removeChild=TreeOutline._removeChild,TreeElement.prototype.removeChildAtIndex=TreeOutline._removeChildAtIndex,TreeElement.prototype.removeChildren=TreeOutline._removeChildren,TreeElement.prototype.removeChildrenRecursive=TreeOutline._removeChildrenRecursive,TreeElement.prototype._attach=function(){this._listItemNode&&!this.parent._shouldRefreshChildren||(this._listItemNode&&this._listItemNode.parentNode&&this._listItemNode.parentNode.removeChild(this._listItemNode),this._listItemNode=this.treeOutline._childrenListNode.ownerDocument.createElement("li"),(this._listItemNode.treeElement=this)._setListItemNodeContent(),this._listItemNode.title=this._tooltip?this._tooltip:"",this.hidden&&this._listItemNode.addStyleClass("hidden"),this.hasChildren&&this._listItemNode.addStyleClass("parent"),this.expanded&&this._listItemNode.addStyleClass("expanded"),this.selected&&this._listItemNode.addStyleClass("selected"),this._listItemNode.addEventListener("mousedown",TreeElement.treeElementMouseDown,!1),this._listItemNode.addEventListener("click",TreeElement.treeElementToggled,!1),this._listItemNode.addEventListener("dblclick",TreeElement.treeElementDoubleClicked,!1),this.onattach&&this.onattach(this));var e=null;this.nextSibling&&this.nextSibling._listItemNode&&this.nextSibling._listItemNode.parentNode===this.parent._childrenListNode&&(e=this.nextSibling._listItemNode),this.parent._childrenListNode.insertBefore(this._listItemNode,e),this._childrenListNode&&this.parent._childrenListNode.insertBefore(this._childrenListNode,this._listItemNode.nextSibling),this.selected&&this.select(),this.expanded&&this.expand()},TreeElement.prototype._detach=function(){this._listItemNode&&this._listItemNode.parentNode&&this._listItemNode.parentNode.removeChild(this._listItemNode),this._childrenListNode&&this._childrenListNode.parentNode&&this._childrenListNode.parentNode.removeChild(this._childrenListNode)},TreeElement.treeElementMouseDown=function(e){var t=e.currentTarget;t&&t.treeElement&&t.treeElement.selectable&&(t.treeElement.isEventWithinDisclosureTriangle(e)||t.treeElement.selectOnMouseDown(e))},TreeElement.treeElementToggled=function(e){var t=e.currentTarget;t&&t.treeElement&&t.treeElement.isEventWithinDisclosureTriangle(e)&&(t.treeElement.expanded?e.altKey?t.treeElement.collapseRecursively():t.treeElement.collapse():e.altKey?t.treeElement.expandRecursively():t.treeElement.expand(),e.stopPropagation())},TreeElement.treeElementDoubleClicked=function(e){var t=e.currentTarget;t&&t.treeElement&&(t.treeElement.ondblclick?t.treeElement.ondblclick.call(t.treeElement,e):t.treeElement.hasChildren&&!t.treeElement.expanded&&t.treeElement.expand())},TreeElement.prototype.collapse=function(){this._listItemNode&&this._listItemNode.removeStyleClass("expanded"),this._childrenListNode&&this._childrenListNode.removeStyleClass("expanded"),this.expanded=!1,this.treeOutline&&(this.treeOutline._treeElementsExpandedState[this.identifier]=!0),this.oncollapse&&this.oncollapse(this)},TreeElement.prototype.collapseRecursively=function(){for(var e=this;e;)e.expanded&&e.collapse(),e=e.traverseNextTreeElement(!1,this,!0)},TreeElement.prototype.expand=function(){if(this.hasChildren&&(!this.expanded||this._shouldRefreshChildren||!this._childrenListNode)){if(this.treeOutline&&(!this._childrenListNode||this._shouldRefreshChildren)){this._childrenListNode&&this._childrenListNode.parentNode&&this._childrenListNode.parentNode.removeChild(this._childrenListNode),this._childrenListNode=this.treeOutline._childrenListNode.ownerDocument.createElement("ol"),(this._childrenListNode.parentTreeElement=this)._childrenListNode.addStyleClass("children"),this.hidden&&this._childrenListNode.addStyleClass("hidden"),this.onpopulate&&this.onpopulate(this);for(var e=0;e<this.children.length;++e)this.children[e]._attach();delete this._shouldRefreshChildren}this._listItemNode&&(this._listItemNode.addStyleClass("expanded"),this._childrenListNode&&this._childrenListNode.parentNode!=this._listItemNode.parentNode&&this.parent._childrenListNode.insertBefore(this._childrenListNode,this._listItemNode.nextSibling)),this._childrenListNode&&this._childrenListNode.addStyleClass("expanded"),this.expanded=!0,this.treeOutline&&(this.treeOutline._treeElementsExpandedState[this.identifier]=!0),this.onexpand&&this.onexpand(this)}},TreeElement.prototype.expandRecursively=function(e){var t=this,i={},n=0;for(
// The Inspector uses TreeOutlines to represents object properties, so recursive expansion
// in some case can be infinite, since JavaScript objects can hold circular references.
// So default to a recursion cap of 3 levels, since that gives fairly good results.
void 0!==e&&"null"!=typeof e||(e=3);t;)n<e&&t.expand(),t=t.traverseNextTreeElement(!1,this,e<=n,i),n+=i.depthChange},TreeElement.prototype.hasAncestor=function(e){if(!e)return!1;for(var t=this.parent;t;){if(e===t)return!0;t=t.parent}return!1},TreeElement.prototype.reveal=function(){for(var e=this.parent;e&&!e.root;)e.expanded||e.expand(),e=e.parent;this.onreveal&&this.onreveal(this)},TreeElement.prototype.revealed=function(){for(var e=this.parent;e&&!e.root;){if(!e.expanded)return!1;e=e.parent}return!0},TreeElement.prototype.selectOnMouseDown=function(e){this.select(!1,!0)},TreeElement.prototype.select=function(e,t){this.treeOutline&&this.selectable&&!this.selected&&(this.treeOutline.selectedTreeElement&&this.treeOutline.selectedTreeElement.deselect(),this.selected=!0,this.treeOutline._childrenListNode.focus(),
// Focusing on another node may detach "this" from tree.
this.treeOutline&&((this.treeOutline.selectedTreeElement=this)._listItemNode&&this._listItemNode.addStyleClass("selected"),this.onselect&&!e&&this.onselect(this,t)))},TreeElement.prototype.deselect=function(e){return!(!this.treeOutline||this.treeOutline.selectedTreeElement!==this||!this.selected)&&(this.selected=!1,this.treeOutline.selectedTreeElement=null,this._listItemNode&&this._listItemNode.removeStyleClass("selected"),this.ondeselect&&!e&&this.ondeselect(this),!0)},TreeElement.prototype.traverseNextTreeElement=function(e,t,i,n){!i&&this.hasChildren&&this.onpopulate&&this.onpopulate(this),n&&(n.depthChange=0);var l=e?this.revealed()?this.children[0]:null:this.children[0];if(l&&(!e||e&&this.expanded))return n&&(n.depthChange=1),l;if(this===t)return null;if(l=e?this.revealed()?this.nextSibling:null:this.nextSibling)return l;for(l=this;l&&!l.root&&!(e?l.revealed()&&l.nextSibling:l.nextSibling)&&l.parent!==t;)n&&(n.depthChange-=1),l=l.parent;return l?e?l.revealed()?l.nextSibling:null:l.nextSibling:null},TreeElement.prototype.traversePreviousTreeElement=function(e,t){var i=e?this.revealed()?this.previousSibling:null:this.previousSibling;for(!t&&i&&i.hasChildren&&i.onpopulate&&i.onpopulate(i);i&&(e?i.revealed()&&i.expanded&&i.children[i.children.length-1]:i.children[i.children.length-1]);)!t&&i.hasChildren&&i.onpopulate&&i.onpopulate(i),i=e?i.revealed()&&i.expanded?i.children[i.children.length-1]:null:i.children[i.children.length-1];return i||(!this.parent||this.parent.root?null:this.parent)},TreeElement.prototype.isEventWithinDisclosureTriangle=function(e){var t=this._listItemNode.totalOffsetLeft;return e.pageX>=t&&e.pageX<=t+this.arrowToggleWidth&&this.hasChildren};