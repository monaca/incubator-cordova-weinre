/*
 * Copyright (C) 2010 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.BreakpointManager=function(){this._stickyBreakpoints={};var e=WebInspector.settings.findSettingForAllProjects("nativeBreakpoints");for(var t in e)this._stickyBreakpoints[t]=this._validateBreakpoints(e[t]);this._breakpoints={},this._domBreakpointsRestored=!1,WebInspector.settings.addEventListener(WebInspector.Settings.Events.ProjectChanged,this._projectChanged,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.DebuggerPaused,this._debuggerPaused,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.DebuggerResumed,this._debuggerResumed,this)},WebInspector.BreakpointManager.BreakpointTypes={DOM:"DOM",EventListener:"EventListener",XHR:"XHR"},WebInspector.BreakpointManager.Events={DOMBreakpointAdded:"dom-breakpoint-added",EventListenerBreakpointAdded:"event-listener-breakpoint-added",XHRBreakpointAdded:"xhr-breakpoint-added",ProjectChanged:"project-changed"},WebInspector.BreakpointManager.prototype={createDOMBreakpoint:function(e,t){this._createDOMBreakpoint(e,t,!0,!1)},_createDOMBreakpoint:function(e,t,n,i){var r=WebInspector.domAgent.nodeForId(e);if(r){var o=this._createDOMBreakpointId(e,t);if(!(o in this._breakpoints)){var s=new WebInspector.DOMBreakpoint(r,t);this._setBreakpoint(o,s,n,i),n&&i&&s._enable(),s.view=new WebInspector.DOMBreakpointView(this,o,n,r,t),this.dispatchEventToListeners(WebInspector.BreakpointManager.Events.DOMBreakpointAdded,s.view)}}},createEventListenerBreakpoint:function(e){this._createEventListenerBreakpoint(e,!0,!1)},_createEventListenerBreakpoint:function(e,t,n){var i=this._createEventListenerBreakpointId(e);if(!(i in this._breakpoints)){var r=new WebInspector.EventListenerBreakpoint(e);this._setBreakpoint(i,r,t,n),r.view=new WebInspector.EventListenerBreakpointView(this,i,t,e),this.dispatchEventToListeners(WebInspector.BreakpointManager.Events.EventListenerBreakpointAdded,r.view)}},createXHRBreakpoint:function(e){this._createXHRBreakpoint(e,!0,!1)},_createXHRBreakpoint:function(e,t,n){var i=this._createXHRBreakpointId(e);if(!(i in this._breakpoints)){var r=new WebInspector.XHRBreakpoint(e);this._setBreakpoint(i,r,t,n),r.view=new WebInspector.XHRBreakpointView(this,i,t,e),this.dispatchEventToListeners(WebInspector.BreakpointManager.Events.XHRBreakpointAdded,r.view)}},_setBreakpoint:function(e,t,n,i){(this._breakpoints[e]=t).enabled=n,i||(n&&t._enable(),this._saveBreakpoints())},_setBreakpointEnabled:function(e,t){var n=this._breakpoints[e];n.enabled!==t&&(t?n._enable():n._disable(),n.enabled=t,this._saveBreakpoints())},_removeBreakpoint:function(e){var t=this._breakpoints[e];t.enabled&&t._disable(),delete this._breakpoints[e],this._saveBreakpoints()},breakpointViewForEventData:function(e){var t;if(e.breakpointType===WebInspector.BreakpointManager.BreakpointTypes.DOM)t=this._createDOMBreakpointId(e.nodeId,e.type);else if(e.breakpointType===WebInspector.BreakpointManager.BreakpointTypes.EventListener)t=this._createEventListenerBreakpointId(e.eventName);else{if(e.breakpointType!==WebInspector.BreakpointManager.BreakpointTypes.XHR)return;t=this._createXHRBreakpointId(e.breakpointURL)}var n=this._breakpoints[t];if(n)return n.view},_debuggerPaused:function(e){var t=e.data.eventType,n=e.data.eventData;if(t===WebInspector.DebuggerEventTypes.NativeBreakpoint){var i=this.breakpointViewForEventData(n);i&&(i.hit=!0,this._lastHitBreakpointView=i)}},_debuggerResumed:function(e){this._lastHitBreakpointView&&(this._lastHitBreakpointView.hit=!1,delete this._lastHitBreakpointView)},_projectChanged:function(e){this._breakpoints={},this._domBreakpointsRestored=!1,this.dispatchEventToListeners(WebInspector.BreakpointManager.Events.ProjectChanged);for(var t=this._stickyBreakpoints[WebInspector.settings.projectId]||[],n=0;n<t.length;++n){var i=t[n];i.type===WebInspector.BreakpointManager.BreakpointTypes.EventListener?this._createEventListenerBreakpoint(i.condition.eventName,i.enabled,!0):i.type===WebInspector.BreakpointManager.BreakpointTypes.XHR&&this._createXHRBreakpoint(i.condition.url,i.enabled,!0)}this._breakpointsPushedToFrontend||(InspectorBackend.setAllBrowserBreakpoints(this._stickyBreakpoints),this._breakpointsPushedToFrontend=!0)},restoreDOMBreakpoints:function(){function e(e,t){if(o[e]=t,!(s-=1)){for(var n=0;n<r.length;++n){var i=r[n];if(i.type===WebInspector.BreakpointManager.BreakpointTypes.DOM)(t=o[i.condition.path])&&this._createDOMBreakpoint(t,i.condition.type,i.enabled,!0)}this._domBreakpointsRestored=!0,this._saveBreakpoints()}}for(var r=this._stickyBreakpoints[WebInspector.settings.projectId]||[],o={},s=0,t=0;t<r.length;++t)if(r[t].type===WebInspector.BreakpointManager.BreakpointTypes.DOM){var n=r[t].condition.path;n in o||(o[n]=0,s+=1,InspectorBackend.pushNodeByPathToFrontend(n,e.bind(this,n)))}s||(this._domBreakpointsRestored=!0)},_saveBreakpoints:function(){var e=[];for(var t in this._breakpoints){var n=this._breakpoints[t],i=n._serializeToJSON();i.enabled=n.enabled,e.push(i)}if(!this._domBreakpointsRestored)for(var r=this._stickyBreakpoints[WebInspector.settings.projectId]||[],o=0;o<r.length;++o)r[o].type===WebInspector.BreakpointManager.BreakpointTypes.DOM&&e.push(r[o]);WebInspector.settings.nativeBreakpoints=e,this._stickyBreakpoints[WebInspector.settings.projectId]=e,InspectorBackend.setAllBrowserBreakpoints(this._stickyBreakpoints)},_validateBreakpoints:function(e){for(var t=[],n={},i=0;i<e.length;++i){var r=e[i];if("type"in r&&"enabled"in r&&"condition"in r){var o=r.type+":",s=r.condition;if(r.type===WebInspector.BreakpointManager.BreakpointTypes.DOM){if("string"!=typeof s.path||"number"!=typeof s.type)continue;o+=s.path+":"+s.type}else if(r.type===WebInspector.BreakpointManager.BreakpointTypes.EventListener){if("string"!=typeof s.eventName)continue;o+=s.eventName}else{if(r.type!==WebInspector.BreakpointManager.BreakpointTypes.XHR)continue;if("string"!=typeof s.url)continue;o+=s.url}o in n||(n[o]=!0,t.push(r))}}return t},_createDOMBreakpointId:function(e,t){return"dom:"+e+":"+t},_createEventListenerBreakpointId:function(e){return"eventListner:"+e},_createXHRBreakpointId:function(e){return"xhr:"+e}},WebInspector.BreakpointManager.prototype.__proto__=WebInspector.Object.prototype,WebInspector.DOMBreakpoint=function(e,t){this._nodeId=e.id,this._path=e.path(),this._type=t},WebInspector.DOMBreakpoint.prototype={_enable:function(){InspectorBackend.setDOMBreakpoint(this._nodeId,this._type)},_disable:function(){InspectorBackend.removeDOMBreakpoint(this._nodeId,this._type)},_serializeToJSON:function(){return{type:WebInspector.BreakpointManager.BreakpointTypes.DOM,condition:{path:this._path,type:this._type}}}},WebInspector.EventListenerBreakpoint=function(e){this._eventName=e},WebInspector.EventListenerBreakpoint.prototype={_enable:function(){InspectorBackend.setEventListenerBreakpoint(this._eventName)},_disable:function(){InspectorBackend.removeEventListenerBreakpoint(this._eventName)},_serializeToJSON:function(){return{type:WebInspector.BreakpointManager.BreakpointTypes.EventListener,condition:{eventName:this._eventName}}}},WebInspector.XHRBreakpoint=function(e){this._url=e},WebInspector.XHRBreakpoint.prototype={_enable:function(){InspectorBackend.setXHRBreakpoint(this._url)},_disable:function(){InspectorBackend.removeXHRBreakpoint(this._url)},_serializeToJSON:function(){return{type:WebInspector.BreakpointManager.BreakpointTypes.XHR,condition:{url:this._url}}}},WebInspector.NativeBreakpointView=function(e,t,n){this._manager=e,this._id=t,this._enabled=n,this._hit=!1},WebInspector.NativeBreakpointView.prototype={get enabled(){return this._enabled},set enabled(e){this._manager._setBreakpointEnabled(this._id,e),this._enabled=e,this.dispatchEventToListeners("enable-changed")},get hit(){return this._hit},set hit(e){this._hit=e,this.dispatchEventToListeners("hit-state-changed")},remove:function(){this._manager._removeBreakpoint(this._id),this._onRemove(),this.dispatchEventToListeners("removed")},_compare:function(e,t){return e!==t?e<t?-1:1:0},_onRemove:function(){}},WebInspector.NativeBreakpointView.prototype.__proto__=WebInspector.Object.prototype,WebInspector.DOMBreakpointView=function(e,t,n,i,r){WebInspector.NativeBreakpointView.call(this,e,t,n),this._node=i,this._nodeId=i.id,this._type=r,i.breakpoints[this._type]=this},WebInspector.DOMBreakpointView.prototype={compareTo:function(e){return this._compare(this._type,e._type)},populateLabelElement:function(e){
// FIXME: this should belong to the view, not the manager.
var t=WebInspector.panels.elements.linkifyNodeById(this._nodeId);t.addStyleClass("monospace"),e.appendChild(t);var n=document.createElement("div");n.className="source-text",n.textContent=WebInspector.domBreakpointTypeLabel(this._type),e.appendChild(n)},populateStatusMessageElement:function(n,e){var t=[WebInspector.domBreakpointTypeLabel(this._type),WebInspector.panels.elements.linkifyNodeById(this._nodeId)],i={s:function(e){return e}};function r(e,t){"string"==typeof t&&(t=document.createTextNode(t)),n.appendChild(t)}if(this._type===WebInspector.DOMBreakpointTypes.SubtreeModified){var o=WebInspector.panels.elements.linkifyNodeById(e.targetNodeId);e.insertion?e.targetNodeId!==this._nodeId?WebInspector.formatLocalized('Paused on a "%s" breakpoint set on %s, because a new child was added to its descendant %s.',t.concat(o),i,"",r):WebInspector.formatLocalized('Paused on a "%s" breakpoint set on %s, because a new child was added to that node.',t,i,"",r):WebInspector.formatLocalized('Paused on a "%s" breakpoint set on %s, because its descendant %s was removed.',t.concat(o),i,"",r)}else WebInspector.formatLocalized('Paused on a "%s" breakpoint set on %s.',t,i,"",r)},_onRemove:function(){delete this._node.breakpoints[this._type]}},WebInspector.DOMBreakpointView.prototype.__proto__=WebInspector.NativeBreakpointView.prototype,WebInspector.EventListenerBreakpointView=function(e,t,n,i){WebInspector.NativeBreakpointView.call(this,e,t,n),this._eventName=i},WebInspector.EventListenerBreakpointView.eventNameForUI=function(e){return WebInspector.EventListenerBreakpointView._eventNamesForUI||(WebInspector.EventListenerBreakpointView._eventNamesForUI={"instrumentation:setTimer":WebInspector.UIString("Set Timer"),"instrumentation:clearTimer":WebInspector.UIString("Clear Timer"),"instrumentation:timerFired":WebInspector.UIString("Timer Fired")}),WebInspector.EventListenerBreakpointView._eventNamesForUI[e]||e.substring(e.indexOf(":")+1)},WebInspector.EventListenerBreakpointView.prototype={get eventName(){return this._eventName},compareTo:function(e){return this._compare(this._eventName,e._eventName)},populateLabelElement:function(e){e.appendChild(document.createTextNode(this._uiEventName()))},populateStatusMessageElement:function(e,t){var n=WebInspector.UIString('Paused on a "%s" Event Listener.',this._uiEventName());e.appendChild(document.createTextNode(n))},_uiEventName:function(){return WebInspector.EventListenerBreakpointView.eventNameForUI(this._eventName)}},WebInspector.EventListenerBreakpointView.prototype.__proto__=WebInspector.NativeBreakpointView.prototype,WebInspector.XHRBreakpointView=function(e,t,n,i){WebInspector.NativeBreakpointView.call(this,e,t,n),this._url=i},WebInspector.XHRBreakpointView.prototype={compareTo:function(e){return this._compare(this._url,e._url)},populateEditElement:function(e){e.textContent=this._url},populateLabelElement:function(e){var t;t=this._url.length?WebInspector.UIString('URL contains "%s"',this._url):WebInspector.UIString("Any XHR"),e.appendChild(document.createTextNode(t)),e.addStyleClass("cursor-auto")},populateStatusMessageElement:function(e){var t=WebInspector.UIString("Paused on a XMLHttpRequest.");e.appendChild(document.createTextNode(t))}},WebInspector.XHRBreakpointView.prototype.__proto__=WebInspector.NativeBreakpointView.prototype,WebInspector.DOMBreakpointTypes={SubtreeModified:0,AttributeModified:1,NodeRemoved:2},WebInspector.domBreakpointTypeLabel=function(e){return WebInspector._DOMBreakpointTypeLabels||(WebInspector._DOMBreakpointTypeLabels={},WebInspector._DOMBreakpointTypeLabels[WebInspector.DOMBreakpointTypes.SubtreeModified]=WebInspector.UIString("Subtree Modified"),WebInspector._DOMBreakpointTypeLabels[WebInspector.DOMBreakpointTypes.AttributeModified]=WebInspector.UIString("Attribute Modified"),WebInspector._DOMBreakpointTypeLabels[WebInspector.DOMBreakpointTypes.NodeRemoved]=WebInspector.UIString("Node Removed")),WebInspector._DOMBreakpointTypeLabels[e]},WebInspector.domBreakpointTypeContextMenuLabel=function(e){return WebInspector._DOMBreakpointTypeContextMenuLabels||(WebInspector._DOMBreakpointTypeContextMenuLabels={},WebInspector._DOMBreakpointTypeContextMenuLabels[WebInspector.DOMBreakpointTypes.SubtreeModified]=WebInspector.UIString("Break on Subtree Modifications"),WebInspector._DOMBreakpointTypeContextMenuLabels[WebInspector.DOMBreakpointTypes.AttributeModified]=WebInspector.UIString("Break on Attributes Modifications"),WebInspector._DOMBreakpointTypeContextMenuLabels[WebInspector.DOMBreakpointTypes.NodeRemoved]=WebInspector.UIString("Break on Node Removal")),WebInspector._DOMBreakpointTypeContextMenuLabels[e]};