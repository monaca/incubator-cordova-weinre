/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.NetworkManager=function(e){WebInspector.Object.call(this),this._resourceTreeModel=e,this._dispatcher=new WebInspector.NetworkDispatcher(e,this),InspectorBackend.cachedResources(this._processCachedResources.bind(this))},WebInspector.NetworkManager.EventTypes={ResourceStarted:"ResourceStarted",ResourceUpdated:"ResourceUpdated",ResourceFinished:"ResourceFinished",MainResourceCommitLoad:"MainResourceCommitLoad"},WebInspector.NetworkManager.prototype={reset:function(){WebInspector.panels.network.clear(),this._resourceTreeModel.reset(),InspectorBackend.cachedResources(this._processCachedResources.bind(this))},requestContent:function(e,t,s){InspectorBackend.resourceContent(e.loader.frameId,e.url,t,function(e,t){s(e?t:null)})},_processCachedResources:function(e){var t=this._dispatcher._addFramesRecursively(e);(WebInspector.mainResource=t).isMainResource=!0},inflightResourceForURL:function(e){return this._dispatcher._inflightResourcesByURL[e]}},WebInspector.NetworkManager.prototype.__proto__=WebInspector.Object.prototype,WebInspector.NetworkDispatcher=function(e,t){this._manager=t,this._inflightResourcesById={},this._inflightResourcesByURL={},this._resourceTreeModel=e,this._lastIdentifierForCachedResource=0,InspectorBackend.registerDomainDispatcher("Network",this)},WebInspector.NetworkDispatcher.prototype={_updateResourceWithRequest:function(e,t){e.requestMethod=t.httpMethod,e.requestHeaders=t.httpHeaderFields,e.requestFormData=t.requestFormData},_updateResourceWithResponse:function(e,t){e.isNull||(e.mimeType=t.mimeType,e.expectedContentLength=t.expectedContentLength,e.textEncodingName=t.textEncodingName,e.suggestedFilename=t.suggestedFilename,e.statusCode=t.httpStatusCode,e.statusText=t.httpStatusText,e.responseHeaders=t.httpHeaderFields,e.connectionReused=t.connectionReused,e.connectionID=t.connectionID,t.wasCached?e.cached=!0:e.timing=t.timing,t.loadInfo&&(t.loadInfo.httpStatusCode&&(e.statusCode=t.loadInfo.httpStatusCode),t.loadInfo.httpStatusText&&(e.statusText=t.loadInfo.httpStatusText),e.requestHeaders=t.loadInfo.requestHeaders,e.responseHeaders=t.loadInfo.responseHeaders))},_updateResourceWithCachedResource:function(e,t){e.type=WebInspector.Resource.Type[t.type],e.resourceSize=t.encodedSize,this._updateResourceWithResponse(e,t.response)},identifierForInitialRequest:function(e,t,s,r){this._startResource(this._createResource(e,t,s,r))},willSendRequest:function(e,t,s,r){var o=this._inflightResourcesById[e];if(o){
// Redirect may have empty URL and we'd like to not crash with invalid HashMap entry.
// See http/tests/misc/will-send-request-returns-null-on-redirect.html
var i=!r.isNull&&s.url.length;i&&(this.didReceiveResponse(e,t,"Other",r),o=this._appendRedirect(o.identifier,t,s.url)),this._updateResourceWithRequest(o,s),o.startTime=t,i?this._startResource(o):this._updateResource(o)}},markResourceAsCached:function(e){var t=this._inflightResourcesById[e];t&&(t.cached=!0,this._updateResource(t))},didReceiveResponse:function(e,t,s,r){var o=this._inflightResourcesById[e];o&&(o.responseReceivedTime=t,o.type=WebInspector.Resource.Type[s],this._updateResourceWithResponse(o,r),this._updateResource(o),this._resourceTreeModel.addResourceToFrame(o.loader.frameId,o))},didReceiveContentLength:function(e,t,s){var r=this._inflightResourcesById[e];r&&(r.resourceSize+=s,r.endTime=t,this._updateResource(r))},didFinishLoading:function(e,t){var s=this._inflightResourcesById[e];s&&this._finishResource(s,t)},didFailLoading:function(e,t,s){var r=this._inflightResourcesById[e];r&&(r.failed=!0,r.localizedFailDescription=s,this._finishResource(r,t))},didLoadResourceFromMemoryCache:function(e,t){var s=this._createResource("cached:"+ ++this._lastIdentifierForCachedResource,t.url,t.loader);this._updateResourceWithCachedResource(s,t),s.cached=!0,s.requestMethod="GET",this._startResource(s),s.startTime=s.responseReceivedTime=e,this._finishResource(s,e),this._resourceTreeModel.addResourceToFrame(s.loader.frameId,s)},frameDetachedFromParent:function(e){this._resourceTreeModel.frameDetachedFromParent(e)},setInitialContent:function(e,t,s){var r=WebInspector.networkResourceById(e);r&&(r.type=WebInspector.Resource.Type[s],r.setInitialContent(t),this._updateResource(r))},didCommitLoadForFrame:function(e,t){if(this._resourceTreeModel.didCommitLoadForFrame(e,t),!e.parentId){var s=this._resourceTreeModel.resourceForURL(e.url);s&&((WebInspector.mainResource=s).isMainResource=!0,this._dispatchEventToListeners(WebInspector.NetworkManager.EventTypes.MainResourceCommitLoad,s))}},didCreateWebSocket:function(e,t){var s=this._createResource(e,t);s.type=WebInspector.Resource.Type.WebSocket,this._startResource(s)},willSendWebSocketHandshakeRequest:function(e,t,s){var r=this._inflightResourcesById[e];r&&(r.requestMethod="GET",r.requestHeaders=s.webSocketHeaderFields,r.webSocketRequestKey3=s.webSocketRequestKey3,r.startTime=t,this._updateResource(r))},didReceiveWebSocketHandshakeResponse:function(e,t,s){var r=this._inflightResourcesById[e];r&&(r.statusCode=s.statusCode,r.statusText=s.statusText,r.responseHeaders=s.webSocketHeaderFields,r.webSocketChallengeResponse=s.webSocketChallengeResponse,r.responseReceivedTime=t,this._updateResource(r))},didCloseWebSocket:function(e,t){var s=this._inflightResourcesById[e];s&&this._finishResource(s,t)},_appendRedirect:function(e,t,s){var r=this._inflightResourcesById[e],o=r.redirects||[];r.identifier="redirected:"+e+"."+o.length,delete r.redirects,this._finishResource(r,t);var i=this._createResource(e,s,r.loader,r.stackTrace);return i.redirects=o.concat(r),i},_startResource:function(e){this._inflightResourcesById[e.identifier]=e,this._inflightResourcesByURL[e.url]=e,this._dispatchEventToListeners(WebInspector.NetworkManager.EventTypes.ResourceStarted,e)},_updateResource:function(e){this._dispatchEventToListeners(WebInspector.NetworkManager.EventTypes.ResourceUpdated,e)},_finishResource:function(e,t){e.endTime=t,e.finished=!0,this._dispatchEventToListeners(WebInspector.NetworkManager.EventTypes.ResourceFinished,e),delete this._inflightResourcesById[e.identifier],delete this._inflightResourcesByURL[e.url]},_addFramesRecursively:function(e){var t=this._createResource(null,e.resource.url,e.resource.loader);this._updateResourceWithRequest(t,e.resource.request),this._updateResourceWithResponse(t,e.resource.response),t.type=WebInspector.Resource.Type.Document,t.finished=!0,this._resourceTreeModel.addOrUpdateFrame(e),this._resourceTreeModel.addResourceToFrame(e.id,t);for(var s=0;e.children&&s<e.children.length;++s)this._addFramesRecursively(e.children[s]);if(e.subresources){for(s=0;s<e.subresources.length;++s){var r=e.subresources[s],o=this._createResource(null,r.url,r.loader);this._updateResourceWithCachedResource(o,r),o.finished=!0,this._resourceTreeModel.addResourceToFrame(e.id,o)}return t}},_dispatchEventToListeners:function(e,t){this._manager.dispatchEventToListeners(e,t)},_createResource:function(e,t,s,r){var o=new WebInspector.Resource(e,t);return(o.loader=s)&&(o.documentURL=s.url),o.stackTrace=r,o}};