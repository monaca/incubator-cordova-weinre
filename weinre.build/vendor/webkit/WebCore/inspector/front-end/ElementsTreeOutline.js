/*
 * Copyright (C) 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) 2008 Matt Lilek <webkit@mattlilek.com>
 * Copyright (C) 2009 Joseph Pecoraro
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.ElementsTreeOutline=function(){this.element=document.createElement("ol"),this.element.addEventListener("mousedown",this._onmousedown.bind(this),!1),this.element.addEventListener("mousemove",this._onmousemove.bind(this),!1),this.element.addEventListener("mouseout",this._onmouseout.bind(this),!1),TreeOutline.call(this,this.element),this.includeRootDOMNode=!0,this.selectEnabled=!1,this.showInElementsPanelEnabled=!1,this.rootDOMNode=null,this.focusedDOMNode=null,this.element.addEventListener("contextmenu",this._contextMenuEventFired.bind(this),!0)},WebInspector.ElementsTreeOutline.prototype={get rootDOMNode(){return this._rootDOMNode},set rootDOMNode(e){this._rootDOMNode!==e&&(this._rootDOMNode=e,this._isXMLMimeType=!!(WebInspector.mainResource&&WebInspector.mainResource.mimeType&&WebInspector.mainResource.mimeType.match(/x(?:ht)?ml/i)),this.update())},get isXMLMimeType(){return this._isXMLMimeType},nodeNameToCorrectCase:function(e){return this.isXMLMimeType?e:e.toLowerCase()},get focusedDOMNode(){return this._focusedDOMNode},set focusedDOMNode(e){this._focusedDOMNode!==e?(this._focusedDOMNode=e,this.revealAndSelectNode(e),
// The revealAndSelectNode() method might find a different element if there is inlined text,
// and the select() call would change the focusedDOMNode and reenter this setter. So to
// avoid calling focusedNodeChanged() twice, first check if _focusedDOMNode is the same
// node as the one passed in.
this._focusedDOMNode===e&&this.focusedNodeChanged()):this.revealAndSelectNode(e)},get editing(){return this._editing},update:function(){var e=this.selectedTreeElement?this.selectedTreeElement.representedObject:null;if(this.removeChildren(),this.rootDOMNode){var t;if(this.includeRootDOMNode)(t=new WebInspector.ElementsTreeElement(this.rootDOMNode)).selectable=this.selectEnabled,this.appendChild(t);else for(
// FIXME: this could use findTreeElement to reuse a tree element if it already exists
var n=this.rootDOMNode.firstChild;n;)(t=new WebInspector.ElementsTreeElement(n)).selectable=this.selectEnabled,this.appendChild(t),n=n.nextSibling;e&&this.revealAndSelectNode(e)}},updateSelection:function(){this.selectedTreeElement&&this.treeOutline.selectedTreeElement.updateSelection()},focusedNodeChanged:function(e){},findTreeElement:function(e){var t=TreeOutline.prototype.findTreeElement.call(this,e,isAncestorNode,parentNode);return t||e.nodeType!==Node.TEXT_NODE||(
// The text node might have been inlined if it was short, so try to find the parent element.
t=TreeOutline.prototype.findTreeElement.call(this,e.parentNode,isAncestorNode,parentNode)),t},createTreeElementFor:function(e){var t;return(t=this.findTreeElement(e))?t:e.parentNode&&(t=this.createTreeElementFor(e.parentNode))&&t.showChild(e.index)?t.children[e.index]:null},set suppressRevealAndSelect(e){this._suppressRevealAndSelect!==e&&(this._suppressRevealAndSelect=e)},revealAndSelectNode:function(e){if(e&&!this._suppressRevealAndSelect){var t=this.createTreeElementFor(e);t&&(t.reveal(),t.select())}},_treeElementFromEvent:function(e){var t=this.element,n=t.totalOffsetLeft+t.offsetWidth-20,i=e.pageY,s=this.treeElementFromPoint(n,i);
// We choose this X coordinate based on the knowledge that our list
// items extend nearly to the right edge of the outer <ol>.
return s===this.treeElementFromPoint(n,i-2)?s:this.treeElementFromPoint(n,i+2)},_onmousedown:function(e){var t=this._treeElementFromEvent(e);t&&!t.isEventWithinDisclosureTriangle(e)&&t.select()},_onmousemove:function(e){var t=this._treeElementFromEvent(e);t&&this._previousHoveredElement===t||(this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement),t&&(t.hovered=!0,
// Lazily compute tag-specific tooltips.
(this._previousHoveredElement=t).representedObject&&!t.tooltip&&t._createTooltipForNode()),WebInspector.highlightDOMNode(t?t.representedObject.id:0))},_onmouseout:function(e){var t=document.elementFromPoint(e.pageX,e.pageY);t&&t.isDescendant(this.element)||(this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement),WebInspector.highlightDOMNode(0))},_contextMenuEventFired:function(e){var t=e.target.enclosingNodeOrSelfWithNodeName("LI");if(t&&t.treeElement){var n=new WebInspector.ContextMenu;if(this.showInElementsPanelEnabled){n.appendItem(WebInspector.UIString("Reveal in Elements Panel"),function(){WebInspector.panels.elements.switchToAndFocus(t.treeElement.representedObject)}.bind(this))}else{var i,s=e.target.enclosingNodeOrSelfWithClass("webkit-html-resource-link")||e.target.enclosingNodeOrSelfWithClass("webkit-html-external-link"),r=e.target.enclosingNodeOrSelfWithClass("webkit-html-tag"),l=e.target.enclosingNodeOrSelfWithClass("webkit-html-text-node");s&&(i=WebInspector.panels.elements.populateHrefContextMenu(n,e,s)),r&&t.treeElement._populateTagContextMenu?(i&&n.appendSeparator(),t.treeElement._populateTagContextMenu(n,e)):l&&t.treeElement._populateTextContextMenu&&(i&&n.appendSeparator(),t.treeElement._populateTextContextMenu(n,l))}n.show(e)}}},WebInspector.ElementsTreeOutline.prototype.__proto__=TreeOutline.prototype,WebInspector.ElementsTreeElement=function(e,t){var n=!(this._elementCloseTag=t)&&e.hasChildNodes()&&!this._showInlineText(e);
// The title will be updated in onattach.
TreeElement.call(this,"",e,n),this.representedObject.nodeType!=Node.ELEMENT_NODE||t||(this._canAddAttributes=!0),this._searchQuery=null,this._expandedChildrenLimit=WebInspector.ElementsTreeElement.InitialChildrenLimit},WebInspector.ElementsTreeElement.InitialChildrenLimit=500,
// A union of HTML4 and HTML5-Draft elements that explicitly
// or implicitly (for HTML5) forbid the closing tag.
// FIXME: Revise once HTML5 Final is published.
WebInspector.ElementsTreeElement.ForbiddenClosingTagElements=["area","base","basefont","br","canvas","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source"].keySet(),
// These tags we do not allow editing their tag name.
WebInspector.ElementsTreeElement.EditTagBlacklist=["html","head","body"].keySet(),WebInspector.ElementsTreeElement.prototype={highlightSearchResults:function(e){this._searchQuery!==e&&(this._searchQuery=e,this.updateTitle())},get hovered(){return this._hovered},set hovered(e){this._hovered!==e&&(this._hovered=e,this.listItemElement&&(e?(this.updateSelection(),this.listItemElement.addStyleClass("hovered")):this.listItemElement.removeStyleClass("hovered")))},get expandedChildrenLimit(){return this._expandedChildrenLimit},set expandedChildrenLimit(e){this._expandedChildrenLimit!==e&&(this._expandedChildrenLimit=e,this.treeOutline&&!this._updateChildrenInProgress&&this._updateChildren(!0))},get expandedChildCount(){var e=this.children.length;return e&&this.children[e-1]._elementCloseTag&&e--,e&&this.children[e-1].expandAllButton&&e--,e},showChild:function(e){if(!this._elementCloseTag)
// Whether index-th child is visible in the children tree
return e>=this.expandedChildrenLimit&&(this._expandedChildrenLimit=e+1,this._updateChildren(!0)),this.expandedChildCount>e},_createTooltipForNode:function(){var e=this.representedObject;e.nodeName&&"img"===e.nodeName.toLowerCase()&&InspectorBackend.getNodeProperties(e.id,["naturalHeight","naturalWidth","offsetHeight","offsetWidth"],function(e){e&&(e.offsetHeight===e.naturalHeight&&e.offsetWidth===e.naturalWidth?this.tooltip=WebInspector.UIString("%d × %d pixels",e.offsetWidth,e.offsetHeight):this.tooltip=WebInspector.UIString("%d × %d pixels (Natural: %d × %d pixels)",e.offsetWidth,e.offsetHeight,e.naturalWidth,e.naturalHeight))}.bind(this))},updateSelection:function(){var e=this.listItemElement;e&&(document.body.offsetWidth<=0||(this.selectionElement||(this.selectionElement=document.createElement("div"),this.selectionElement.className="selection selected",e.insertBefore(this.selectionElement,e.firstChild)),this.selectionElement.style.height=e.offsetHeight+"px"))},onattach:function(){this._hovered&&(this.updateSelection(),this.listItemElement.addStyleClass("hovered")),this.updateTitle(),this._preventFollowingLinksOnDoubleClick()},_preventFollowingLinksOnDoubleClick:function(){var e=this.listItemElement.querySelectorAll("li > .webkit-html-tag > .webkit-html-attribute > .webkit-html-external-link, li > .webkit-html-tag > .webkit-html-attribute > .webkit-html-resource-link");if(e)for(var t=0;t<e.length;++t)e[t].preventFollowOnDoubleClick=!0},onpopulate:function(){this.children.length||this._showInlineText(this.representedObject)||this._elementCloseTag||this.updateChildren()},updateChildren:function(e){this._elementCloseTag||WebInspector.domAgent.getChildNodesAsync(this.representedObject,this._updateChildren.bind(this,e))},insertChildElement:function(e,t,n){var i=new WebInspector.ElementsTreeElement(e,n);return i.selectable=this.treeOutline.selectEnabled,this.insertChild(i,t),i},moveChild:function(e,t){var n=e.selected;this.removeChild(e),this.insertChild(e,t),n&&e.select()},_updateChildren:function(e){if(!this._updateChildrenInProgress){this._updateChildrenInProgress=!0;var t,d=this.treeOutline.focusedDOMNode;if(e){var n=this.treeOutline.element.parentNode;t=n.scrollTop,(s=this.treeOutline.selectedTreeElement)&&s.hasAncestor(this)&&this.select(),this.removeChildren()}
// Remove any tree elements that no longer have this node (or this node's contentDocument) as their parent.
for(var o,a=this,h=0,i=this.children.length-1;0<=i;--i){var s,r=this.children[i];if(r.representedObject.parentNode!==this.representedObject)(s=this.treeOutline.selectedTreeElement)&&(s===r||s.hasAncestor(r))&&this.select(),this.removeChildAtIndex(i)}!function(e){a.treeOutline;for(var t=e.firstChild;t;){var n=a.children[h];if(!n||n.representedObject!==t){for(
// Find any existing element that is later in the children list.
var i=null,s=h+1,r=a.expandedChildCount;s<r;++s)if(a.children[s].representedObject===t){i=a.children[s];break}if(i&&i.parent===a)
// If an existing element was found and it has the same parent, just move it.
a.moveChild(i,h);else
// No existing element found, insert a new element.
if(h<a.expandedChildrenLimit){var l=a.insertChildElement(t,h);t===d&&(o=l),a.expandedChildCount>a.expandedChildrenLimit&&a.expandedChildrenLimit++}}t=t.nextSibling,++h}}(this.representedObject),this.adjustCollapsedRange(!1);var l=this.children[this.children.length-1];this.representedObject.nodeType!=Node.ELEMENT_NODE||l&&l._elementCloseTag||this.insertChildElement(this.representedObject,this.children.length,!0),
// We want to restore the original selection and tree scroll position after a full refresh, if possible.
e&&o&&(o.select(),n&&t<=n.scrollHeight&&(n.scrollTop=t)),delete this._updateChildrenInProgress}},adjustCollapsedRange:function(){
// Ensure precondition: only the tree elements for node children are found in the tree
// (not the Expand All button or the closing tag).
this.expandAllButtonElement&&this.expandAllButtonElement.__treeElement.parent&&this.removeChild(this.expandAllButtonElement.__treeElement);var e=this.representedObject;if(e.children){
// In case some nodes from the expanded range were removed, pull some nodes from the collapsed range into the expanded range at the bottom.
for(var t=e.children.length,n=this.expandedChildCount,i=Math.min(this.expandedChildrenLimit,t);n<i;++n)this.insertChildElement(e.children[n],n);var s=this.expandedChildCount;if(t>this.expandedChildCount){var r=s;if(this.expandAllButtonElement)this.expandAllButtonElement.__treeElement.parent||this.insertChild(this.expandAllButtonElement.__treeElement,r);else{var l=new TreeElement(null,null,!1);l.titleHTML='<button class="show-all-nodes" value="" />',l.selectable=!1,l.expandAllButton=!0,this.insertChild(l,r),this.expandAllButtonElement=l.listItemElement.firstChild,this.expandAllButtonElement.__treeElement=l,this.expandAllButtonElement.addEventListener("click",this.handleLoadAllChildren.bind(this),!1)}this.expandAllButtonElement.textContent=WebInspector.UIString("Show All Nodes (%d More)",t-s)}else this.expandAllButtonElement&&delete this.expandAllButtonElement}},handleLoadAllChildren:function(){this.expandedChildrenLimit=Math.max(this.representedObject._childNodeCount,this.expandedChildrenLimit+WebInspector.ElementsTreeElement.InitialChildrenLimit)},onexpand:function(){this._elementCloseTag||(this.updateTitle(),this.treeOutline.updateSelection())},oncollapse:function(){this._elementCloseTag||(this.updateTitle(),this.treeOutline.updateSelection())},onreveal:function(){this.listItemElement&&this.listItemElement.scrollIntoViewIfNeeded(!1)},onselect:function(e,t){this.treeOutline.suppressRevealAndSelect=!0,this.treeOutline.focusedDOMNode=this.representedObject,t&&WebInspector.highlightDOMNode(this.representedObject.id),this.updateSelection(),this.treeOutline.suppressRevealAndSelect=!1},ondelete:function(){var e=this.treeOutline.findTreeElement(this.representedObject);return e?e.remove():this.remove(),!0},onenter:function(){
// On Enter or Return start editing the first attribute
// or create a new attribute on the selected element.
return!this.treeOutline.editing&&(this._startEditing(),!0)},selectOnMouseDown:function(e){TreeElement.prototype.selectOnMouseDown.call(this,e),this._editing||(this.treeOutline.showInElementsPanelEnabled&&(WebInspector.showPanel("elements"),WebInspector.panels.elements.focusedDOMNode=this.representedObject),
// Prevent selecting the nearest word on double click.
2<=e.detail&&e.preventDefault())},ondblclick:function(e){this._editing||this._elementCloseTag||this._startEditingTarget(e.target)||this.hasChildren&&!this.expanded&&this.expand()},_insertInLastAttributePosition:function(e,t){if(0<e.getElementsByClassName("webkit-html-attribute").length)e.insertBefore(t,e.lastChild);else{var n=e.textContent.match(/^<(.*?)>$/)[1];e.textContent="",e.appendChild(document.createTextNode("<"+n)),e.appendChild(t),e.appendChild(document.createTextNode(">"))}this.updateSelection()},_startEditingTarget:function(e){if(this.treeOutline.focusedDOMNode==this.representedObject){if(this.representedObject.nodeType!=Node.ELEMENT_NODE&&this.representedObject.nodeType!=Node.TEXT_NODE)return!1;var t=e.enclosingNodeOrSelfWithClass("webkit-html-text-node");if(t)return this._startEditingTextNode(t);var n=e.enclosingNodeOrSelfWithClass("webkit-html-attribute");if(n)return this._startEditingAttribute(n,e);var i=e.enclosingNodeOrSelfWithClass("webkit-html-tag-name");return i?this._startEditingTagName(i):!!e.enclosingNodeOrSelfWithClass("add-attribute")&&this._addNewAttribute()}},_populateTagContextMenu:function(e,t){var n=t.target.enclosingNodeOrSelfWithClass("webkit-html-attribute"),i=t.target.enclosingNodeOrSelfWithClass("add-attribute");if(
// Add attribute-related actions.
e.appendItem(WebInspector.UIString("Add Attribute"),this._addNewAttribute.bind(this)),n&&!i&&e.appendItem(WebInspector.UIString("Edit Attribute"),this._startEditingAttribute.bind(this,n,t.target)),e.appendSeparator(),
// Add free-form node-related actions.
e.appendItem(WebInspector.UIString("Edit as HTML"),this._editAsHTML.bind(this)),e.appendItem(WebInspector.UIString("Copy as HTML"),this._copyHTML.bind(this)),e.appendItem(WebInspector.UIString("Delete Node"),this.remove.bind(this)),Preferences.nativeInstrumentationEnabled){function s(e,t){WebInspector.breakpointManager.createDOMBreakpoint(e,t),WebInspector.panels.elements.sidebarPanes.domBreakpoints.expand()}
// Add debbuging-related actions
e.appendSeparator();var r=this.representedObject;for(var l in WebInspector.DOMBreakpointTypes){var d=WebInspector.DOMBreakpointTypes[l],o=WebInspector.domBreakpointTypeContextMenuLabel(d),a=r.breakpoints[d];if(a)h=a.remove.bind(a);else var h=s.bind(this,r.id,d);e.appendCheckboxItem(o,h,!!a)}}},_populateTextContextMenu:function(e,t){e.appendItem(WebInspector.UIString("Edit Text"),this._startEditingTextNode.bind(this,t))},_startEditing:function(){if(this.treeOutline.focusedDOMNode===this.representedObject){var e=this._listItemNode;if(this._canAddAttributes){var t=e.getElementsByClassName("webkit-html-attribute")[0];return t?this._startEditingAttribute(t,t.getElementsByClassName("webkit-html-attribute-value")[0]):this._addNewAttribute()}if(this.representedObject.nodeType===Node.TEXT_NODE){var n=e.getElementsByClassName("webkit-html-text-node")[0];return n?this._startEditingTextNode(n):void 0}}},_addNewAttribute:function(){
// Cannot just convert the textual html into an element without
// a parent node. Use a temporary span container for the HTML.
var e=document.createElement("span");e.innerHTML=this._attributeHTML(" ","");var t=e.firstChild;t.style.marginLeft="2px",// overrides the .editing margin rule
t.style.marginRight="2px";// overrides the .editing margin rule
var n=this.listItemElement.getElementsByClassName("webkit-html-tag")[0];return this._insertInLastAttributePosition(n,t),this._startEditingAttribute(t,t)},_triggerEditAttribute:function(e){for(var t=this.listItemElement.getElementsByClassName("webkit-html-attribute-name"),n=0,i=t.length;n<i;++n)if(t[n].textContent===e)for(var s=t[n].nextSibling;s;s=s.nextSibling)if(s.nodeType===Node.ELEMENT_NODE&&s.hasStyleClass("webkit-html-attribute-value"))return this._startEditingAttribute(s.parentNode,s)},_startEditingAttribute:function(e,t){if(WebInspector.isBeingEdited(e))return!0;var n=e.getElementsByClassName("webkit-html-attribute-name")[0];if(!n)return!1;var i=n.innerText;
// Remove zero-width spaces that were added by nodeTitleInfo.
return function e(t){if(t.nodeType!==Node.TEXT_NODE){if(t.nodeType===Node.ELEMENT_NODE)for(var n=t.firstChild;n;n=n.nextSibling)e(n)}else t.nodeValue=t.nodeValue.replace(/\u200B/g,"")}(e),this._editing=WebInspector.startEditing(e,{context:i,commitHandler:this._attributeEditingCommitted.bind(this),cancelHandler:this._editingCancelled.bind(this)}),window.getSelection().setBaseAndExtent(t,0,t,1),!0},_startEditingTextNode:function(e){return WebInspector.isBeingEdited(e)||(this._editing=WebInspector.startEditing(e,{context:null,commitHandler:this._textNodeEditingCommitted.bind(this),cancelHandler:this._editingCancelled.bind(this)}),window.getSelection().setBaseAndExtent(e,0,e,1)),!0},_startEditingTagName:function(n){if(!n&&!(n=this.listItemElement.getElementsByClassName("webkit-html-tag-name")[0]))return!1;var e=n.textContent;if(WebInspector.ElementsTreeElement.EditTagBlacklist[e.toLowerCase()])return!1;if(WebInspector.isBeingEdited(n))return!0;var t=this._distinctClosingTagElement();function i(e){t&&(t.textContent="</"+n.textContent+">")}return n.addEventListener("keyup",i,!1),this._editing=WebInspector.startEditing(n,{context:e,commitHandler:function(e,t){n.removeEventListener("keyup",i,!1),this._tagNameEditingCommitted.apply(this,arguments)}.bind(this),cancelHandler:function(){n.removeEventListener("keyup",i,!1),this._editingCancelled.apply(this,arguments)}.bind(this)}),window.getSelection().setBaseAndExtent(n,0,n,1),!0},_startEditingAsHTML:function(e,t){if(this._htmlEditElement&&WebInspector.isBeingEdited(this._htmlEditElement))return!0;this._htmlEditElement=document.createElement("div"),this._htmlEditElement.className="source-code elements-tree-editor",this._htmlEditElement.textContent=t;for(
// Hide header items.
var n=this.listItemElement.firstChild;n;)n.style.display="none",n=n.nextSibling;
// Hide children item.
function i(){delete this._editing,
// Remove editor.
this.listItemElement.removeChild(this._htmlEditElement),delete this._htmlEditElement,
// Unhide children item.
this._childrenListNode&&this._childrenListNode.style.removeProperty("display");for(
// Unhide header items.
var e=this.listItemElement.firstChild;e;)e.style.removeProperty("display"),e=e.nextSibling;this.updateSelection()}this._childrenListNode&&(this._childrenListNode.style.display="none"),
// Append editor.
this.listItemElement.appendChild(this._htmlEditElement),this.updateSelection(),this._editing=WebInspector.startEditing(this._htmlEditElement,{context:null,commitHandler:function(){e(this._htmlEditElement.textContent),i.call(this)}.bind(this),cancelHandler:i.bind(this),multiline:!0})},_attributeEditingCommitted:function(i,e,t,n,s){
// Before we do anything, determine where we should move
// next based on the current element's settings
var r,l,d;if(delete this._editing,s){for(var o=!1,a=this.representedObject.attributes,h=0
// Search for the attribute's position, and then decide where to move to.
;h<a.length;++h)a[h].name===n&&(o=!0,"backward"===s?0===h?l=!0:r=a[h-1].name:"forward"===s&&(h===a.length-1?d=!0:r=a[h+1].name));
// Moving From the "New Attribute" position.
o||("backward"===s&&0<a.length?r=a[a.length-1].name:"forward"===s&&(/^\s*$/.test(e)?l=!0:d=!0))}function c(){
// Cleanup empty new attribute sections.
0===i.textContent.trim().length&&i.parentNode.removeChild(i),
// Make the move.
r?this._triggerEditAttribute(r):d?this._addNewAttribute():l&&this._startEditingTagName()}function p(e,t){var n=i.previousSibling;n&&n.nodeType===Node.TEXT_NODE||i.parentNode.insertBefore(document.createTextNode(" "),i),i.outerHTML=this._attributeHTML(e,t)}var m=document.createElement("span");m.innerHTML="<span "+e+"></span>";var u=m.firstChild;if(!u)return this._editingCancelled(i,n),void c.call(this);if(!u.hasAttributes())return this.representedObject.removeAttribute(n),this.treeOutline.focusedNodeChanged(!0),void c.call(this);var E=!1;for(h=0;h<u.attributes.length;++h){var b=u.attributes[h];E=E||b.name===n;try{this.representedObject.setAttribute(b.name,b.value),p.call(this,b.name,b.value)}catch(e){}// ignore invalid attribute (innerHTML doesn't throw errors, but this can)
}E||this.representedObject.removeAttribute(n),this.treeOutline.focusedNodeChanged(!0),c.call(this)},_tagNameEditingCommitted:function(t,e,n,i,s){delete this._editing;var r=this;function l(){var e=r._distinctClosingTagElement();e&&(e.textContent="</"+i+">"),r._editingCancelled(t,i),d.call(r)}function d(){if("forward"===s){var e=this.representedObject.attributes;0<e.length?this._triggerEditAttribute(e[0].name):this._addNewAttribute()}else this._addNewAttribute()}if((e=e.trim())!==n){var o=this.treeOutline,a=this.expanded;InspectorBackend.changeTagName(this.representedObject.id,e,function(e){if(e){
// Select it and expand if necessary. We force tree update so that it processes dom events and is up to date.
WebInspector.panels.elements.updateModifiedNodes(),WebInspector.updateFocusedNode(e);var t=o.findTreeElement(WebInspector.domAgent.nodeForId(e));a&&t.expand(),d.call(t)}else l()})}else l()},_textNodeEditingCommitted:function(e,t){var n;delete this._editing,this.representedObject.nodeType===Node.ELEMENT_NODE?
// We only show text nodes inline in elements if the element only
// has a single child, and that child is a text node.
n=this.representedObject.firstChild:this.representedObject.nodeType==Node.TEXT_NODE&&(n=this.representedObject),n.nodeValue=t},_editingCancelled:function(e,t){delete this._editing,
// Need to restore attributes structure.
this.updateTitle()},_distinctClosingTagElement:function(){
// FIXME: Improve the Tree Element / Outline Abstraction to prevent crawling the DOM
// For an expanded element, it will be the last element with class "close"
// in the child element list.
if(this.expanded){var e=this._childrenListNode.querySelectorAll(".close");return e[e.length-1]}
// Remaining cases are single line non-expanded elements with a closing
// tag, or HTML elements without a closing tag (such as <br>). Return
// null in the case where there isn't a closing tag.
var t=this.listItemElement.getElementsByClassName("webkit-html-tag");return 1===t.length?null:t[t.length-1]},updateTitle:function(){
// If we are editing, return early to prevent canceling the edit.
// After editing is committed updateTitle will be called.
this._editing||(this.titleHTML='<span class="highlight">'+this._nodeTitleInfo(WebInspector.linkifyURL).titleHTML+"</span>",delete this.selectionElement,this.updateSelection(),this._preventFollowingLinksOnDoubleClick(),this._highlightSearchResults())},_attributeHTML:function(e,t,n,i){var s=0<t.length,r='<span class="webkit-html-attribute"><span class="webkit-html-attribute-name">'+e.escapeHTML()+"</span>";(s&&(r+='=&#8203;"'),!i||"src"!==e&&"href"!==e)?r+='<span class="webkit-html-attribute-value">'+(t=t.escapeHTML().replace(/([\/;:\)\]\}])/g,"$1&#8203;"))+"</span>":r+=i(WebInspector.resourceURLForRelatedNode(n,t),t=t.replace(/([\/;:\)\]\}])/g,"$1​"),"webkit-html-attribute-value","a"===n.nodeName.toLowerCase());return s&&(r+='"'),r+="</span>"},_tagHTML:function(e,t,n,i){var s=this.representedObject,r='<span class="webkit-html-tag'+(t&&n?" close":"")+'">&lt;';if(r+="<span "+(t?"":'class="webkit-html-tag-name"')+">"+(t?"/":"")+e+"</span>",!t&&s.hasAttributes())for(var l=0;l<s.attributes.length;++l){var d=s.attributes[l];r+=" "+this._attributeHTML(d.name,d.value,s,i)}return r+="&gt;</span>&#8203;"},_nodeTitleInfo:function(e){var t=this.representedObject,n={titleHTML:"",hasChildren:this.hasChildren};switch(t.nodeType){case Node.DOCUMENT_NODE:n.titleHTML="Document";break;case Node.DOCUMENT_FRAGMENT_NODE:n.titleHTML="Document Fragment";break;case Node.ATTRIBUTE_NODE:var i=t.value||"​";// Zero width space to force showing an empty value.
n.titleHTML=this._attributeHTML(t.name,i);break;case Node.ELEMENT_NODE:var s=this.treeOutline.nodeNameToCorrectCase(t.nodeName).escapeHTML();if(this._elementCloseTag){n.titleHTML=this._tagHTML(s,!0,!0),n.hasChildren=!1;break}var r=this._tagHTML(s,!1,!1,e),l=onlyTextChild.call(t),d=l&&l.textContent.length<Preferences.maxInlineTextChildLength;this.expanded||d||!this.treeOutline.isXMLMimeType&&WebInspector.ElementsTreeElement.ForbiddenClosingTagElements[s]||(this.hasChildren&&(r+='<span class="webkit-html-text-node">&#8230;</span>&#8203;'),r+=this._tagHTML(s,!0,!1)),
// If this element only has a single child that is a text node,
// just show that text and the closing tag inline rather than
// create a subtree for them
d&&(r+='<span class="webkit-html-text-node">'+l.nodeValue.escapeHTML()+"</span>&#8203;"+this._tagHTML(s,!0,!1),n.hasChildren=!1),n.titleHTML=r;break;case Node.TEXT_NODE:if(isNodeWhitespace.call(t))n.titleHTML="(whitespace)";else if(t.parentNode&&"script"===t.parentNode.nodeName.toLowerCase())(o=document.createElement("span")).textContent=t.textContent,new WebInspector.DOMSyntaxHighlighter("text/javascript").syntaxHighlightNode(o),n.titleHTML='<span class="webkit-html-text-node webkit-html-js-node">'+o.innerHTML.replace(/^[\n\r]*/,"").replace(/\s*$/,"")+"</span>";else if(t.parentNode&&"style"===t.parentNode.nodeName.toLowerCase()){var o;(o=document.createElement("span")).textContent=t.textContent,new WebInspector.DOMSyntaxHighlighter("text/css").syntaxHighlightNode(o),n.titleHTML='<span class="webkit-html-text-node webkit-html-css-node">'+o.innerHTML.replace(/^[\n\r]*/,"").replace(/\s*$/,"")+"</span>"}else n.titleHTML='"<span class="webkit-html-text-node">'+t.nodeValue.escapeHTML()+'</span>"';break;case Node.COMMENT_NODE:n.titleHTML='<span class="webkit-html-comment">&lt;!--'+t.nodeValue.escapeHTML()+"--&gt;</span>";break;case Node.DOCUMENT_TYPE_NODE:r='<span class="webkit-html-doctype">&lt;!DOCTYPE '+t.nodeName;t.publicId?(r+=' PUBLIC "'+t.publicId+'"',t.systemId&&(r+=' "'+t.systemId+'"')):t.systemId&&(r+=' SYSTEM "'+t.systemId+'"'),t.internalSubset&&(r+=" ["+t.internalSubset+"]"),r+="&gt;</span>",n.titleHTML=r;break;case Node.CDATA_SECTION_NODE:n.titleHTML='<span class="webkit-html-text-node">&lt;![CDATA['+t.nodeValue.escapeHTML()+"]]&gt;</span>";break;default:n.titleHTML=this.treeOutline.nodeNameToCorrectCase(t.nodeName).collapseWhitespace().escapeHTML()}return n},_showInlineText:function(e){if(e.nodeType===Node.ELEMENT_NODE){var t=onlyTextChild.call(e);if(t&&t.textContent.length<Preferences.maxInlineTextChildLength)return!0}return!1},remove:function(){var t=this.parent;if(t){var n=this;InspectorBackend.removeNode(this.representedObject.id,function(e){
// -1 is an error code, which means removing the node from the DOM failed,
// so we shouldn't remove it from the tree.
-1!==e&&(t.removeChild(n),t.adjustCollapsedRange(!0))})}},_editAsHTML:function(){var n=this.treeOutline,t=this.representedObject,i=this.expanded;function s(e){if(e&&(
// Select it and expand if necessary. We force tree update so that it processes dom events and is up to date.
WebInspector.panels.elements.updateModifiedNodes(),WebInspector.updateFocusedNode(e),i)){var t=n.findTreeElement(WebInspector.domAgent.nodeForId(e));t&&t.expand()}}InspectorBackend.getOuterHTML(t.id,this._startEditingAsHTML.bind(this,function(e){InspectorBackend.setOuterHTML(t.id,e,s)}))},_copyHTML:function(){InspectorBackend.copyNode(this.representedObject.id)},_highlightSearchResults:function(){if(this._searchQuery)for(var e=this.listItemElement.textContent,t=createSearchRegex(this._searchQuery),n=0,i=t.exec(e);i;)highlightSearchResult(this.listItemElement,n+i.index,i[0].length),n+=i.index+1,e=e.substring(i.index+1),i=t.exec(e)}},WebInspector.ElementsTreeElement.prototype.__proto__=TreeElement.prototype;