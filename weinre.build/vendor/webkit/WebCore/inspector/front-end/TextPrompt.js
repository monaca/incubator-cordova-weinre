/*
 * Copyright (C) 2008 Apple Inc.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.TextPrompt=function(e,t,n,i){this.element=e,this.element.addStyleClass("text-prompt"),this.completions=t,this.completionStopCharacters=n,i||(this.history=[],this.historyOffset=0),this._boundOnKeyDown=this._onKeyDown.bind(this),this.element.addEventListener("keydown",this._boundOnKeyDown,!0)},WebInspector.TextPrompt.prototype={get text(){return this.element.textContent},set text(e){e?this.element.textContent=e:(
// Append a break element instead of setting textContent to make sure the selection is inside the prompt.
this.element.removeChildren(),this.element.appendChild(document.createElement("br"))),this.moveCaretToEndOfPrompt()},removeFromElement:function(){this.clearAutoComplete(!0),this.element.removeEventListener("keydown",this._boundOnKeyDown,!0)},_onKeyDown:function(e){function t(){this.clearAutoComplete(),this.autoCompleteSoon()}if(!e.handled){var n=!1;switch(e.keyIdentifier){case"Up":this.upKeyPressed(e);break;case"Down":this.downKeyPressed(e);break;case"U+0009":// Tab
this.tabKeyPressed(e);break;case"Right":case"End":this.acceptAutoComplete()||this.autoCompleteSoon();break;case"Alt":case"Meta":case"Shift":case"Control":break;case"U+0050":// Ctrl+P = Previous
if(this.history&&WebInspector.isMac()&&e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey){n=!0,this._moveBackInHistory();break}t.call(this);break;case"U+004E":// Ctrl+N = Next
if(this.history&&WebInspector.isMac()&&e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey){n=!0,this._moveForwardInHistory();break}t.call(this);break;default:t.call(this)}(n|=e.handled)&&(e.handled=!0,e.preventDefault(),e.stopPropagation())}},acceptAutoComplete:function(){if(!this.autoCompleteElement||!this.autoCompleteElement.parentNode)return!1;var e=this.autoCompleteElement.textContent,t=document.createTextNode(e);this.autoCompleteElement.parentNode.replaceChild(t,this.autoCompleteElement),delete this.autoCompleteElement;var n=document.createRange();n.setStart(t,e.length),n.setEnd(t,e.length);var i=window.getSelection();return i.removeAllRanges(),i.addRange(n),!0},clearAutoComplete:function(e){if(e&&"_completeTimeout"in this&&(clearTimeout(this._completeTimeout),delete this._completeTimeout),this.autoCompleteElement&&(this.autoCompleteElement.parentNode&&this.autoCompleteElement.parentNode.removeChild(this.autoCompleteElement),delete this.autoCompleteElement,this._userEnteredRange&&this._userEnteredText)){this._userEnteredRange.deleteContents(),this.element.pruneEmptyTextNodes();var t=document.createTextNode(this._userEnteredText);this._userEnteredRange.insertNode(t);var n=document.createRange();n.setStart(t,this._userEnteredText.length),n.setEnd(t,this._userEnteredText.length);var i=window.getSelection();i.removeAllRanges(),i.addRange(n),delete this._userEnteredRange,delete this._userEnteredText}},autoCompleteSoon:function(){"_completeTimeout"in this||(this._completeTimeout=setTimeout(this.complete.bind(this,!0),250))},complete:function(e,t){this.clearAutoComplete(!0);var n=window.getSelection();if(n.rangeCount){var i=n.getRangeAt(0),o=i.commonAncestorContainer===this.element;// this.element has no child Text nodes.
// Do not attempt to auto-complete an empty input in the auto mode (only on demand).
if((!e||!o)&&(e||o||i.commonAncestorContainer.isDescendant(this.element))&&(!e||this.isCaretAtEndOfPrompt())){var s=i.startContainer.rangeOfWord(i.startOffset,this.completionStopCharacters,this.element,"backward");this.completions(s,e,this._completionsReady.bind(this,n,e,s,t))}}},_completionsReady:function(e,t,n,i,o){if(o&&o.length){var s=e.getRangeAt(0),r=document.createRange();if(r.setStart(n.startContainer,n.startOffset),r.setEnd(s.endContainer,s.endOffset),n.toString()+s.toString()==r.toString()){var a=n.toString().length;if(t)var l=o[0];else if(1===o.length){a=(l=o[0]).length}else{for(var h=o[0],d=0;d<o.length;++d)for(var m=o[d],u=Math.min(h.length,m.length),c=a;c<u;++c)if(h[c]!==m[c]){h=h.substr(0,c);break}if(a=h.length,e.isCollapsed)l=o[0];else{var f=r.toString(),p=null;for(d=0;d<o.length;++d)o[d]===f&&(p=d);var g=p+(i?-1:1);if(null===p||g>=o.length)l=o[0];else if(g<0)l=o[o.length-1];else l=o[g]}}this._userEnteredRange=r,this._userEnteredText=r.toString(),r.deleteContents(),this.element.pruneEmptyTextNodes();var C=document.createRange();if(t){var y=l.substring(0,a),E=l.substring(a),v=document.createTextNode(y);r.insertNode(v),this.autoCompleteElement=document.createElement("span"),this.autoCompleteElement.className="auto-complete-text",this.autoCompleteElement.textContent=E,v.parentNode.insertBefore(this.autoCompleteElement,v.nextSibling),C.setStart(v,a),C.setEnd(v,a)}else{var T=document.createTextNode(l);r.insertNode(T),1<o.length?C.setStart(T,a):C.setStart(T,l.length),C.setEnd(T,l.length)}e.removeAllRanges(),e.addRange(C)}}},isCaretInsidePrompt:function(){return this.element.isInsertionCaretInside()},isCaretAtEndOfPrompt:function(){var e=window.getSelection();if(!e.rangeCount||!e.isCollapsed)return!1;var t=e.getRangeAt(0),n=t.startContainer;if(n!==this.element&&!n.isDescendant(this.element))return!1;if(n.nodeType===Node.TEXT_NODE&&t.startOffset<n.nodeValue.length)return!1;for(var i=!1;n;){if(n.nodeType===Node.TEXT_NODE&&n.nodeValue.length){if(i)return!1;i=!0}n=n.traverseNextNode(this.element)}return!0},isCaretOnFirstLine:function(){var e=window.getSelection(),t=e.focusNode;if(!t||t.nodeType!==Node.TEXT_NODE||t.parentNode!==this.element)return!0;if(-1!==t.textContent.substring(0,e.focusOffset).indexOf("\n"))return!1;for(t=t.previousSibling;t;){if(t.nodeType!==Node.TEXT_NODE)return!0;if(-1!==t.textContent.indexOf("\n"))return!1;t=t.previousSibling}return!0},isCaretOnLastLine:function(){var e=window.getSelection(),t=e.focusNode;if(!t||t.nodeType!==Node.TEXT_NODE||t.parentNode!==this.element)return!0;if(-1!==t.textContent.substring(e.focusOffset).indexOf("\n"))return!1;for(t=t.nextSibling;t;){if(t.nodeType!==Node.TEXT_NODE)return!0;if(-1!==t.textContent.indexOf("\n"))return!1;t=t.nextSibling}return!0},moveCaretToEndOfPrompt:function(){var e=window.getSelection(),t=document.createRange(),n=this.element.childNodes.length;t.setStart(this.element,n),t.setEnd(this.element,n),e.removeAllRanges(),e.addRange(t)},tabKeyPressed:function(e){e.handled=!0,this.complete(!1,e.shiftKey)},upKeyPressed:function(e){this.isCaretOnFirstLine()&&(e.handled=!0,this._moveBackInHistory())},downKeyPressed:function(e){this.isCaretOnLastLine()&&(e.handled=!0,this._moveForwardInHistory())},_moveBackInHistory:function(){if(this.history&&this.historyOffset!=this.history.length){this.clearAutoComplete(!0),0===this.historyOffset&&(this.tempSavedCommand=this.text),++this.historyOffset,this.text=this.history[this.history.length-this.historyOffset],this.element.scrollIntoView(!0);var e=this.text.indexOf("\n");if(-1===e)this.moveCaretToEndOfPrompt();else{var t=window.getSelection(),n=document.createRange();n.setStart(this.element.firstChild,e),n.setEnd(this.element.firstChild,e),t.removeAllRanges(),t.addRange(n)}}},_moveForwardInHistory:function(){if(this.history&&0!==this.historyOffset){if(this.clearAutoComplete(!0),--this.historyOffset,0===this.historyOffset)return this.text=this.tempSavedCommand,void delete this.tempSavedCommand;this.text=this.history[this.history.length-this.historyOffset],this.element.scrollIntoView()}}};