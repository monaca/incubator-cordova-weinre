/*
 * Copyright (C) 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.Drawer=function(){WebInspector.View.call(this,document.getElementById("drawer")),this._savedHeight=200,// Default.
this.state=WebInspector.Drawer.State.Hidden,this.fullPanel=!1,this._mainElement=document.getElementById("main"),this._toolbarElement=document.getElementById("toolbar"),this._mainStatusBar=document.getElementById("main-status-bar"),this._mainStatusBar.addEventListener("mousedown",this._startStatusBarDragging.bind(this),!0),this._viewStatusBar=document.getElementById("other-drawer-status-bar-items"),this._counters=document.getElementById("counters"),this._drawerStatusBar=document.getElementById("drawer-status-bar")},WebInspector.Drawer.prototype={get visibleView(){return this._visibleView},set visibleView(e){if(this._visibleView!==e){var t=!this._visibleView;this._visibleView&&this._visibleView.hide(),(this._visibleView=e)&&!t&&(this._safelyRemoveChildren(),this._viewStatusBar.removeChildren(),// optimize this? call old.detach()
e.attach(this.element,this._viewStatusBar),e.show(),this.visible=!0)}else{if(this.visible&&this.fullPanel)return;this.visible=!this.visible}},get savedHeight(){var e=this._savedHeight||this.element.offsetHeight;return Number.constrain(e,Preferences.minConsoleHeight,window.innerHeight-this._mainElement.totalOffsetTop-Preferences.minConsoleHeight)},showView:function(e){this.visible&&this.visibleView===e||(this.visibleView=e)},show:function(){if(!this._animating&&!this.visible){this.visibleView&&this.visibleView.show(),WebInspector.View.prototype.show.call(this),this._animating=!0,document.body.addStyleClass("drawer-visible");var e=document.getElementById("anchored-status-bar-items"),t=this.fullPanel?window.innerHeight-this._toolbarElement.offsetHeight:this.savedHeight,i=[{element:this.element,end:{height:t}},{element:this._mainElement,end:{bottom:t}},{element:this._mainStatusBar,start:{"padding-left":e.offsetWidth-1},end:{"padding-left":0}},{element:this._viewStatusBar,start:{opacity:0},end:{opacity:1}}];if(this._drawerStatusBar.insertBefore(e,this._drawerStatusBar.firstChild),this._currentPanelCounters){var n=this._drawerStatusBar.clientWidth-(this._counters.offsetLeft+this._currentPanelCounters.offsetWidth)-WebInspector.Panel.counterRightMargin;i.push({element:this._currentPanelCounters,start:{"padding-right":n},end:{"padding-right":0}}),this._currentPanelCounters.parentNode.removeChild(this._currentPanelCounters),this._mainStatusBar.appendChild(this._currentPanelCounters)}this._currentAnimation=WebInspector.animateStyle(i,this._animationDuration(),function(){"updateStatusBarItems"in WebInspector.currentPanel&&WebInspector.currentPanel.updateStatusBarItems(),this.visibleView.afterShow&&this.visibleView.afterShow(),delete this._animating,delete this._currentAnimation,this.state=this.fullPanel?WebInspector.Drawer.State.Full:WebInspector.Drawer.State.Variable,this._currentPanelCounters&&this._currentPanelCounters.removeAttribute("style")}.bind(this))}},hide:function(){if(!this._animating&&this.visible){WebInspector.View.prototype.hide.call(this),this.visibleView&&this.visibleView.hide(),this._animating=!0,this.fullPanel||(this._savedHeight=this.element.offsetHeight),(this.element===WebInspector.currentFocusElement||this.element.isAncestor(WebInspector.currentFocusElement))&&(WebInspector.currentFocusElement=WebInspector.previousFocusElement);var e=document.getElementById("anchored-status-bar-items");
// Temporarily set properties and classes to mimic the post-animation values so panels
// like Elements in their updateStatusBarItems call will size things to fit the final location.
this._mainStatusBar.style.setProperty("padding-left",e.offsetWidth-1+"px"),document.body.removeStyleClass("drawer-visible"),"updateStatusBarItems"in WebInspector.currentPanel&&WebInspector.currentPanel.updateStatusBarItems(),document.body.addStyleClass("drawer-visible");var t=[{element:this._mainElement,end:{bottom:0}},{element:this._mainStatusBar,start:{"padding-left":0},end:{"padding-left":e.offsetWidth-1}},{element:this._viewStatusBar,start:{opacity:1},end:{opacity:0}}];if(this._currentPanelCounters){var i=this._drawerStatusBar.clientWidth-this._counters.offsetLeft-(this._mainStatusBar.clientWidth-(this._currentPanelCounters.offsetLeft+this._currentPanelCounters.offsetWidth));t.push({element:this._currentPanelCounters,start:{"padding-right":0},end:{"padding-right":i}})}this._currentAnimation=WebInspector.animateStyle(t,this._animationDuration(),function(){WebInspector.currentPanel.resize(),this._mainStatusBar.insertBefore(e,this._mainStatusBar.firstChild),this._mainStatusBar.style.removeProperty("padding-left"),this._currentPanelCounters&&(this._currentPanelCounters.setAttribute("style",null),this._currentPanelCounters.parentNode.removeChild(this._currentPanelCounters),this._counters.insertBefore(this._currentPanelCounters,this._counters.firstChild)),document.body.removeStyleClass("drawer-visible"),delete this._animating,delete this._currentAnimation,this.state=WebInspector.Drawer.State.Hidden}.bind(this))}},resize:function(){var e;this.state!==WebInspector.Drawer.State.Hidden&&(e=this.state===WebInspector.Drawer.State.Variable?(e=parseInt(this.element.style.height),Number.constrain(e,Preferences.minConsoleHeight,window.innerHeight-this._mainElement.totalOffsetTop-Preferences.minConsoleHeight)):window.innerHeight-this._toolbarElement.offsetHeight,this._mainElement.style.bottom=e+"px",this.element.style.height=e+"px")},enterPanelMode:function(){if(this._cancelAnimationIfNeeded(),this.fullPanel=!0,this.visible){this._savedHeight=this.element.offsetHeight;var e=window.innerHeight-this._toolbarElement.offsetHeight;this._animateDrawerHeight(e,WebInspector.Drawer.State.Full)}},exitPanelMode:function(){if(this._cancelAnimationIfNeeded(),this.fullPanel=!1,this.visible){
// If this animation gets cancelled, we want the state of the drawer to be Variable,
// so that the new animation can't do an immediate transition between Hidden/Full states.
this.state=WebInspector.Drawer.State.Variable;var e=this.savedHeight;this._animateDrawerHeight(e,WebInspector.Drawer.State.Variable)}},immediatelyExitPanelMode:function(){this.visible=!1,this.fullPanel=!1},immediatelyFinishAnimation:function(){this._currentAnimation&&this._currentAnimation.forceComplete()},set currentPanelCounters(e){if(!e)return this._currentPanelCounters&&this._currentPanelCounters.parentElement.removeChild(this._currentPanelCounters),void delete this._currentPanelCounters;this._currentPanelCounters=e,this.visible?this._mainStatusBar.appendChild(e):this._counters.insertBefore(e,this._counters.firstChild)},_cancelAnimationIfNeeded:function(){this._animating&&(this._currentAnimation&&this._currentAnimation.cancel(),delete this._animating,delete this._currentAnimation)},_animateDrawerHeight:function(e,t){this._animating=!0;var i=[{element:this.element,end:{height:e}},{element:this._mainElement,end:{bottom:e}}];this._currentAnimation=WebInspector.animateStyle(i,this._animationDuration(),function(){delete this._animating,delete this._currentAnimation,this.state=t}.bind(this))},_animationDuration:function(){
// Immediate if going between Hidden and Full in full panel mode
return!this.fullPanel||this.state!==WebInspector.Drawer.State.Hidden&&this.state!==WebInspector.Drawer.State.Full?window.event&&window.event.shiftKey?2e3:250:0},_safelyRemoveChildren:function(){for(var e=this.element.firstChild;e;)if("drawer-status-bar"!==e.id){var t=e.nextSibling;this.element.removeChild(e),e=t}else e=e.nextSibling},_startStatusBarDragging:function(e){this.visible&&e.target===this._mainStatusBar&&(WebInspector.elementDragStart(this._mainStatusBar,this._statusBarDragging.bind(this),this._endStatusBarDragging.bind(this),e,"row-resize"),this._statusBarDragOffset=e.pageY-this.element.totalOffsetTop,e.stopPropagation())},_statusBarDragging:function(e){var t=window.innerHeight-e.pageY+this._statusBarDragOffset;t=Number.constrain(t,Preferences.minConsoleHeight,window.innerHeight-this._mainElement.totalOffsetTop-Preferences.minConsoleHeight),this._mainElement.style.bottom=t+"px",this.element.style.height=t+"px",e.preventDefault(),e.stopPropagation()},_endStatusBarDragging:function(e){WebInspector.elementDragEnd(e),this._savedHeight=this.element.offsetHeight,delete this._statusBarDragOffset,e.stopPropagation()}},WebInspector.Drawer.prototype.__proto__=WebInspector.View.prototype,WebInspector.Drawer.State={Hidden:0,Variable:1,Full:2};