/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.HeapSnapshotArraySlice=function(e,t,n,s){
// Note: we don't reference snapshot contents directly to avoid
// holding references to big chunks of data.
this._snapshot=e,this._arrayName=t,this._start=n,this.length=s-n},WebInspector.HeapSnapshotArraySlice.prototype={item:function(e){return this._snapshot[this._arrayName][this._start+e]}},WebInspector.HeapSnapshotEdge=function(e,t,n){this._snapshot=e,this._edges=t,this.edgeIndex=n||0},WebInspector.HeapSnapshotEdge.prototype={clone:function(){return new WebInspector.HeapSnapshotEdge(this._snapshot,this._edges,this.edgeIndex)},get hasStringName(){return this.isShortcut?isNaN(parseInt(this._name,10)):this._hasStringName},get isElement(){return this._type()===this._snapshot._edgeElementType},get isHidden(){return this._type()===this._snapshot._edgeHiddenType},get isInternal(){return this._type()===this._snapshot._edgeInternalType},get isShortcut(){return this._type()===this._snapshot._edgeShortcutType},get name(){if(!this.isShortcut)return this._name;var e=parseInt(this._name,10);return isNaN(e)?this._name:e},get node(){return new WebInspector.HeapSnapshotNode(this._snapshot,this.nodeIndex)},get nodeIndex(){return this._edges.item(this.edgeIndex+this._snapshot._edgeToNodeOffset)},get rawEdges(){return this._edges},toString:function(){switch(this.type){case"context":return"->"+this.name;case"element":return"["+this.name+"]";case"property":return-1===this.name.indexOf(" ")?"."+this.name:'["'+this.name+'"]';case"shortcut":return"string"==typeof this.name?-1===this.name.indexOf(" ")?"."+this.name:'["'+this.name+'"]':"["+this.name+"]";case"internal":case"hidden":return"{"+this.name+"}"}return"?"+this.name+"?"},get type(){return this._snapshot._edgeTypes[this._type()]},get _hasStringName(){return!this.isElement&&!this.isHidden},get _name(){return this._hasStringName?this._snapshot._strings[this._nameOrIndex]:this._nameOrIndex},get _nameOrIndex(){return this._edges.item(this.edgeIndex+this._snapshot._edgeNameOffset)},_type:function(){return this._edges.item(this.edgeIndex+this._snapshot._edgeTypeOffset)}},WebInspector.HeapSnapshotEdgeIterator=function(e){this.edge=e},WebInspector.HeapSnapshotEdgeIterator.prototype={first:function(){this.edge.edgeIndex=0},hasNext:function(){return this.edge.edgeIndex<this.edge._edges.length},get index(){return this.edge.edgeIndex},set index(e){this.edge.edgeIndex=e},get item(){return this.edge},next:function(){this.edge.edgeIndex+=this.edge._snapshot._edgeFieldsCount}},WebInspector.HeapSnapshotNode=function(e,t){this._snapshot=e,this._firstNodeIndex=t,this.nodeIndex=t},WebInspector.HeapSnapshotNode.prototype={get className(){switch(this.type){case"hidden":return WebInspector.UIString("(system)");case"object":return this.name;case"code":return WebInspector.UIString("(compiled code)");default:return"("+this.type+")"}},dominatorIndex:function(){return this._nodes[this.nodeIndex+this._snapshot._dominatorOffset]},get edges(){return new WebInspector.HeapSnapshotEdgeIterator(new WebInspector.HeapSnapshotEdge(this._snapshot,this.rawEdges))},get edgesCount(){return this._nodes[this.nodeIndex+this._snapshot._edgesCountOffset]},get id(){return this._nodes[this.nodeIndex+this._snapshot._nodeIdOffset]},get instancesCount(){return this._nodes[this.nodeIndex+this._snapshot._nodeInstancesCountOffset]},get isHidden(){return this._type()===this._snapshot._nodeHiddenType},get isRoot(){return this.nodeIndex===this._snapshot._rootNodeIndex},get name(){return this._snapshot._strings[this._name()]},get rawEdges(){var e=this._firstEdgeIndex();return new WebInspector.HeapSnapshotArraySlice(this._snapshot,"_nodes",e,e+this.edgesCount*this._snapshot._edgeFieldsCount)},get retainedSize(){return this._nodes[this.nodeIndex+this._snapshot._nodeRetainedSizeOffset]},get retainers(){return new WebInspector.HeapSnapshotEdgeIterator(new WebInspector.HeapSnapshotEdge(this._snapshot,this._snapshot.retainers(this)))},get selfSize(){return this._nodes[this.nodeIndex+this._snapshot._nodeSelfSizeOffset]},get type(){return this._snapshot._nodeTypes[this._type()]},_name:function(){return this._nodes[this.nodeIndex+this._snapshot._nodeNameOffset]},get _nodes(){return this._snapshot._nodes},_firstEdgeIndex:function(){return this.nodeIndex+this._snapshot._firstEdgeOffset},get _nextNodeIndex(){return this._firstEdgeIndex()+this.edgesCount*this._snapshot._edgeFieldsCount},_type:function(){return this._nodes[this.nodeIndex+this._snapshot._nodeTypeOffset]}},WebInspector.HeapSnapshotNodeIterator=function(e){this.node=e},WebInspector.HeapSnapshotNodeIterator.prototype={first:function(){this.node.nodeIndex=this.node._firstNodeIndex},hasNext:function(){return this.node.nodeIndex<this.node._nodes.length},get index(){return this.node.nodeIndex},set index(e){this.node.nodeIndex=e},get item(){return this.node},next:function(){this.node.nodeIndex=this.node._nextNodeIndex}},WebInspector.HeapSnapshot=function(e){this._nodes=e.nodes,this._strings=e.strings,this._init()},WebInspector.HeapSnapshot.prototype={_init:function(){this._metaNodeIndex=0,this._rootNodeIndex=1;var e=this._nodes[this._metaNodeIndex];this._nodeTypeOffset=e.fields.indexOf("type"),this._nodeNameOffset=e.fields.indexOf("name"),this._nodeIdOffset=e.fields.indexOf("id"),this._nodeInstancesCountOffset=this._nodeIdOffset,this._nodeSelfSizeOffset=e.fields.indexOf("self_size"),this._nodeRetainedSizeOffset=e.fields.indexOf("retained_size"),this._dominatorOffset=e.fields.indexOf("dominator"),this._edgesCountOffset=e.fields.indexOf("children_count"),this._firstEdgeOffset=e.fields.indexOf("children"),this._nodeTypes=e.types[this._nodeTypeOffset],this._nodeHiddenType=this._nodeTypes.indexOf("hidden");var t=e.types[this._firstEdgeOffset];this._edgeFieldsCount=t.fields.length,this._edgeTypeOffset=t.fields.indexOf("type"),this._edgeNameOffset=t.fields.indexOf("name_or_index"),this._edgeToNodeOffset=t.fields.indexOf("to_node"),this._edgeTypes=t.types[this._edgeTypeOffset],this._edgeElementType=this._edgeTypes.indexOf("element"),this._edgeHiddenType=this._edgeTypes.indexOf("hidden"),this._edgeInternalType=this._edgeTypes.indexOf("internal"),this._edgeShortcutType=this._edgeTypes.indexOf("shortcut")},dispose:function(){delete this._nodes,delete this._strings,this._idsMap&&delete this._idsMap,this._retainers&&(delete this._retainers,delete this._nodesToRetainers),this._aggregates&&(delete this._aggregates,this._aggregatesWithIndexes=!1)},get allNodes(){return new WebInspector.HeapSnapshotNodeIterator(this.rootNode)},get nodesCount(){if(this._nodesCount)return this._nodesCount;this._nodesCount=0;for(var e=this.allNodes;e.hasNext();e.next())++this._nodesCount;return this._nodesCount},restore:function(e){this._nodes=e.nodes,this._strings=e.strings},get rootNode(){return new WebInspector.HeapSnapshotNode(this,this._rootNodeIndex)},get totalSize(){return this.rootNode.retainedSize},get idsMap(){if(this._idsMap)return this._idsMap;this._idsMap=[];for(var e=this.allNodes;e.hasNext();e.next())this._idsMap[e.node.id]=!0;return this._idsMap},retainers:function(e){this._retainers||this._buildRetainers();var t=this._nodesToRetainers[e.nodeIndex],n=this._nodesToRetainers[e._nextNodeIndex];return new WebInspector.HeapSnapshotArraySlice(this,"_retainers",t,n)},aggregates:function(e){return this._aggregates||this._buildAggregates(),e&&!this._aggregatesWithIndexes&&this._buildAggregatesIndexes(),this._aggregates},_buildRetainers:function(){this._nodesToRetainers=[];for(var e=this.allNodes;e.hasNext();e.next()){(n=e.node).nodeIndex in this._nodesToRetainers||(this._nodesToRetainers[n.nodeIndex]=0);for(var t=n.edges;t.hasNext();t.next()){(h=(d=t.edge).nodeIndex)in this._nodesToRetainers||(this._nodesToRetainers[h]=0),this._nodesToRetainers[h]+=this._edgeFieldsCount}}var n=(e=this.allNodes).node,s=this._nodesToRetainers[n.nodeIndex]=0,i=this._nodesToRetainers[n.nodeIndex];for(e.next();e.hasNext();e.next()){n=e.node;var r=this._nodesToRetainers[n.nodeIndex];this._nodesToRetainers[n.nodeIndex]=s+i,s=this._nodesToRetainers[n.nodeIndex],i=r}for(this._retainers=new Array(s+i),this._nodesToRetainers[this._nodes.length]=this._retainers.length,e=this.allNodes;e.hasNext();e.next()){n=e.node;var o=this._nodesToRetainers[n._nextNodeIndex]-this._nodesToRetainers[n.nodeIndex];0<o&&(this._retainers[this._nodesToRetainers[n.nodeIndex]]=o)}for(e=this.allNodes;e.hasNext();e.next())for(t=(n=e.node).edges;t.hasNext();t.next()){var d,h=(d=t.edge).nodeIndex,a=this._nodesToRetainers[h];this._retainers[a]-=this._edgeFieldsCount;var _=a+this._retainers[a];this._retainers[_+this._edgeTypeOffset]=d._type(),this._retainers[_+this._edgeNameOffset]=d._nameOrIndex,this._retainers[_+this._edgeToNodeOffset]=n.nodeIndex}},_buildAggregates:function(){this._aggregates={};for(var e=this.allNodes;e.hasNext();e.next()){var t=e.node,n=t.className,s="object"===t.type;if(0!==t.selfSize){n in this._aggregates||(this._aggregates[n]={count:0,self:0,maxRet:0,type:t.type,name:s?t.name:null,idxs:[]});var i=this._aggregates[n];++i.count,i.self+=t.selfSize,t.retainedSize>i.maxRet&&(i.maxRet=t.retainedSize)}}},_buildAggregatesIndexes:function(){for(var e=this.allNodes;e.hasNext();e.next()){var t=e.node,n=t.className;(r=this._aggregates[n])&&r.idxs.push(t.nodeIndex)}var s=new WebInspector.HeapSnapshotNode(this),i=new WebInspector.HeapSnapshotNode(this);for(var r in this._aggregates)this._aggregates[r].idxs.sort(function(e,t){return s.nodeIndex=e,i.nodeIndex=t,s.id<i.id?-1:1});this._aggregatesWithIndexes=!0}},WebInspector.HeapSnapshotFilteredOrderedIterator=function(e,t,n){this._snapshot=e,this._filter=n,this._iterator=t,this._iterationOrder=null,this._position=0,this._lastComparator=null},WebInspector.HeapSnapshotFilteredOrderedIterator.prototype={_createIterationOrder:function(){this._iterationOrder=[];var e=this._iterator;if(this._filter)for(e.first();e.hasNext();e.next())this._filter(e.item)&&this._iterationOrder.push(e.index);else for(e.first();e.hasNext();e.next())this._iterationOrder.push(e.index)},first:function(){this._position=0},hasNext:function(){return this._position<this._iterationOrder.length},get isEmpty(){if(this._iterationOrder)return!this._iterationOrder.length;var e=this._iterator;if(!this._filter)return e.first(),!e.hasNext();for(e.first();e.hasNext();e.next())if(this._filter(e.item))return!1;return!0},get item(){return this._iterator.index=this._iterationOrder[this._position],this._iterator.item},get lastComparator(){return this._lastComparator},get length(){return this._iterationOrder||this._createIterationOrder(),this._iterationOrder.length},next:function(){++this._position}},WebInspector.HeapSnapshotFilteredOrderedIterator.prototype.createComparator=function(e){return{fieldName1:e[0],ascending1:e[1],fieldName2:e[2],ascending2:e[3]}},WebInspector.HeapSnapshotEdgesProvider=function(e,t,n){WebInspector.HeapSnapshotFilteredOrderedIterator.call(this,e,new WebInspector.HeapSnapshotEdgeIterator(new WebInspector.HeapSnapshotEdge(e,t)),n)},WebInspector.HeapSnapshotEdgesProvider.prototype={sort:function(e){if(this._lastComparator===e)return!1;var s=(this._lastComparator=e).fieldName1,i=e.fieldName2,r=e.ascending1,o=e.ascending2,d=this._iterator.item.clone(),h=d.clone(),a=new WebInspector.HeapSnapshotNode(this._snapshot),_=new WebInspector.HeapSnapshotNode(this._snapshot);function p(e,t,n){if(d.edgeIndex=t,h.edgeIndex=n,"__proto__"===h.name)return-1;if("__proto__"===d.name)return 1;var s=d.hasStringName===h.hasStringName?d.name<h.name?-1:d.name>h.name?1:0:d.hasStringName?-1:1;return e?s:-s}function g(e,t,n,s){d.edgeIndex=n,h.edgeIndex=s,a.nodeIndex=d.nodeIndex,_.nodeIndex=h.nodeIndex;var i=a[e],r=_[e],o=i<r?-1:r<i?1:0;return t?o:-o}return this._iterationOrder||this._createIterationOrder(),"!edgeName"===s?this._iterationOrder.sort(function(e,t){var n=p(r,e,t);return 0===n&&(n=g(i,o,e,t)),n}):"!edgeName"===i?this._iterationOrder.sort(function(e,t){var n=g(s,r,e,t);return 0===n&&(n=p(o,e,t)),n}):this._iterationOrder.sort(function(e,t){var n=g(s,r,e,t);return 0===n&&(n=g(i,o,e,t)),n}),!0}},WebInspector.HeapSnapshotEdgesProvider.prototype.__proto__=WebInspector.HeapSnapshotFilteredOrderedIterator.prototype,WebInspector.HeapSnapshotNodesProvider=function(e,t,n){WebInspector.HeapSnapshotFilteredOrderedIterator.call(this,e,t,n)},WebInspector.HeapSnapshotNodesProvider.prototype={sort:function(e){if(this._lastComparator===e)return!1;var s=(this._lastComparator=e).fieldName1,i=e.fieldName2,r=e.ascending1,o=e.ascending2,d=new WebInspector.HeapSnapshotNode(this._snapshot),h=new WebInspector.HeapSnapshotNode(this._snapshot);function a(e,t,n,s){d.nodeIndex=n,h.nodeIndex=s;var i=d[e],r=h[e],o=i<r?-1:r<i?1:0;return t?o:-o}return this._iterationOrder||this._createIterationOrder(),this._iterationOrder.sort(function(e,t){var n=a(s,r,e,t);return 0===n&&(n=a(i,o,e,t)),n}),!0}},WebInspector.HeapSnapshotNodesProvider.prototype.__proto__=WebInspector.HeapSnapshotFilteredOrderedIterator.prototype,WebInspector.HeapSnapshotPathFinder=function(e,t){this._snapshot=e,this._maxLength=1,this._lengthLimit=15,this._targetNodeIndex=t,this._currentPath=null,this._skipHidden=!WebInspector.DetailedHeapshotView.prototype.showHiddenData,this._rootChildren=this._fillRootChildren()},WebInspector.HeapSnapshotPathFinder.prototype={findNext:function(){for(var e=0;e<1e5;++e){if(!this._buildNextPath()){if(++this._maxLength>=this._lengthLimit)return null;if(this._currentPath=null,!this._buildNextPath())return null}if(this._isPathFound())return{path:this._pathToString(this._currentPath),len:this._currentPath.length}}return!1},_fillRootChildren:function(){for(var e=[],t=this._snapshot.rootNode.edges;t.hasNext();t.next())e[t.edge.nodeIndex]=!0;return e},_appendToCurrentPath:function(e){this._currentPath._cache[this._lastEdge.nodeIndex]=!0,this._currentPath.push(e)},_removeLastFromCurrentPath:function(){this._currentPath.pop(),delete this._currentPath._cache[this._lastEdge.nodeIndex]},_hasInPath:function(e){return this._targetNodeIndex===e||!!this._currentPath._cache[e]},_isPathFound:function(){return this._currentPath.length===this._maxLength&&this._lastEdge.nodeIndex in this._rootChildren},get _lastEdgeIter(){return this._currentPath[this._currentPath.length-1]},get _lastEdge(){return this._lastEdgeIter.edge},_skipEdge:function(e){return this._skipHidden&&(e.isHidden||e.node.isHidden)||this._hasInPath(e.nodeIndex)},_nextEdgeIter:function(){for(var e=this._lastEdgeIter;this._skipEdge(e.edge)&&e.hasNext();)e.next();return e},_buildNextPath:function(){if(null===this._currentPath){var e=new WebInspector.HeapSnapshotNode(this._snapshot,this._targetNodeIndex);for(this._currentPath=[e.retainers],this._currentPath._cache={};this._currentPath.length<this._maxLength;){if(!(t=this._nextEdgeIter()).hasNext())break;this._appendToCurrentPath(t.edge.node.retainers)}return!0}for(var t=this._lastEdgeIter;;){if(t.next(),t.hasNext())return!0;for(;;){if(!(1<this._currentPath.length))return!1;if(this._removeLastFromCurrentPath(),(t=this._lastEdgeIter).next(),(t=this._nextEdgeIter()).hasNext()){for(;this._currentPath.length<this._maxLength;){if(!(t=this._nextEdgeIter()).hasNext())return!0;this._appendToCurrentPath(t.edge.node.retainers)}return!0}}}},_nodeToString:function(e){return 1===e.id?e.name:e.name+"@"+e.id},_pathToString:function(e){if(!e)return"";for(var t=[],n=0;n<e.length;++n)t.push(e[n].edge.toString());return t.push(this._nodeToString(e[e.length-1].edge.node)),t.reverse(),t.join("")}};