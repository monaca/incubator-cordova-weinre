/*
 * Copyright (C) 2009 Google Inc. All rights reserved.
 * Copyright (C) 2010 Apple Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.TextViewer=function(e,t,n){this._textModel=e,this._textModel.changeListener=this._textChanged.bind(this),this.element=document.createElement("div"),this.element.className="text-editor monospace";var i=this._syncScroll.bind(this),s=this._syncDecorationsForLine.bind(this);this._mainPanel=new WebInspector.TextEditorMainPanel(this._textModel,n,i,s),this._gutterPanel=new WebInspector.TextEditorGutterPanel(this._textModel,s),this.element.appendChild(this._mainPanel.element),this.element.appendChild(this._gutterPanel.element)},WebInspector.TextViewer.prototype={set mimeType(e){this._mainPanel.mimeType=e},set readOnly(e){this._mainPanel.readOnly=e},get textModel(){return this._textModel},revealLine:function(e){this._mainPanel.revealLine(e)},addDecoration:function(e,t){this._mainPanel.addDecoration(e,t),this._gutterPanel.addDecoration(e,t)},removeDecoration:function(e,t){this._mainPanel.removeDecoration(e,t),this._gutterPanel.removeDecoration(e,t)},markAndRevealRange:function(e){this._mainPanel.markAndRevealRange(e)},highlightLine:function(e){this._mainPanel.highlightLine(e)},clearLineHighlight:function(){this._mainPanel.clearLineHighlight()},freeCachedElements:function(){this._mainPanel.freeCachedElements(),this._gutterPanel.freeCachedElements()},editLine:function(e,t){this._mainPanel.editLine(e,t)},get scrollTop(){return this._mainPanel.element.scrollTop},set scrollTop(e){this._mainPanel.element.scrollTop=e},get scrollLeft(){return this._mainPanel.element.scrollLeft},set scrollLeft(e){this._mainPanel.element.scrollLeft=e},beginUpdates:function(){this._mainPanel.beginUpdates(),this._gutterPanel.beginUpdates()},endUpdates:function(){this._mainPanel.endUpdates(),this._gutterPanel.endUpdates()},resize:function(){this._mainPanel.resize(),this._gutterPanel.resize(),this._updatePanelOffsets()},
// WebInspector.TextModel listener
_textChanged:function(e,t,n,i){this._mainPanel.textChanged(),this._gutterPanel.textChanged(),this._updatePanelOffsets()},_updatePanelOffsets:function(){var e=this._gutterPanel.element.offsetWidth;e?this._mainPanel.element.style.setProperty("left",e+"px"):this._mainPanel.element.style.removeProperty("left");// Use default value set in CSS.
},_syncScroll:function(){
// Async call due to performance reasons.
setTimeout(function(){var e=this._mainPanel.element,t=this._gutterPanel.element;
// Handle horizontal scroll bar at the bottom of the main panel.
t.offsetHeight>e.clientHeight?t.style.setProperty("padding-bottom",t.offsetHeight-e.clientHeight+"px"):t.style.removeProperty("padding-bottom"),t.scrollTop=e.scrollTop}.bind(this),0)},_syncDecorationsForLine:function(e){if(!(e>=this._textModel.linesCount)){var t=this._mainPanel.makeLineAChunk(e),n=this._gutterPanel.makeLineAChunk(e),i=t.height;i?n.element.style.setProperty("height",i+"px"):n.element.style.removeProperty("height")}}},WebInspector.TextEditorChunkedPanel=function(e){this._textModel=e,this._defaultChunkSize=50,this._paintCoalescingLevel=0,this._domUpdateCoalescingLevel=0},WebInspector.TextEditorChunkedPanel.prototype={get textModel(){return this._textModel},revealLine:function(e){e>=this._textModel.linesCount||this.makeLineAChunk(e).element.scrollIntoViewIfNeeded()},addDecoration:function(e,t){this.makeLineAChunk(e).addDecoration(t)},removeDecoration:function(e,t){this.makeLineAChunk(e).removeDecoration(t)},textChanged:function(e,t,n,i){this._buildChunks()},_buildChunks:function(){this.beginDomUpdates(),this.element.removeChildren(),this._textChunks=[];for(var e=0;e<this._textModel.linesCount;e+=this._defaultChunkSize){var t=this._createNewChunk(e,e+this._defaultChunkSize);this._textChunks.push(t),this.element.appendChild(t.element)}this._repaintAll(),this.endDomUpdates()},makeLineAChunk:function(e){this._textChunks||this._buildChunks();var t=this._chunkNumberForLine(e),n=this._textChunks[t];if(1===n.linesCount)return n;this.beginDomUpdates();var i=n.expanded;n.expanded=!1;var s=t+1;
// Prefix chunk.
if(e>n.startLine){var r=this._createNewChunk(n.startLine,e);this._textChunks.splice(s++,0,r),this.element.insertBefore(r.element,n.element)}
// Line chunk.
var o=this._createNewChunk(e,e+1);
// Suffix chunk.
if(this._textChunks.splice(s++,0,o),this.element.insertBefore(o.element,n.element),n.startLine+n.linesCount>e+1){var h=this._createNewChunk(e+1,n.startLine+n.linesCount);this._textChunks.splice(s,0,h),this.element.insertBefore(h.element,n.element)}
// Remove enclosing chunk.
return this._textChunks.splice(t,1),this.element.removeChild(n.element),i&&(r&&(r.expanded=!0),o.expanded=!0,h&&(h.expanded=!0)),this.endDomUpdates(),o},_scroll:function(){this._scheduleRepaintAll(),this._syncScrollListener&&this._syncScrollListener()},_scheduleRepaintAll:function(){this._repaintAllTimer&&clearTimeout(this._repaintAllTimer),this._repaintAllTimer=setTimeout(this._repaintAll.bind(this),50)},beginUpdates:function(){this._paintCoalescingLevel++},endUpdates:function(){this._paintCoalescingLevel--,this._paintCoalescingLevel||this._repaintAll()},beginDomUpdates:function(){this._domUpdateCoalescingLevel++},endDomUpdates:function(){this._domUpdateCoalescingLevel--},_chunkNumberForLine:function(e){for(var t=0;t<this._textChunks.length;++t){var n=this._textChunks[t].startLine;if(n<=e&&e<n+this._textChunks[t].linesCount)return t}return this._textChunks.length-1},_chunkForLine:function(e){return this._textChunks[this._chunkNumberForLine(e)]},_repaintAll:function(){if(delete this._repaintAllTimer,!this._paintCoalescingLevel&&!this._dirtyLines){this._textChunks||this._buildChunks();for(var e=this.element.scrollTop,t=this.element.scrollTop+this.element.clientHeight,n=0,i=-1,s=0,r=0;r<this._textChunks.length;++r){var o=this._textChunks[r].height;if(e<n+o&&n<t)-1===i&&(i=r),s=r+1;else if(t<=n)break;n+=o}s&&this._expandChunks(i,s)}},_totalHeight:function(e,t){return(t=(t||e).nextElementSibling)?t.offsetTop-e.offsetTop:e.offsetParent?e.offsetParent.scrollHeight-e.offsetTop:e.offsetHeight},resize:function(){this._repaintAll()}},WebInspector.TextEditorGutterPanel=function(e,t){WebInspector.TextEditorChunkedPanel.call(this,e),this._syncDecorationsForLineListener=t,this.element=document.createElement("div"),this.element.className="text-editor-lines",this.element.addEventListener("scroll",this._scroll.bind(this),!1),this.freeCachedElements(),this._buildChunks()},WebInspector.TextEditorGutterPanel.prototype={freeCachedElements:function(){this._cachedRows=[]},_createNewChunk:function(e,t){return new WebInspector.TextEditorGutterChunk(this,e,t)},_expandChunks:function(e,t){for(var n=0;n<this._textChunks.length;++n)this._textChunks[n].expanded=e<=n&&n<t}},WebInspector.TextEditorGutterPanel.prototype.__proto__=WebInspector.TextEditorChunkedPanel.prototype,WebInspector.TextEditorGutterChunk=function(e,t,n){if(this._textViewer=e,this._textModel=e._textModel,this.startLine=t,n=Math.min(this._textModel.linesCount,n),this.linesCount=n-t,this._expanded=!1,this.element=document.createElement("div"),this.element.lineNumber=t,this.element.className="webkit-line-number",1===this.linesCount){
// Single line chunks are typically created for decorations. Host line number in
// the sub-element in order to allow flexible border / margin management.
var i=document.createElement("span");i.className="webkit-line-number-inner",i.textContent=t+1;var s=document.createElement("div");s.className="webkit-line-number-outer",s.appendChild(i),this.element.appendChild(s)}else{for(var r=[],o=t;o<n;++o)r.push(o+1);this.element.textContent=r.join("\n")}},WebInspector.TextEditorGutterChunk.prototype={addDecoration:function(e){"string"==typeof e&&this.element.addStyleClass(e)},removeDecoration:function(e){"string"==typeof e&&this.element.removeStyleClass(e)},get expanded(){return this._expanded},set expanded(e){if(1===this.linesCount&&this._textViewer._syncDecorationsForLineListener(this.startLine),this._expanded!==e&&(this._expanded=e,1!==this.linesCount)){if(this._textViewer.beginDomUpdates(),e){this._expandedLineRows=[];for(var t=this.element.parentElement,n=this.startLine;n<this.startLine+this.linesCount;++n){var i=this._createRow(n);t.insertBefore(i,this.element),this._expandedLineRows.push(i)}t.removeChild(this.element)}else{var s=!1;for(n=0;n<this._expandedLineRows.length;++n){(t=(i=this._expandedLineRows[n]).parentElement)&&(s||(s=!0,t.insertBefore(this.element,i)),t.removeChild(i)),this._textViewer._cachedRows.push(i)}delete this._expandedLineRows}this._textViewer.endDomUpdates()}},get height(){return this._expandedLineRows?this._textViewer._totalHeight(this._expandedLineRows[0],this._expandedLineRows[this._expandedLineRows.length-1]):this._textViewer._totalHeight(this.element)},_createRow:function(e){var t=this._textViewer._cachedRows.pop()||document.createElement("div");return t.lineNumber=e,t.className="webkit-line-number",t.textContent=e+1,t}},WebInspector.TextEditorMainPanel=function(e,t,n,i){WebInspector.TextEditorChunkedPanel.call(this,e),this._syncScrollListener=n,this._syncDecorationsForLineListener=i,this._url=t,this._highlighter=new WebInspector.TextEditorHighlighter(e,this._highlightDataReady.bind(this)),this._readOnly=!0,this.element=document.createElement("div"),this.element.className="text-editor-contents",this.element.tabIndex=0,this.element.addEventListener("scroll",this._scroll.bind(this),!1),
// FIXME: Remove old live editing functionality and Preferences.sourceEditorEnabled flag.
Preferences.sourceEditorEnabled||this.element.addEventListener("keydown",this._handleKeyDown.bind(this),!1);var s=this._handleDOMUpdates.bind(this);this.element.addEventListener("DOMCharacterDataModified",s,!1),this.element.addEventListener("DOMNodeInserted",s,!1),this.element.addEventListener("DOMNodeRemoved",s,!1),
// For some reasons, in a few corner cases the events above are not able to catch the editings.
// To workaround that we also listen to a more general event as a backup.
this.element.addEventListener("DOMSubtreeModified",this._handleDOMSubtreeModified.bind(this),!1),this.freeCachedElements(),this._buildChunks()},WebInspector.TextEditorMainPanel.prototype={set mimeType(e){this._highlighter.mimeType=e},set readOnly(e){
// FIXME: Remove the Preferences.sourceEditorEnabled flag.
Preferences.sourceEditorEnabled&&(this._readOnly=e,this._readOnly?this.element.removeStyleClass("text-editor-editable"):this.element.addStyleClass("text-editor-editable"))},markAndRevealRange:function(e){if(this._rangeToMark){var t=this._rangeToMark.startLine;this._rangeToMark=null,this._paintLines(t,t+1)}e&&(this._rangeToMark=e,this.revealLine(e.startLine),this._paintLines(e.startLine,e.startLine+1),this._markedRangeElement&&this._markedRangeElement.scrollIntoViewIfNeeded()),delete this._markedRangeElement},highlightLine:function(e){this.clearLineHighlight(),this._highlightedLine=e,this.revealLine(e),this.addDecoration(e,"webkit-highlighted-line")},clearLineHighlight:function(){"number"==typeof this._highlightedLine&&(this.removeDecoration(this._highlightedLine,"webkit-highlighted-line"),delete this._highlightedLine)},freeCachedElements:function(){this._cachedSpans=[],this._cachedTextNodes=[],this._cachedRows=[]},_handleKeyDown:function(){if(!(this._editingLine||event.metaKey||event.shiftKey||event.ctrlKey||event.altKey)){var e=0;if(event.keyCode===WebInspector.KeyboardShortcut.Keys.Up.code?e=-1:event.keyCode==WebInspector.KeyboardShortcut.Keys.Down.code&&(e=1),e)return event.preventDefault(),event.stopPropagation(),void this.element.scrollByLines(e);e=0,event.keyCode===WebInspector.KeyboardShortcut.Keys.Left.code?e=-40:event.keyCode==WebInspector.KeyboardShortcut.Keys.Right.code&&(e=40),e&&(event.preventDefault(),event.stopPropagation(),this.element.scrollLeft+=e)}},editLine:function(i,s){var r=i.innerHTML;function e(e,t,n){e&&s(n),i.innerHTML=r,delete this._editingLine}this._editingLine=WebInspector.startEditing(i,{context:null,commitHandler:e.bind(this,!0),cancelHandler:e.bind(this,!1),multiline:!0})},_buildChunks:function(){this._highlighter.reset();for(var e=0;e<this._textModel.linesCount;++e)this._textModel.removeAttribute(e,"highlight");WebInspector.TextEditorChunkedPanel.prototype._buildChunks.call(this)},_createNewChunk:function(e,t){return new WebInspector.TextEditorMainChunk(this,e,t)},_expandChunks:function(e,t){var n=this._textChunks[t-1],i=n.startLine+n.linesCount,s=this._getSelection();this._muteHighlightListener=!0,this._highlighter.highlight(i),delete this._muteHighlightListener;for(var r=0;r<this._textChunks.length;++r)this._textChunks[r].expanded=e<=r&&r<t;this._restoreSelection(s)},_highlightDataReady:function(e,t){this._muteHighlightListener||this._dirtyLines||this._paintLines(e,t,!0/*restoreSelection*/)},_paintLines:function(e,t,n){for(var i,s=this._chunkForLine(e),r=e;r<t;++r){r>=s.startLine+s.linesCount&&(s=this._chunkForLine(r));var o=s.getExpandedLineRow(r);o&&(n&&!i&&(i=this._getSelection()),this._paintLine(o,r))}n&&this._restoreSelection(i)},_paintLine:function(e,t){this.beginDomUpdates();try{var n=this._textModel.getAttribute(t,"highlight");if(!n)return void(this._rangeToMark&&this._rangeToMark.startLine===t&&(this._markedRangeElement=highlightSearchResult(e,this._rangeToMark.startColumn,this._rangeToMark.endColumn-this._rangeToMark.startColumn)));e.removeChildren();var i=this._textModel.line(t);i||e.appendChild(document.createElement("br"));for(var s=-1,r=0;r<i.length;){if(1e3<r){
// This line is too long - do not waste cycles on minified js highlighting.
-1===s&&(s=r);break}var o=n[r];o&&o.tokenType?(-1!==s&&(this._appendTextNode(e,i.substring(s,r)),s=-1),this._appendSpan(e,i.substring(r,r+o.length),o.tokenType),r+=o.length):(-1===s&&(s=r),r++)}-1!==s&&this._appendTextNode(e,i.substring(s,i.length)),this._rangeToMark&&this._rangeToMark.startLine===t&&(this._markedRangeElement=highlightSearchResult(e,this._rangeToMark.startColumn,this._rangeToMark.endColumn-this._rangeToMark.startColumn)),e.decorationsElement&&e.appendChild(e.decorationsElement)}finally{this.endDomUpdates()}},_releaseLinesHighlight:function(e){if(e){if("spans"in e){for(var t=e.spans,n=0;n<t.length;++n)this._cachedSpans.push(t[n]);delete e.spans}if("textNodes"in e){var i=e.textNodes;for(n=0;n<i.length;++n)this._cachedTextNodes.push(i[n]);delete e.textNodes}this._cachedRows.push(e)}},_getSelection:function(){var e=window.getSelection();if(!e.rangeCount)return null;var t=e.getRangeAt(0);
// Selection may be outside of the viewer.
if(!this.element.isAncestor(t.startContainer)||!this.element.isAncestor(t.endContainer))return null;var n=this._selectionToPosition(t.startContainer,t.startOffset),i=t.collapsed?n:this._selectionToPosition(t.endContainer,t.endOffset);return e.anchorNode===t.startContainer&&e.anchorOffset===t.startOffset?new WebInspector.TextRange(n.line,n.column,i.line,i.column):new WebInspector.TextRange(i.line,i.column,n.line,n.column)},_restoreSelection:function(e){if(e){var t=this._positionToSelection(e.startLine,e.startColumn),n=e.isEmpty()?t:this._positionToSelection(e.endLine,e.endColumn);window.getSelection().setBaseAndExtent(t.container,t.offset,n.container,n.offset)}},_selectionToPosition:function(e,t){if(e===this.element&&0===t)return{line:0,column:0};if(e===this.element&&1===t)return{line:this._textModel.linesCount-1,column:this._textModel.lineLength(this._textModel.linesCount-1)};var n=e.enclosingNodeOrSelfWithNodeName("DIV"),i=n.lineNumber;if(e===n&&0===t)return{line:i,column:0};
// This may be chunk and chunks may contain \n.
for(var s=0,r=n.traverseNextTextNode(n);r&&r!==e;){for(var o=r.textContent,h=0;h<o.length;++h)"\n"===o.charAt(h)?(i++,s=0):s++;r=r.traverseNextTextNode(n)}if(r===e&&t)for(o=r.textContent,h=0;h<t;++h)"\n"===o.charAt(h)?(i++,s=0):s++;return{line:i,column:s}},_positionToSelection:function(e,t){var n=this._chunkForLine(e),i=n.getExpandedLineRow(e);if(i)var s=i.rangeBoundaryForOffset(t);else{for(var r=t,o=n.startLine;o<e;++o)r+=this._textModel.lineLength(o)+1;// \n
if((i=n.element).firstChild)s={container:i.firstChild,offset:r};else s={container:i,offset:0}}return s},_appendSpan:function(e,t,n){if("html-resource-link"!==n&&"html-external-link"!==n){var i=this._cachedSpans.pop()||document.createElement("span");i.className="webkit-"+n,i.textContent=t,e.appendChild(i),"spans"in e||(e.spans=[]),e.spans.push(i)}else e.appendChild(this._createLink(t,"html-external-link"===n))},_appendTextNode:function(e,t){var n=this._cachedTextNodes.pop();n?n.nodeValue=t:n=document.createTextNode(t),e.appendChild(n),"textNodes"in e||(e.textNodes=[]),e.textNodes.push(n)},_createLink:function(e,t){var n=e.charAt(0);1<e.length&&('"'===n||"'"===n)?e=e.substring(1,e.length-1):n=null;var i=WebInspector.linkifyURLAsNode(this._rewriteHref(e),e,null,t),s=document.createElement("span");return s.className="webkit-html-attribute-value",n&&s.appendChild(document.createTextNode(n)),s.appendChild(i),n&&s.appendChild(document.createTextNode(n)),s},_rewriteHref:function(e,t){return!this._url||!e||0<e.indexOf("://")?e:WebInspector.completeURL(this._url,e)},textChanged:function(e,t,n,i){
// FIXME: Update only that part of the editor that has just been changed.
this._buildChunks()},_handleDOMUpdates:function(e){if(!this._domUpdateCoalescingLevel){var t=e.target;if(t!==this.element){var n=t.enclosingNodeOrSelfWithClass("webkit-line-content");if(n)if(n.decorationsElement&&n.decorationsElement.isAncestor(t))this._syncDecorationsForLineListener&&
// Wait until this event is processed and only then sync the sizes. This is necessary in
// case of the DOMNodeRemoved event, because it is dispatched before the removal takes place.
setTimeout(function(){this._syncDecorationsForLineListener(n.lineNumber)}.bind(this),0);else if(!this._readOnly){t!==n||"DOMNodeInserted"!==e.type&&"DOMNodeRemoved"!==e.type||
// The "lineNumber" (if any) is no longer valid for a line being removed or inserted.
delete n.lineNumber;for(var i=0,s=n;s;s=s.previousSibling)if("number"==typeof s.lineNumber){i=s.lineNumber;break}var r=this._textModel.linesCount;for(s=n.nextSibling;s;s=s.nextSibling)if("number"==typeof s.lineNumber){r=s.lineNumber;break}this._dirtyLines?(this._dirtyLines.start=Math.min(this._dirtyLines.start,i),this._dirtyLines.end=Math.max(this._dirtyLines.end,r)):(this._dirtyLines={start:i,end:r},setTimeout(this._applyDomUpdates.bind(this),0))}}}},_handleDOMSubtreeModified:function(e){if(!this._domUpdateCoalescingLevel&&!this._readOnly&&e.target===this.element&&!this._dirtyLines)
// Proceed only when other events failed to catch the DOM updates, otherwise it is not necessary.
{var t=this._getSelection();if(t){var n=Math.min(t.startLine,t.endLine),i=Math.max(t.startLine,t.endLine)+1;i=Math.min(this._textModel.linesCount,i),this._dirtyLines={start:n,end:i},setTimeout(this._applyDomUpdates.bind(this),0)}}},_applyDomUpdates:function(){if(this._dirtyLines){var e=this._dirtyLines;
// Check if the editor had been set readOnly by the moment when this async callback got executed.
if(delete this._dirtyLines,!this._readOnly){
// FIXME: DELETE DECORATIONS IN THE INVOLVED CHUNKS IF ANY! SYNC THE GUTTER ALSO.
// FIXME: DELETE MARKED AND HIGHLIGHTED LINES (INVALIDATE SEARCH RESULTS)! this._markedRangeElement
var t,n=this._chunkNumberForLine(e.start),i=this._textChunks[n].startLine,s=this._textModel.linesCount;if(n){var r=this._textChunks[n-1];t=(t=r.expanded?r.getExpandedLineRow(r.startLine+r.linesCount-1):r.element).nextSibling}else t=this.element.firstChild;for(var o=[],h=t;h;h=h.nextSibling){if("number"==typeof h.lineNumber&&h.lineNumber>=e.end){s=h.lineNumber;break}
// Update with the newest lineNumber, so that the call to the _getSelection method below should work.
h.lineNumber=i+o.length,this._collectLinesFromDiv(o,h)}
// Try to decrease the range being replaced if possible.
for(var l=0;i<e.start&&l<o.length&&this._textModel.line(i)===o[l];)++l,++i;for(var a=o.length;s>e.end&&l<a&&this._textModel.line(s-1)===o[a-1];)--a,--s;o=o.slice(l,a);var d=this._getSelection();if(this.beginUpdates(),0===o.length&&s<this._textModel.linesCount){var c=new WebInspector.TextRange(i,0,s,0);this._textModel.setText(c,"")}else c=new WebInspector.TextRange(i,0,s-1,this._textModel.lineLength(s-1)),this._textModel.setText(c,o.join("\n"));this.endUpdates(),this._restoreSelection(d)}}},_collectLinesFromDiv:function(e,t){for(var n=[],i=t.traverseNextNode(t);i;)"br"===i.nodeName.toLowerCase()?n.push("\n"):i.nodeType===Node.TEXT_NODE&&n.push(i.textContent),i=i.traverseNextNode(t);var s=n.join("");
// The last \n (if any) does not "count" in a DIV.
n=(s=s.replace(/\n$/,"")).split("\n");for(var r=0;r<n.length;++r)e.push(n[r])}},WebInspector.TextEditorMainPanel.prototype.__proto__=WebInspector.TextEditorChunkedPanel.prototype,WebInspector.TextEditorMainChunk=function(e,t,n){this._textViewer=e,this._textModel=e._textModel,this.element=document.createElement("div"),this.element.lineNumber=t,this.element.className="webkit-line-content",this.startLine=t,n=Math.min(this._textModel.linesCount,n),this.linesCount=n-t,this._expanded=!1;for(var i=[],s=t;s<n;++s)i.push(this._textModel.line(s));this.element.textContent=i.join("\n"),
// The last empty line will get swallowed otherwise.
i[i.length-1]||this.element.appendChild(document.createElement("br"))},WebInspector.TextEditorMainChunk.prototype={addDecoration:function(e){"string"!=typeof e?(this._textViewer.beginDomUpdates(),this.element.decorationsElement||(this.element.decorationsElement=document.createElement("div"),this.element.decorationsElement.className="webkit-line-decorations",this.element.appendChild(this.element.decorationsElement)),this.element.decorationsElement.appendChild(e),this._textViewer.endDomUpdates()):this.element.addStyleClass(e)},removeDecoration:function(e){"string"!=typeof e?this.element.decorationsElement&&(this._textViewer.beginDomUpdates(),this.element.decorationsElement.removeChild(e),this._textViewer.endDomUpdates()):this.element.removeStyleClass(e)},get expanded(){return this._expanded},set expanded(e){if(this._expanded!==e)if(this._expanded=e,1!==this.linesCount){if(this._textViewer.beginDomUpdates(),e){this._expandedLineRows=[];for(var t=this.element.parentElement,n=this.startLine;n<this.startLine+this.linesCount;++n){var i=this._createRow(n);t.insertBefore(i,this.element),this._expandedLineRows.push(i),this._textViewer._paintLine(i,n)}t.removeChild(this.element)}else{var s=!1;for(n=0;n<this._expandedLineRows.length;++n){(t=(i=this._expandedLineRows[n]).parentElement)&&(s||(s=!0,t.insertBefore(this.element,i)),t.removeChild(i)),this._textViewer._releaseLinesHighlight(i)}delete this._expandedLineRows}this._textViewer.endDomUpdates()}else e&&this._textViewer._paintLine(this.element,this.startLine)},get height(){return this._expandedLineRows?this._textViewer._totalHeight(this._expandedLineRows[0],this._expandedLineRows[this._expandedLineRows.length-1]):this._textViewer._totalHeight(this.element)},_createRow:function(e){var t=this._textViewer._cachedRows.pop()||document.createElement("div");return t.lineNumber=e,t.className="webkit-line-content",t.textContent=this._textModel.line(e),t.textContent||t.appendChild(document.createElement("br")),t},getExpandedLineRow:function(e){return!this._expanded||e<this.startLine||e>=this.startLine+this.linesCount?null:this._expandedLineRows?this._expandedLineRows[e-this.startLine]:this.element}};