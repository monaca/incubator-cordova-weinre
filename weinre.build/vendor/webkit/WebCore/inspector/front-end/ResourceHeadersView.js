/*
 * Copyright (C) 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) IBM Corp. 2009  All rights reserved.
 * Copyright (C) 2010 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer. 
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution. 
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission. 
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.ResourceHeadersView=function(e){WebInspector.View.call(this),this.element.addStyleClass("resource-headers-view"),this._resource=e,this._headersListElement=document.createElement("ol"),this._headersListElement.className="outline-disclosure",this.element.appendChild(this._headersListElement),this._headersTreeOutline=new TreeOutline(this._headersListElement),this._headersTreeOutline.expandTreeElementsWhenArrowing=!0,this._urlTreeElement=new TreeElement("",null,!1),this._urlTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._urlTreeElement),this._requestMethodTreeElement=new TreeElement("",null,!1),this._requestMethodTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._requestMethodTreeElement),this._statusCodeTreeElement=new TreeElement("",null,!1),this._statusCodeTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._statusCodeTreeElement),this._requestHeadersTreeElement=new TreeElement("",null,!0),this._requestHeadersTreeElement.expanded=!0,this._requestHeadersTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._requestHeadersTreeElement),this._decodeHover=WebInspector.UIString("Double-Click to toggle between URL encoded and decoded formats"),this._decodeRequestParameters=!0,this._queryStringTreeElement=new TreeElement("",null,!0),this._queryStringTreeElement.expanded=!0,this._queryStringTreeElement.selectable=!1,this._queryStringTreeElement.hidden=!0,this._headersTreeOutline.appendChild(this._queryStringTreeElement),this._formDataTreeElement=new TreeElement("",null,!0),this._formDataTreeElement.expanded=!0,this._formDataTreeElement.selectable=!1,this._formDataTreeElement.hidden=!0,this._headersTreeOutline.appendChild(this._formDataTreeElement),this._requestPayloadTreeElement=new TreeElement(WebInspector.UIString("Request Payload"),null,!0),this._requestPayloadTreeElement.expanded=!0,this._requestPayloadTreeElement.selectable=!1,this._requestPayloadTreeElement.hidden=!0,this._headersTreeOutline.appendChild(this._requestPayloadTreeElement),this._responseHeadersTreeElement=new TreeElement("",null,!0),this._responseHeadersTreeElement.expanded=!0,this._responseHeadersTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._responseHeadersTreeElement),e.addEventListener("requestHeaders changed",this._refreshRequestHeaders,this),e.addEventListener("responseHeaders changed",this._refreshResponseHeaders,this),e.addEventListener("finished",this._refreshHTTPInformation,this),this._refreshURL(),this._refreshQueryString(),this._refreshRequestHeaders(),this._refreshResponseHeaders(),this._refreshHTTPInformation()},WebInspector.ResourceHeadersView.prototype={_refreshURL:function(){this._urlTreeElement.titleHTML='<div class="header-name">'+WebInspector.UIString("Request URL")+':</div><div class="header-value source-code">'+this._resource.url.escapeHTML()+"</div>"},_refreshQueryString:function(){var e=this._resource.queryParameters;this._queryStringTreeElement.hidden=!e,e&&this._refreshParms(WebInspector.UIString("Query String Parameters"),e,this._queryStringTreeElement)},_refreshFormData:function(){this._formDataTreeElement.hidden=!0,this._requestPayloadTreeElement.hidden=!0;var e=this._resource.requestFormData;if(e){var s=this._resource.formParameters;s?(this._formDataTreeElement.hidden=!1,this._refreshParms(WebInspector.UIString("Form Data"),s,this._formDataTreeElement)):(this._requestPayloadTreeElement.hidden=!1,this._refreshRequestPayload(e))}},_refreshRequestPayload:function(e){this._requestPayloadTreeElement.removeChildren();var s='<div class="raw-form-data header-value source-code">'+e.escapeHTML()+"</div>",t=new TreeElement(null,null,!1);t.titleHTML=s,t.selectable=!1,this._requestPayloadTreeElement.appendChild(t)},_refreshParms:function(e,s,t){t.removeChildren(),t.titleHTML=e+'<span class="header-count">'+WebInspector.UIString(" (%d)",s.length)+"</span>";for(var r=0;r<s.length;++r){var a=s[r].name,n=s[r].value,i=!1;if(this._decodeRequestParameters){if(0<=n.indexOf("%"))try{n=decodeURIComponent(n)}catch(e){i=!0}n=n.replace(/\+/g," ")}valueEscaped=n.escapeHTML(),i&&(valueEscaped+=' <span class="error-message">'+WebInspector.UIString("(unable to decode value)").escapeHTML()+"</span>");e='<div class="header-name">'+a.escapeHTML()+":</div>";e+='<div class="header-value source-code">'+valueEscaped+"</div>";var l=new TreeElement(null,null,!1);l.titleHTML=e,l.selectable=!1,l.tooltip=this._decodeHover,l.ondblclick=this._toggleURLdecoding.bind(this),t.appendChild(l)}},_toggleURLdecoding:function(e){this._decodeRequestParameters=!this._decodeRequestParameters,this._refreshQueryString(),this._refreshFormData()},_getHeaderValue:function(e,s){var t=s.toLowerCase();for(var r in e)if(r.toLowerCase()===t)return e[r]},_refreshRequestHeaders:function(){var e=null;void 0!==this._resource.webSocketRequestKey3&&(e={header:"(Key3)",value:this._resource.webSocketRequestKey3}),this._refreshHeaders(WebInspector.UIString("Request Headers"),this._resource.sortedRequestHeaders,e,this._requestHeadersTreeElement),this._refreshFormData()},_refreshResponseHeaders:function(){var e=null;void 0!==this._resource.webSocketChallengeResponse&&(e={header:"(Challenge Response)",value:this._resource.webSocketChallengeResponse}),this._refreshHeaders(WebInspector.UIString("Response Headers"),this._resource.sortedResponseHeaders,e,this._responseHeadersTreeElement)},_refreshHTTPInformation:function(){var e=this._requestMethodTreeElement;e.hidden=!this._resource.statusCode;var s=this._statusCodeTreeElement;s.hidden=!this._resource.statusCode;var t="";if(this._resource.statusCode){var r="";r=this._resource.statusCode<300||304===this._resource.statusCode?"Images/successGreenDot.png":this._resource.statusCode<400?"Images/warningOrangeDot.png":"Images/errorRedDot.png";var a=this._resource.statusCode+" "+this._resource.statusText.escapeHTML();t='<img class="resource-status-image" src="'+r+'" title="'+a+'">',e.titleHTML='<div class="header-name">'+WebInspector.UIString("Request Method")+':</div><div class="header-value source-code">'+this._resource.requestMethod+"</div>",s.titleHTML='<div class="header-name">'+WebInspector.UIString("Status Code")+":</div>"+t+'<div class="header-value source-code">'+a+"</div>"}},_refreshHeaders:function(e,s,t,r){r.removeChildren();var a=s.length;r.titleHTML=e.escapeHTML()+'<span class="header-count">'+WebInspector.UIString(" (%d)",a)+"</span>",r.hidden=!a;a=s.length;for(var n=0;n<a;++n){e='<div class="header-name">'+s[n].header.escapeHTML()+":</div>";e+='<div class="header-value source-code">'+s[n].value.escapeHTML()+"</div>",(i=new TreeElement(null,null,!1)).titleHTML=e,i.selectable=!1,r.appendChild(i)}if(t){var i;e='<div class="header-name">'+t.header.escapeHTML()+":</div>";e+='<div class="header-value source-code">'+t.value.escapeHTML()+"</div>",(i=new TreeElement(null,null,!1)).titleHTML=e,i.selectable=!1,r.appendChild(i)}}},WebInspector.ResourceHeadersView.prototype.__proto__=WebInspector.View.prototype;