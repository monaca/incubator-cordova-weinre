/*
 * Copyright (C) 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) 2008, 2009 Anthony Ricaud <rik@webkit.org>
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.NetworkPanel=function(){WebInspector.Panel.call(this,"network"),this.createSidebar(),this.sidebarElement.className="network-sidebar",this._resources=[],this._resourcesById={},this._resourcesByURL={},this._staleResources=[],this._resourceGridNodes={},this._mainResourceLoadTime=-1,this._mainResourceDOMContentTime=-1,this._hiddenCategories={},this._categories=WebInspector.resourceCategories,this.containerElement=document.createElement("div"),this.containerElement.id="network-container",this.sidebarElement.appendChild(this.containerElement),this._viewsContainerElement=document.createElement("div"),this._viewsContainerElement.id="network-views",this._viewsContainerElement.className="hidden",this.element.appendChild(this._viewsContainerElement),this._closeButtonElement=document.createElement("button"),this._closeButtonElement.id="network-close-button",this._closeButtonElement.addEventListener("click",this._toggleGridMode.bind(this),!1),this._viewsContainerElement.appendChild(this._closeButtonElement),this._createSortingFunctions(),this._createTable(),this._createTimelineGrid(),this._createStatusbarButtons(),this._createFilterStatusBarItems(),this._createSummaryBar(),WebInspector.settings.resourcesLargeRows||this._setLargerResources(WebInspector.settings.resourcesLargeRows),this._popoverHelper=new WebInspector.PopoverHelper(this.element,this._getPopoverAnchor.bind(this),this._showPopover.bind(this),!0),
// Enable faster hint.
this._popoverHelper.setTimeout(100),this.calculator=new WebInspector.NetworkTransferTimeCalculator,this._filter(this._filterAllElement,!1),this._toggleGridMode(),WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.ResourceStarted,this._onResourceStarted,this),WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.ResourceUpdated,this._onResourceUpdated,this),WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.ResourceFinished,this._onResourceUpdated,this),WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.MainResourceCommitLoad,this._onMainResourceCommitLoad,this)},WebInspector.NetworkPanel.prototype={get toolbarItemLabel(){return WebInspector.UIString("Network")},get statusBarItems(){return[this._largerResourcesButton.element,this._preserveLogToggle.element,this._clearButton.element,this._filterBarElement]},isCategoryVisible:function(e){return!0},elementsToRestoreScrollPositionsFor:function(){return[this.containerElement,this._dataGrid.scrollContainer]},resize:function(){WebInspector.Panel.prototype.resize.call(this),this._dataGrid.updateWidths(),this._positionSummaryBar()},updateSidebarWidth:function(e){this._viewingResourceMode&&WebInspector.Panel.prototype.updateSidebarWidth.call(this,e)},updateMainViewWidth:function(e){this._viewsContainerElement.style.left=e+"px"},handleShortcut:function(e){this._viewingResourceMode&&e.keyCode===WebInspector.KeyboardShortcut.Keys.Esc.code&&(this._toggleGridMode(),e.handled=!0)},_positionSummaryBar:function(){
// Position the total bar.
var e=this._dataGrid.dataTableBody.lastChild;if(this._summaryBarElement.parentElement!==this.element&&0<e.offsetHeight)
// Glue status to bottom.
return this._summaryBarRowNode&&(this._dataGrid.removeChild(this._summaryBarRowNode),delete this._summaryBarRowNode),this._summaryBarElement.addStyleClass("network-summary-bar-bottom"),this.element.appendChild(this._summaryBarElement),void(this._dataGrid.element.style.bottom="20px");this._summaryBarRowNode||e.offsetHeight||(
// Glue status to table.
this._summaryBarRowNode=new WebInspector.NetworkTotalGridNode(this._summaryBarElement),this._summaryBarElement.removeStyleClass("network-summary-bar-bottom"),this._dataGrid.appendChild(this._summaryBarRowNode),this._dataGrid.element.style.bottom=0,this._sortItems()),this._updateOffscreenRows()},_resetSummaryBar:function(){delete this._summaryBarRowNode,this._summaryBarElement.parentElement.removeChild(this._summaryBarElement),this._updateSummaryBar()},_createTimelineGrid:function(){this._timelineGrid=new WebInspector.TimelineGrid,this._timelineGrid.element.addStyleClass("network-timeline-grid"),this._dataGrid.element.appendChild(this._timelineGrid.element)},_createTable:function(){var e={name:{},method:{},status:{},type:{},size:{},time:{},timeline:{}};e.name.titleDOMFragment=this._makeHeaderFragment(WebInspector.UIString("Name"),WebInspector.UIString("Path")),e.name.sortable=!0,e.name.width="20%",e.name.disclosure=!0,e.method.title=WebInspector.UIString("Method"),e.method.sortable=!0,e.method.width="7%",e.status.titleDOMFragment=this._makeHeaderFragment(WebInspector.UIString("Status"),WebInspector.UIString("Text")),e.status.sortable=!0,e.status.width="8%",e.type.title=WebInspector.UIString("Type"),e.type.sortable=!0,e.type.width="10%",e.size.titleDOMFragment=this._makeHeaderFragment(WebInspector.UIString("Size"),WebInspector.UIString("Transfer")),e.size.sortable=!0,e.size.width="10%",e.size.aligned="right",e.time.titleDOMFragment=this._makeHeaderFragment(WebInspector.UIString("Time"),WebInspector.UIString("Latency")),e.time.sortable=!0,e.time.width="10%",e.time.aligned="right",e.timeline.title="",e.timeline.sortable=!1,e.timeline.width="37%",e.timeline.sort="ascending",this._dataGrid=new WebInspector.DataGrid(e),this._dataGrid.element.addEventListener("contextmenu",this._contextMenu.bind(this),!0),this.containerElement.appendChild(this._dataGrid.element),this._dataGrid.addEventListener("sorting changed",this._sortItems,this),this._dataGrid.addEventListener("width changed",this._updateDividersIfNeeded,this),this._dataGrid.scrollContainer.addEventListener("scroll",this._updateOffscreenRows.bind(this)),this._patchTimelineHeader()},_makeHeaderFragment:function(e,t){var r=document.createDocumentFragment();r.appendChild(document.createTextNode(e));var i=document.createElement("div");return i.className="network-header-subtitle",i.textContent=t,r.appendChild(i),r},_patchTimelineHeader:function(){var e=document.createElement("select"),t=document.createElement("option");t.value="startTime",t.label=WebInspector.UIString("Timeline"),e.appendChild(t),(t=document.createElement("option")).value="startTime",t.label=WebInspector.UIString("Start Time"),e.appendChild(t),(t=document.createElement("option")).value="responseTime",t.label=WebInspector.UIString("Response Time"),e.appendChild(t),(t=document.createElement("option")).value="endTime",t.label=WebInspector.UIString("End Time"),e.appendChild(t),(t=document.createElement("option")).value="duration",t.label=WebInspector.UIString("Duration"),e.appendChild(t),(t=document.createElement("option")).value="latency",t.label=WebInspector.UIString("Latency"),e.appendChild(t);var r=this._dataGrid.headerTableHeader("timeline");r.replaceChild(e,r.firstChild),e.addEventListener("click",function(e){e.stopPropagation()},!1),e.addEventListener("change",this._sortByTimeline.bind(this),!1),this._timelineSortSelector=e},_createSortingFunctions:function(){this._sortingFunctions={},this._sortingFunctions.name=WebInspector.NetworkDataGridNode.NameComparator,this._sortingFunctions.method=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"method",!1),this._sortingFunctions.status=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"statusCode",!1),this._sortingFunctions.type=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"mimeType",!1),this._sortingFunctions.size=WebInspector.NetworkDataGridNode.SizeComparator,this._sortingFunctions.time=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"duration",!1),this._sortingFunctions.timeline=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"startTime",!1),this._sortingFunctions.startTime=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"startTime",!1),this._sortingFunctions.endTime=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"endTime",!1),this._sortingFunctions.responseTime=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"responseReceivedTime",!1),this._sortingFunctions.duration=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"duration",!0),this._sortingFunctions.latency=WebInspector.NetworkDataGridNode.ResourcePropertyComparator.bind(null,"latency",!0);var e=new WebInspector.NetworkTransferTimeCalculator,t=new WebInspector.NetworkTransferDurationCalculator;this._calculators={},this._calculators.timeline=e,this._calculators.startTime=e,this._calculators.endTime=e,this._calculators.responseTime=e,this._calculators.duration=t,this._calculators.latency=t},_sortItems:function(){var e=this._dataGrid.sortColumnIdentifier;if("timeline"!==e){var t=this._sortingFunctions[e];t&&(this._dataGrid.sortNodes(t,"descending"===this._dataGrid.sortOrder),this._timelineSortSelector.selectedIndex=0,this._updateOffscreenRows())}else this._sortByTimeline()},_sortByTimeline:function(){var e=this._timelineSortSelector.selectedIndex;e||(e=1);// Sort by start time by default.
var t=this._timelineSortSelector[e].value,r=this._sortingFunctions[t];this._dataGrid.sortNodes(r),this.calculator=this._calculators[t],this.calculator.startAtZero?this._timelineGrid.hideEventDividers():this._timelineGrid.showEventDividers(),this._dataGrid.markColumnAsSortedBy("timeline","ascending"),this._updateOffscreenRows()},_createFilterStatusBarItems:function(){var i=document.createElement("div");function e(e,t){var r=document.createElement("li");return r.category=e,r.className=e,r.appendChild(document.createTextNode(t)),r.addEventListener("click",this._updateFilter.bind(this),!1),i.appendChild(r),r}i.className="scope-bar status-bar-item",i.id="network-filter",this._filterAllElement=e.call(this,"all",WebInspector.UIString("All"));
// Add a divider
var t=document.createElement("div");for(var r in t.addStyleClass("scope-bar-divider"),i.appendChild(t),this._categories)e.call(this,r,this._categories[r].title);this._filterBarElement=i},_createSummaryBar:function(){this._summaryBarElement=document.createElement("div"),this._summaryBarElement.className="network-summary-bar",this.containerElement.appendChild(this._summaryBarElement)},_updateSummaryBar:function(){this._positionSummaryBar();// Grid is growing.
var e=this._resources.length;if(!e){if(this._summaryBarElement._isDisplayingWarning)return;this._summaryBarElement._isDisplayingWarning=!0;var t=document.createElement("img");return t.src="Images/warningIcon.png",this._summaryBarElement.removeChildren(),this._summaryBarElement.appendChild(t),this._summaryBarElement.appendChild(document.createTextNode(" ")),void this._summaryBarElement.appendChild(document.createTextNode(WebInspector.UIString("No requests captured. Reload the page to see detailed information on the network activity.")))}delete this._summaryBarElement._isDisplayingWarning;for(var r=0,i=-1,s=-1,n=0;n<this._resources.length;++n){var a=this._resources[n];r+=a.cached||!a.transferSize?0:a.transferSize,a.isMainResource&&(i=a.startTime),a.endTime>s&&(s=a.endTime)}var o=String.sprintf(WebInspector.UIString("%d requests"),e);o+="  ❘  "+String.sprintf(WebInspector.UIString("%s transferred"),Number.bytesToString(r)),-1!==i&&-1!==this._mainResourceLoadTime&&-1!==this._mainResourceDOMContentTime&&this._mainResourceDOMContentTime>i&&(o+="  ❘  "+String.sprintf(WebInspector.UIString("%s (onload: %s, DOMContentLoaded: %s)"),Number.secondsToString(s-i),Number.secondsToString(this._mainResourceLoadTime-i),Number.secondsToString(this._mainResourceDOMContentTime-i))),this._summaryBarElement.textContent=o},_showCategory:function(e){this._dataGrid.element.addStyleClass("filter-"+e),delete this._hiddenCategories[e]},_hideCategory:function(e){this._dataGrid.element.removeStyleClass("filter-"+e),this._hiddenCategories[e]=!0},_updateFilter:function(e){var t=WebInspector.isMac(),r=!1;!t||!e.metaKey||e.ctrlKey||e.altKey||e.shiftKey||(r=!0),t||!e.ctrlKey||e.metaKey||e.altKey||e.shiftKey||(r=!0),this._filter(e.target,r),this._positionSummaryBar()},_filter:function(e,t){function r(){for(var e=0;e<this._filterBarElement.childNodes.length;++e){var t=this._filterBarElement.childNodes[e];t.category&&(t.removeStyleClass("selected"),this._hideCategory(t.category))}}if(e.category===this._filterAllElement){if(e.hasStyleClass("selected"))
// We can't unselect All, so we break early here
return;
// If All wasn't selected, and now is, unselect everything else.
r.call(this)}else
// Something other than All is being selected, so we want to unselect All.
this._filterAllElement.hasStyleClass("selected")&&(this._filterAllElement.removeStyleClass("selected"),this._hideCategory("all"));if(!t)
// If multiple selection is off, we want to unselect everything else
// and just select ourselves.
return r.call(this),e.addStyleClass("selected"),void this._showCategory(e.category);e.hasStyleClass("selected")?(
// If selectMultiple is turned on, and we were selected, we just
// want to unselect ourselves.
e.removeStyleClass("selected"),this._hideCategory(e.category)):(
// If selectMultiple is turned on, and we weren't selected, we just
// want to select ourselves.
e.addStyleClass("selected"),this._showCategory(e.category)),this._updateOffscreenRows()},_scheduleRefresh:function(){this._needsRefresh||(this._needsRefresh=!0,!this.visible||"_refreshTimeout"in this||(this._refreshTimeout=setTimeout(this.refresh.bind(this),500)))},_updateDividersIfNeeded:function(e){for(var t=this._dataGrid.columns.timeline,r=0;r<this._dataGrid.resizers.length;++r)t.ordinal===this._dataGrid.resizers[r].rightNeighboringColumnID&&(
// Position timline grid location.
this._timelineGrid.element.style.left=this._dataGrid.resizers[r].style.left,this._timelineGrid.element.style.right="18px");if((this.visible?this._timelineGrid.updateDividers(e,this.calculator):(this._scheduleRefresh(),!1))&&!this.calculator.startAtZero&&this.calculator.computePercentageFromEventTime){if(this._timelineGrid.removeEventDividers(),-1!==this._mainResourceLoadTime){var i=this.calculator.computePercentageFromEventTime(this._mainResourceLoadTime),s=document.createElement("div");s.className="network-event-divider network-red-divider";var n=document.createElement("div");n.className="network-event-divider-padding",n.title=WebInspector.UIString("Load event fired"),n.appendChild(s),n.style.left=i+"%",this._timelineGrid.addEventDivider(n)}if(-1!==this._mainResourceDOMContentTime){i=this.calculator.computePercentageFromEventTime(this._mainResourceDOMContentTime);var a=document.createElement("div");a.className="network-event-divider network-blue-divider";var o=document.createElement("div");o.className="network-event-divider-padding",o.title=WebInspector.UIString("DOMContent event fired"),o.appendChild(a),o.style.left=i+"%",this._timelineGrid.addEventDivider(o)}}},_refreshIfNeeded:function(){this._needsRefresh&&this.refresh()},_invalidateAllItems:function(){this._staleResources=this._resources.slice()},get calculator(){return this._calculator},set calculator(e){e&&this._calculator!==e&&(this._calculator=e,this._calculator.reset(),this._invalidateAllItems(),this.refresh())},_resourceGridNode:function(e){return this._resourceGridNodes[e.identifier]},revealAndSelectItem:function(e){var t=this._resourceGridNode(e);t&&(t.reveal(),t.select(!0))},addEventDivider:function(e){this._timelineGrid.addEventDivider(e)},_createStatusbarButtons:function(){this._preserveLogToggle=new WebInspector.StatusBarButton(WebInspector.UIString("Preserve Log upon Navigation"),"record-profile-status-bar-item"),this._preserveLogToggle.addEventListener("click",this._onPreserveLogClicked.bind(this),!1),this._clearButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear"),"clear-status-bar-item"),this._clearButton.addEventListener("click",this._reset.bind(this),!1),this._largerResourcesButton=new WebInspector.StatusBarButton(WebInspector.UIString("Use small resource rows."),"network-larger-resources-status-bar-item"),this._largerResourcesButton.toggled=WebInspector.settings.resourcesLargeRows,this._largerResourcesButton.addEventListener("click",this._toggleLargerResources.bind(this),!1)},set mainResourceLoadTime(e){this._mainResourceLoadTime!==e&&(this._mainResourceLoadTime=e||-1,
// Update the dividers to draw the new line
this._updateDividersIfNeeded(!0))},set mainResourceDOMContentTime(e){this._mainResourceDOMContentTime!==e&&(this._mainResourceDOMContentTime=e||-1,this._updateDividersIfNeeded(!0))},show:function(){WebInspector.Panel.prototype.show.call(this),this._refreshIfNeeded(),this.visibleView&&this.visibleView.show(this._viewsContainerElement),this._dataGrid.updateWidths(),this._positionSummaryBar()},hide:function(){WebInspector.Panel.prototype.hide.call(this),this._popoverHelper.hidePopup()},get searchableViews(){return[]},searchMatchFound:function(e,t){this._resourceGridNode(e.resource).searchMatches=t},searchCanceled:function(e){WebInspector.Panel.prototype.searchCanceled.call(this,e),!e&&this._resources},performSearch:function(e){WebInspector.Panel.prototype.performSearch.call(this,e)},refresh:function(){this._needsRefresh=!1,"_refreshTimeout"in this&&(clearTimeout(this._refreshTimeout),delete this._refreshTimeout);for(var e=this._dataGrid.isScrolledToLastRow(),t=this._staleResources.length,r=!1,i=0;i<t;++i){var s=this._staleResources[i],n=this._resourceGridNode(s);n||(
// Create the timeline tree element and graph.
n=new WebInspector.NetworkDataGridNode(this,s),this._resourceGridNodes[s.identifier]=n,this._dataGrid.appendChild(n)),n.refreshResource(),this.calculator.updateBoundaries(s)&&(r=!0)}r&&(
// The boundaries changed, so all item graphs are stale.
this._invalidateAllItems(),t=this._staleResources.length);for(i=0;i<t;++i)this._resourceGridNode(this._staleResources[i]).refreshGraph(this.calculator);this._staleResources=[],this._sortItems(),this._updateSummaryBar(),this._dataGrid.updateWidths(),e&&this._dataGrid.scrollToLastRow()},_onPreserveLogClicked:function(e){this._preserveLogToggle.toggled=!this._preserveLogToggle.toggled},_reset:function(){this._popoverHelper.hidePopup(),this._closeVisibleResource(),this._toggleGridMode(),
// Begin reset timeline
this._calculator&&this._calculator.reset(),this._resources=[],this._resourcesById={},this._resourcesByURL={},this._staleResources=[],this._resourceGridNodes={},this._dataGrid.removeChildren(),delete this._summaryBarRowNode,this._updateDividersIfNeeded(!0),
// End reset timeline.
this._mainResourceLoadTime=-1,this._mainResourceDOMContentTime=-1,this._viewsContainerElement.removeChildren(),this._viewsContainerElement.appendChild(this._closeButtonElement),this._resetSummaryBar()},get resources(){return this._resources},resourceById:function(e){return this._resourcesById[e]},_onResourceStarted:function(e){this._appendResource(e.data)},_appendResource:function(e){
// Pull all the redirects of the main resource upon commit load.
if(this._resources.push(e),this._resourcesById[e.identifier]=e,(this._resourcesByURL[e.url]=e).redirects)for(var t=0;t<e.redirects.length;++t)this._refreshResource(e.redirects[t]);this._refreshResource(e)},_onResourceUpdated:function(e){this._refreshResource(e.data)},_refreshResource:function(e){this._staleResources.push(e),this._scheduleRefresh();var t=WebInspector.ResourceView.existingResourceViewForResource(e);if(t&&!WebInspector.ResourceView.resourceViewTypeMatchesResource(e)){var r=WebInspector.ResourceView.recreateResourceView(e);this.visibleView===t&&(this.visibleView=r)}},clear:function(){this._preserveLogToggle.toggled||this._reset()},_onMainResourceCommitLoad:function(){this._preserveLogToggle.toggled||(this._reset(),(WebInspector.mainResource.redirects||[]).concat(WebInspector.mainResource).forEach(this._appendResource,this))},canShowSourceLine:function(e,t){return!!this._resourcesByURL[e]},showSourceLine:function(e,t){this._showResource(this._resourcesByURL[e],t)},_showResource:function(e,t){if(e){this._popoverHelper.hidePopup(),this._toggleViewingResourceMode(),this.visibleView&&(this.visibleView.detach(),delete this.visibleView);var r=new WebInspector.NetworkItemView(e);r.show(this._viewsContainerElement),this.visibleView=r,this.updateSidebarWidth()}},_closeVisibleResource:function(){this.element.removeStyleClass("viewing-resource"),this.visibleView&&(this.visibleView.detach(),delete this.visibleView),this._lastSelectedGraphTreeElement&&this._lastSelectedGraphTreeElement.select(!0),this.updateSidebarWidth()},_toggleLargerResources:function(){WebInspector.settings.resourcesLargeRows=!WebInspector.settings.resourcesLargeRows,this._setLargerResources(WebInspector.settings.resourcesLargeRows)},_setLargerResources:function(e){(this._largerResourcesButton.toggled=e)?(this._largerResourcesButton.title=WebInspector.UIString("Use small resource rows."),this._dataGrid.element.removeStyleClass("small"),this._timelineGrid.element.removeStyleClass("small"),this._viewsContainerElement.removeStyleClass("small")):(this._largerResourcesButton.title=WebInspector.UIString("Use large resource rows."),this._dataGrid.element.addStyleClass("small"),this._timelineGrid.element.addStyleClass("small"),this._viewsContainerElement.addStyleClass("small")),this._positionSummaryBar()},_getPopoverAnchor:function(e){var t=e.enclosingNodeOrSelfWithClass("network-graph-bar")||e.enclosingNodeOrSelfWithClass("network-graph-label");if(!t)return null;var r=t.parentElement.resource;return r&&r.timing?t:null},_showPopover:function(e){var t=e.parentElement.resource,r=WebInspector.ResourceTimingView.createTimingTable(t),i=new WebInspector.Popover(r);return i.show(e),i},_toggleGridMode:function(){if(this._viewingResourceMode&&(this._viewingResourceMode=!1,this.element.removeStyleClass("viewing-resource"),this._dataGrid.element.removeStyleClass("viewing-resource-mode"),this._viewsContainerElement.addStyleClass("hidden"),this.sidebarElement.style.right=0,this.sidebarElement.style.removeProperty("width"),this._dataGrid.selectedNode&&(this._dataGrid.selectedNode.selected=!1)),this._briefGrid){this._dataGrid.element.removeStyleClass("full-grid-mode"),this._dataGrid.element.addStyleClass("brief-grid-mode"),this._dataGrid.hideColumn("method"),this._dataGrid.hideColumn("status"),this._dataGrid.hideColumn("type"),this._dataGrid.hideColumn("size"),this._dataGrid.hideColumn("time");var e={name:20,timeline:80}}else{this._dataGrid.element.addStyleClass("full-grid-mode"),this._dataGrid.element.removeStyleClass("brief-grid-mode"),this._dataGrid.showColumn("method"),this._dataGrid.showColumn("status"),this._dataGrid.showColumn("type"),this._dataGrid.showColumn("size"),this._dataGrid.showColumn("time");e={name:20,method:7,status:8,type:10,size:10,time:10,timeline:37}}this._dataGrid.showColumn("timeline"),this._dataGrid.applyColumnWidthsMap(e)},_toggleViewingResourceMode:function(){if(!this._viewingResourceMode){this._viewingResourceMode=!0,this._preservedColumnWidths=this._dataGrid.columnWidthsMap(),this.element.addStyleClass("viewing-resource"),this._dataGrid.element.addStyleClass("viewing-resource-mode"),this._dataGrid.element.removeStyleClass("full-grid-mode"),this._dataGrid.element.removeStyleClass("brief-grid-mode"),this._dataGrid.hideColumn("method"),this._dataGrid.hideColumn("status"),this._dataGrid.hideColumn("type"),this._dataGrid.hideColumn("size"),this._dataGrid.hideColumn("time"),this._dataGrid.hideColumn("timeline"),this._viewsContainerElement.removeStyleClass("hidden"),this.updateSidebarWidth(200);var e={name:100};this._dataGrid.applyColumnWidthsMap(e)}},_contextMenu:function(e){
// createBlobURL is enabled conditionally, do not expose resource export if it's not available.
if("function"==typeof window.webkitURL.createObjectURL&&Preferences.resourceExportEnabled){var t=new WebInspector.ContextMenu,r=this._dataGrid.dataGridNodeFromNode(e.target),i=r&&r._resource;i&&t.appendItem(WebInspector.UIString("Export to HAR"),this._exportResource.bind(this,i)),t.appendItem(WebInspector.UIString("Export all to HAR"),this._exportAll.bind(this)),t.show(e)}},_exportAll:function(){var e={log:(new WebInspector.HARLog).build()};InspectorFrontendHost.copyText(JSON.stringify(e))},_exportResource:function(e){var t=new WebInspector.HAREntry(e).build();InspectorFrontendHost.copyText(JSON.stringify(t))},_updateOffscreenRows:function(e){var t=this._dataGrid.dataTableBody.children,r=t.length;if(!(r<2))for(// Filler row only.
var i=this._dataGrid.scrollContainer.scrollTop,s=i+this._dataGrid.scrollContainer.offsetHeight,n=0,a=0,o=0;o<r-1;++o){var l=t[o];
// Don't touch summaty - quit instead.
if(this._summaryBarRowNode&&l===this._summaryBarRowNode.element)break;if(this._dataGrid.dataGridNodeFromNode(l).isFilteredOut())l.removeStyleClass("offscreen");else{n||(n=l.offsetHeight);var d=a*n<s&&i<(a+1)*n;d!==l.rowIsVisible&&(d?l.removeStyleClass("offscreen"):l.addStyleClass("offscreen"),l.rowIsVisible=d),a++}}}},WebInspector.NetworkPanel.prototype.__proto__=WebInspector.Panel.prototype,WebInspector.NetworkBaseCalculator=function(){},WebInspector.NetworkBaseCalculator.prototype={computeSummaryValues:function(e){for(var t=0,r={},i=e.length,s=0;s<i;++s){var n=e[s],a=this._value(n);void 0!==a&&(n.category.name in r||(r[n.category.name]=0),r[n.category.name]+=a,t+=a)}return{categoryValues:r,total:t}},computeBarGraphPercentages:function(e){return{start:0,middle:0,end:this._value(e)/this.boundarySpan*100}},computeBarGraphLabels:function(e){var t=this.formatValue(this._value(e));return{left:t,right:t,tooltip:t}},get boundarySpan(){return this.maximumBoundary-this.minimumBoundary},updateBoundaries:function(e){this.minimumBoundary=0;var t=this._value(e);return(void 0===this.maximumBoundary||t>this.maximumBoundary)&&(this.maximumBoundary=t,!0)},reset:function(){delete this.minimumBoundary,delete this.maximumBoundary},_value:function(e){return 0},formatValue:function(e){return e.toString()}},WebInspector.NetworkTimeCalculator=function(e){WebInspector.NetworkBaseCalculator.call(this),this.startAtZero=e},WebInspector.NetworkTimeCalculator.prototype={computeSummaryValues:function(e){for(var t,r,i={},s=e.length,n=0;n<s;++n){(h=e[n]).category.name in i||(i[h.category.name]=[]),i[h.category.name].push(h)}var a={};for(var o in i){i[o].sort(WebInspector.Resource.CompareByTime),a[o]=0;var l={start:-1,end:-1},d=i[o];for(s=d.length,n=0;n<s;++n){var h;-1!==(h=d[n]).startTime&&-1!==h.endTime&&(t=void 0===t?h.startTime:Math.min(t,h.startTime),r=void 0===r?h.endTime:Math.max(r,h.endTime),h.startTime<=l.end?l.end=Math.max(l.end,h.endTime):(a[o]+=l.end-l.start,l.start=h.startTime,l.end=h.endTime))}
// Add the last segment
a[o]+=l.end-l.start}return{categoryValues:a,total:r-t}},computeBarGraphPercentages:function(e){if(-1!==e.startTime)var t=(e.startTime-this.minimumBoundary)/this.boundarySpan*100;else t=0;if(-1!==e.responseReceivedTime)var r=(e.responseReceivedTime-this.minimumBoundary)/this.boundarySpan*100;else r=this.startAtZero?t:100;if(-1!==e.endTime)var i=(e.endTime-this.minimumBoundary)/this.boundarySpan*100;else i=this.startAtZero?r:100;return this.startAtZero&&(i-=t,r-=t,t=0),{start:t,middle:r,end:i}},computePercentageFromEventTime:function(e){
// This function computes a percentage in terms of the total loading time
// of a specific event. If startAtZero is set, then this is useless, and we
// want to return 0.
return-1===e||this.startAtZero?0:(e-this.minimumBoundary)/this.boundarySpan*100},computeBarGraphLabels:function(e){var t="";-1!==e.responseReceivedTime&&-1!==e.endTime&&(t=this.formatValue(e.endTime-e.responseReceivedTime));var r=0<e.latency;if(r)var i=this.formatValue(e.latency);else i=t;if(e.timing)return{left:i,right:t};if(r&&t)var s=this.formatValue(e.duration),n=WebInspector.UIString("%s latency, %s download (%s total)",i,t,s);else if(r)n=WebInspector.UIString("%s latency",i);else if(t)n=WebInspector.UIString("%s download",t);return e.cached&&(n=WebInspector.UIString("%s (from cache)",n)),{left:i,right:t,tooltip:n}},updateBoundaries:function(e){var t,r=!1;-1!==(t=this.startAtZero?0:this._lowerBound(e))&&(void 0===this.minimumBoundary||t<this.minimumBoundary)&&(this.minimumBoundary=t,r=!0);var i=this._upperBound(e);return-1!==i&&(void 0===this.maximumBoundary||i>this.maximumBoundary)&&(this.maximumBoundary=i,r=!0),r},formatValue:function(e){return Number.secondsToString(e)},_lowerBound:function(e){return 0},_upperBound:function(e){return 0}},WebInspector.NetworkTimeCalculator.prototype.__proto__=WebInspector.NetworkBaseCalculator.prototype,WebInspector.NetworkTransferTimeCalculator=function(){WebInspector.NetworkTimeCalculator.call(this,!1)},WebInspector.NetworkTransferTimeCalculator.prototype={formatValue:function(e){return Number.secondsToString(e)},_lowerBound:function(e){return e.startTime},_upperBound:function(e){return e.endTime}},WebInspector.NetworkTransferTimeCalculator.prototype.__proto__=WebInspector.NetworkTimeCalculator.prototype,WebInspector.NetworkTransferDurationCalculator=function(){WebInspector.NetworkTimeCalculator.call(this,!0)},WebInspector.NetworkTransferDurationCalculator.prototype={formatValue:function(e){return Number.secondsToString(e)},_upperBound:function(e){return e.duration}},WebInspector.NetworkTransferDurationCalculator.prototype.__proto__=WebInspector.NetworkTimeCalculator.prototype,WebInspector.NetworkDataGridNode=function(e,t){WebInspector.DataGridNode.call(this,{}),this._panel=e,this._resource=t},WebInspector.NetworkDataGridNode.prototype={createCells:function(){this._nameCell=this._createDivInTD("name"),this._methodCell=this._createDivInTD("method"),this._statusCell=this._createDivInTD("status"),this._typeCell=this._createDivInTD("type"),this._sizeCell=this._createDivInTD("size"),this._timeCell=this._createDivInTD("time"),this._createTimelineCell(),this._nameCell.addEventListener("click",this.select.bind(this),!1),this._nameCell.addEventListener("dblclick",this._openInNewTab.bind(this),!1)},isFilteredOut:function(){return!!this._panel._hiddenCategories.all&&this._resource.category.name in this._panel._hiddenCategories},select:function(){this._panel._showResource(this._resource),WebInspector.DataGridNode.prototype.select.apply(this,arguments)},_openInNewTab:function(){InspectorBackend.openInInspectedWindow(this._resource.url)},get selectable(){return!!this._panel._viewingResourceMode&&!this.isFilteredOut()},_createDivInTD:function(e){var t=document.createElement("td");t.className=e+"-column";var r=document.createElement("div");return t.appendChild(r),this._element.appendChild(t),r},_createTimelineCell:function(){this._graphElement=document.createElement("div"),this._graphElement.className="network-graph-side",this._barAreaElement=document.createElement("div"),
//    this._barAreaElement.className = "network-graph-bar-area hidden";
this._barAreaElement.className="network-graph-bar-area",this._barAreaElement.resource=this._resource,this._graphElement.appendChild(this._barAreaElement),this._barLeftElement=document.createElement("div"),this._barLeftElement.className="network-graph-bar waiting",this._barAreaElement.appendChild(this._barLeftElement),this._barRightElement=document.createElement("div"),this._barRightElement.className="network-graph-bar",this._barAreaElement.appendChild(this._barRightElement),this._labelLeftElement=document.createElement("div"),this._labelLeftElement.className="network-graph-label waiting",this._barAreaElement.appendChild(this._labelLeftElement),this._labelRightElement=document.createElement("div"),this._labelRightElement.className="network-graph-label",this._barAreaElement.appendChild(this._labelRightElement),this._graphElement.addEventListener("mouseover",this._refreshLabelPositions.bind(this),!1),this._timelineCell=document.createElement("td"),this._timelineCell.className="timeline-column",this._element.appendChild(this._timelineCell),this._timelineCell.appendChild(this._graphElement)},refreshResource:function(){this._refreshNameCell(),this._methodCell.textContent=this._resource.requestMethod,this._refreshStatusCell(),this._resource.mimeType?(this._typeCell.removeStyleClass("network-dim-cell"),this._typeCell.textContent=this._resource.mimeType):(this._typeCell.addStyleClass("network-dim-cell"),this._typeCell.textContent=WebInspector.UIString("Pending")),this._refreshSizeCell(),this._refreshTimeCell(),this._resource.cached&&this._graphElement.addStyleClass("resource-cached"),this._element.addStyleClass("network-item"),this._element.hasStyleClass("network-category-"+this._resource.category.name)||(this._element.removeMatchingStyleClasses("network-category-\\w+"),this._element.addStyleClass("network-category-"+this._resource.category.name))},_refreshNameCell:function(){if(this._nameCell.removeChildren(),this._resource.category===WebInspector.resourceCategories.images){var e=document.createElement("img");e.className="image-network-icon-preview",this._resource.populateImageSource(e),(t=document.createElement("div")).className="icon",t.appendChild(e)}else{var t;(t=document.createElement("img")).className="icon"}this._nameCell.appendChild(t),this._nameCell.appendChild(document.createTextNode(this._fileName()));var r=this._resource.displayDomain;if(this._resource.path&&this._resource.lastPathComponent){var i=this._resource.path.lastIndexOf("/"+this._resource.lastPathComponent);-1!=i&&(r+=this._resource.path.substring(0,i))}this._appendSubtitle(this._nameCell,r),this._nameCell.title=this._resource.url},_fileName:function(){var e=this._resource.displayName;return this._resource.queryString&&(e+="?"+this._resource.queryString),e},_refreshStatusCell:function(){if(this._statusCell.removeChildren(),this._resource.cached)return this._statusCell.textContent=WebInspector.UIString("(from cache)"),void this._statusCell.addStyleClass("network-dim-cell");this._statusCell.removeStyleClass("network-dim-cell"),this._resource.statusCode?(this._statusCell.appendChild(document.createTextNode(this._resource.statusCode)),this._statusCell.removeStyleClass("network-dim-cell"),this._appendSubtitle(this._statusCell,this._resource.statusText),this._statusCell.title=this._resource.statusCode+" "+this._resource.statusText):(this._statusCell.addStyleClass("network-dim-cell"),this._statusCell.textContent=WebInspector.UIString("Pending"))},_refreshSizeCell:function(){var e="number"==typeof this._resource.resourceSize?Number.bytesToString(this._resource.resourceSize):"?",t="number"==typeof this._resource.transferSize?Number.bytesToString(this._resource.transferSize):"?",r=this._resource.cached;this._sizeCell.textContent=r?WebInspector.UIString("(from cache)"):e,r?this._sizeCell.addStyleClass("network-dim-cell"):this._sizeCell.removeStyleClass("network-dim-cell"),r||this._appendSubtitle(this._sizeCell,t)},_refreshTimeCell:function(){0<this._resource.duration?(this._timeCell.removeStyleClass("network-dim-cell"),this._timeCell.textContent=Number.secondsToString(this._resource.duration),this._appendSubtitle(this._timeCell,Number.secondsToString(this._resource.latency))):(this._timeCell.addStyleClass("network-dim-cell"),this._timeCell.textContent=WebInspector.UIString("Pending"))},_appendSubtitle:function(e,t){var r=document.createElement("div");r.className="network-cell-subtitle",r.textContent=t,e.appendChild(r)},refreshGraph:function(e){var t=e.computeBarGraphPercentages(this._resource);this._percentages=t,this._barAreaElement.removeStyleClass("hidden"),this._graphElement.hasStyleClass("network-category-"+this._resource.category.name)||(this._graphElement.removeMatchingStyleClasses("network-category-\\w+"),this._graphElement.addStyleClass("network-category-"+this._resource.category.name)),this._barLeftElement.style.setProperty("left",t.start+"%"),this._barRightElement.style.setProperty("right",100-t.end+"%"),this._barLeftElement.style.setProperty("right",100-t.end+"%"),this._barRightElement.style.setProperty("left",t.middle+"%");var r=e.computeBarGraphLabels(this._resource);this._labelLeftElement.textContent=r.left,this._labelRightElement.textContent=r.right;var i=r.tooltip||"";this._barLeftElement.title=i,this._labelLeftElement.title=i,this._labelRightElement.title=i,this._barRightElement.title=i},_refreshLabelPositions:function(){if(this._percentages){this._labelLeftElement.style.removeProperty("left"),this._labelLeftElement.style.removeProperty("right"),this._labelLeftElement.removeStyleClass("before"),this._labelLeftElement.removeStyleClass("hidden"),this._labelRightElement.style.removeProperty("left"),this._labelRightElement.style.removeProperty("right"),this._labelRightElement.removeStyleClass("after"),this._labelRightElement.removeStyleClass("hidden");var e=this._barRightElement.offsetWidth,t=this._barLeftElement.offsetWidth;if(this._barLeftElement)var r=t-10,i=e-t-10;else r=t-e-10,i=e-10;var s=this._labelLeftElement.offsetWidth,n=this._labelRightElement.offsetWidth,a=r<s,o=i<n,l=this._graphElement.offsetWidth;if(a&&l*(this._percentages.start/100)<s+10)var d=!0;if(o&&l*((100-this._percentages.end)/100)<n+10)var h=!0;t==e&&(
// The left/right label data are the same, so a before/after label can be replaced by an on-bar label.
a&&!o?d=!0:o&&!a&&(h=!0)),a?(d&&this._labelLeftElement.addStyleClass("hidden"),this._labelLeftElement.style.setProperty("right",100-this._percentages.start+"%"),this._labelLeftElement.addStyleClass("before")):(this._labelLeftElement.style.setProperty("left",this._percentages.start+"%"),this._labelLeftElement.style.setProperty("right",100-this._percentages.middle+"%")),o?(h&&this._labelRightElement.addStyleClass("hidden"),this._labelRightElement.style.setProperty("left",this._percentages.end+"%"),this._labelRightElement.addStyleClass("after")):(this._labelRightElement.style.setProperty("left",this._percentages.middle+"%"),this._labelRightElement.style.setProperty("right",100-this._percentages.end+"%"))}}},WebInspector.NetworkDataGridNode.NameComparator=function(e,t){var r=e._resource.displayName+(e._resource.queryString?e._resource.queryString:""),i=t._resource.displayName+(t._resource.queryString?t._resource.queryString:"");return i<r?1:r<i?-1:0},WebInspector.NetworkDataGridNode.SizeComparator=function(e,t){return t._resource.cached&&!e._resource.cached?1:e._resource.cached&&!t._resource.cached?-1:e._resource.resourceSize===t._resource.resourceSize?0:e._resource.resourceSize-t._resource.resourceSize},WebInspector.NetworkDataGridNode.ResourcePropertyComparator=function(e,t,r,i){var s=r._resource[e],n=i._resource[e];return n<s?t?-1:1:s<n?t?1:-1:0},WebInspector.NetworkDataGridNode.prototype.__proto__=WebInspector.DataGridNode.prototype,WebInspector.NetworkTotalGridNode=function(e){this._summaryBarElement=e,WebInspector.DataGridNode.call(this,{summaryRow:!0})},WebInspector.NetworkTotalGridNode.prototype={isFilteredOut:function(){return!1},get selectable(){return!1},createCells:function(){var e=document.createElement("td");e.setAttribute("colspan",7),e.className="network-summary",e.appendChild(this._summaryBarElement),this._element.appendChild(e)}},WebInspector.NetworkTotalGridNode.prototype.__proto__=WebInspector.DataGridNode.prototype;