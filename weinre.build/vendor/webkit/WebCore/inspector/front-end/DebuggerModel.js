/*
 * Copyright (C) 2010 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.DebuggerModel=function(){this._paused=!1,this._callFrames=[],this._breakpoints={},this._scripts={},InspectorBackend.registerDomainDispatcher("Debugger",new WebInspector.DebuggerDispatcher(this))},WebInspector.DebuggerModel.Events={DebuggerPaused:"debugger-paused",DebuggerResumed:"debugger-resumed",ParsedScriptSource:"parsed-script-source",FailedToParseScriptSource:"failed-to-parse-script-source",ScriptSourceChanged:"script-source-changed",BreakpointAdded:"breakpoint-added",BreakpointRemoved:"breakpoint-removed",BreakpointResolved:"breakpoint-resolved"},WebInspector.DebuggerModel.prototype={enableDebugger:function(){if(InspectorBackend.enableDebugger(),!this._breakpointsPushedToBackend){for(var e=WebInspector.settings.breakpoints,r=0;r<e.length;++r){var t=e[r];"string"==typeof t.url&&"number"==typeof t.lineNumber&&"number"==typeof t.columnNumber&&"string"==typeof t.condition&&"boolean"==typeof t.enabled&&this.setBreakpoint(t.url,t.lineNumber,t.columnNumber,t.condition,t.enabled)}this._breakpointsPushedToBackend=!0}},disableDebugger:function(){InspectorBackend.disableDebugger()},continueToLocation:function(e,r,t){InspectorBackend.continueToLocation(e,r,t)},setBreakpoint:function(o,n,s,a,c){InspectorBackend.setJavaScriptBreakpoint(o,n,s,a,c,function(e,r,t){if(r){var i=new WebInspector.Breakpoint(r,o,"",n,s,a,c);i.locations=t,this._breakpoints[r]=i,e&&this._saveBreakpoints(),this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.BreakpointAdded,i)}}.bind(this,this._breakpointsPushedToBackend))},setBreakpointBySourceId:function(o,n,s,a,c){InspectorBackend.setJavaScriptBreakpointBySourceId(o,n,s,a,c,function(e,r,t){if(e){var i=new WebInspector.Breakpoint(e,"",o,n,s,a,c);i.addLocation(o,r,t),this._breakpoints[e]=i,this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.BreakpointAdded,i)}}.bind(this))},removeBreakpoint:function(e){InspectorBackend.removeJavaScriptBreakpoint(e);this._breakpoints[e];delete this._breakpoints[e],this._saveBreakpoints(),this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.BreakpointRemoved,e)},updateBreakpoint:function(e,r,t){var i=this._breakpoints[e];this.removeBreakpoint(e),i.url?this.setBreakpoint(i.url,i.lineNumber,i.columnNumber,r,t):this.setBreakpointBySourceId(i.sourceID,i.lineNumber,i.columnNumber,r,t)},_breakpointResolved:function(e,r,t,i){var o=this._breakpoints[e];o&&(o.addLocation(r,t,i),this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.BreakpointResolved,o))},_saveBreakpoints:function(){var e=[];for(var r in this._breakpoints){var t=this._breakpoints[r];if(t.url){var i={};i.url=t.url,i.lineNumber=t.lineNumber,i.columnNumber=t.columnNumber,i.condition=t.condition,i.enabled=t.enabled,e.push(i)}}WebInspector.settings.breakpoints=e},get breakpoints(){return this._breakpoints},breakpointForId:function(e){return this._breakpoints[e]},queryBreakpoints:function(e){var r=[];for(var t in this._breakpoints){var i=this._breakpoints[t];e(i)&&r.push(i)}return r},reset:function(){for(var e in this._paused=!1,this._callFrames=[],this._breakpoints){var r=this._breakpoints[e];r.url?r.locations=[]:this.removeBreakpoint(e)}this._scripts={}},scriptForSourceID:function(e){return this._scripts[e]},scriptsForURL:function(r){return this.queryScripts(function(e){return e.sourceURL===r})},queryScripts:function(e){var r=[];for(var t in this._scripts){var i=this._scripts[t];e(i)&&r.push(i)}return r},editScriptSource:function(i,e){InspectorBackend.editScriptSource(i,e,function(e,r,t){e?(t&&t.length&&(this._callFrames=t),this._updateScriptSource(i,r)):WebInspector.log(r,WebInspector.ConsoleMessage.MessageLevel.Warning)}.bind(this))},_updateScriptSource:function(e,r){var t=this._scripts[e],i=t.source;t.source=r;
// Clear and re-create breakpoints according to text diff.
var o=Array.diff(i.split("\n"),t.source.split("\n"));for(var n in this._breakpoints){var s=this._breakpoints[n];if(s.url){if(s.url!==t.sourceURL)continue}else if(s.sourceID!==e)continue;this.removeBreakpoint(s.id);var a=s.lineNumber,c=o.left[a].row;if(void 0===c)for(var p=a-1;0<=p;--p)if(void 0!==o.left[p].row){var u=o.left[p].row+a-p;if(u<o.right.length){var d=o.right[u].row;d!==a&&void 0!==d||(c=u)}break}void 0!==c&&(s.url?this.setBreakpoint(s.url,c,s.columnNumber,s.condition,s.enabled):this.setBreakpointBySourceId(e,c,s.columnNumber,s.condition,s.enabled))}this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.ScriptSourceChanged,{sourceID:e,oldSource:i})},get callFrames(){return this._callFrames},_pausedScript:function(e){this._paused=!0,this._callFrames=e.callFrames,e.breakpoint=this._breakpointForCallFrame(e.callFrames[0]),this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.DebuggerPaused,e)},_resumedScript:function(){this._paused=!1,this._callFrames=[],this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.DebuggerResumed)},_breakpointForCallFrame:function(e){for(var r in this._breakpoints)for(var t=this._breakpoints[r],i=0;i<t.locations.length;++i)if((o=t.locations[i]).sourceID==e.sourceID&&o.lineNumber===e.line&&o.columnNumber===e.column)return t;var o},_parsedScriptSource:function(e,r,t,i,o,n){var s=new WebInspector.Script(e,r,"",t,i,o,void 0,void 0,n);this._scripts[e]=s,this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.ParsedScriptSource,s)},_failedToParseScriptSource:function(e,r,t,i,o){var n=new WebInspector.Script(null,e,r,t,i,o,void 0);this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.FailedToParseScriptSource,n)}},WebInspector.DebuggerModel.prototype.__proto__=WebInspector.Object.prototype,WebInspector.DebuggerEventTypes={JavaScriptPause:0,JavaScriptBreakpoint:1,NativeBreakpoint:2},WebInspector.DebuggerDispatcher=function(e){this._debuggerModel=e},WebInspector.DebuggerDispatcher.prototype={pausedScript:function(e){this._debuggerModel._pausedScript(e)},resumedScript:function(){this._debuggerModel._resumedScript()},debuggerWasEnabled:function(){WebInspector.panels.scripts.debuggerWasEnabled()},debuggerWasDisabled:function(){WebInspector.panels.scripts.debuggerWasDisabled()},parsedScriptSource:function(e,r,t,i,o,n){this._debuggerModel._parsedScriptSource(e,r,t,i,o,n)},failedToParseScriptSource:function(e,r,t,i,o){this._debuggerModel._failedToParseScriptSource(e,r,t,i,o)},breakpointResolved:function(e,r,t,i){this._debuggerModel._breakpointResolved(e,r,t,i)},didCreateWorker:function(){var e=WebInspector.panels.scripts.sidebarPanes.workers;e.addWorker.apply(e,arguments)},didDestroyWorker:function(){var e=WebInspector.panels.scripts.sidebarPanes.workers;e.removeWorker.apply(e,arguments)}};