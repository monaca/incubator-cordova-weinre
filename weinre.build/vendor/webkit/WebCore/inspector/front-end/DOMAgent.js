/*
 * Copyright (C) 2009, 2010 Google Inc. All rights reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.DOMNode=function(e,t){this.ownerDocument=e,this.id=t.id,this.nodeType=t.nodeType,this.nodeName=t.nodeName,this.localName=t.localName,this._nodeValue=t.nodeValue,this.textContent=this.nodeValue,this.attributes=[],this._attributesMap={},t.attributes&&this._setAttributesPayload(t.attributes),this._childNodeCount=t.childNodeCount,this.children=null,this.nextSibling=null,this.prevSibling=null,this.firstChild=null,this.lastChild=null,this.parentNode=null,t.children&&this._setChildrenPayload(t.children),this._computedStyle=null,this.style=null,this._matchedCSSRules=[],this.breakpoints={},this.nodeType===Node.ELEMENT_NODE?(
// HTML and BODY from internal iframes should not overwrite top-level ones.
this.ownerDocument.documentElement||"HTML"!==this.nodeName||(this.ownerDocument.documentElement=this),this.ownerDocument.body||"BODY"!==this.nodeName||(this.ownerDocument.body=this),t.documentURL&&(this.documentURL=t.documentURL)):this.nodeType===Node.DOCUMENT_TYPE_NODE?(this.publicId=t.publicId,this.systemId=t.systemId,this.internalSubset=t.internalSubset):this.nodeType===Node.DOCUMENT_NODE?this.documentURL=t.documentURL:this.nodeType===Node.ATTRIBUTE_NODE&&(this.name=t.name,this.value=t.value)},WebInspector.DOMNode.prototype={hasAttributes:function(){return 0<this.attributes.length},hasChildNodes:function(){return 0<this._childNodeCount},get nodeValue(){return this._nodeValue},set nodeValue(e){this.nodeType==Node.TEXT_NODE&&this.ownerDocument._domAgent.setTextNodeValueAsync(this,e,function(){})},getAttribute:function(e){var t=this._attributesMap[e];return t?t.value:void 0},setAttribute:function(t,i){var n=this;this.ownerDocument._domAgent.setAttributeAsync(this,t,i,function(){var e=n._attributesMap[t];e?e.value=i:e=n._addAttribute(t,i)})},removeAttribute:function(t){var i=this;this.ownerDocument._domAgent.removeAttributeAsync(this,t,function(){delete i._attributesMap[t];for(var e=0;e<i.attributes.length;++e)if(i.attributes[e].name==t){i.attributes.splice(e,1);break}})},path:function(){for(var e=[],t=this;t&&"index"in t&&t.nodeName.length;)e.push([t.index,t.nodeName]),t=t.parentNode;return e.reverse(),e.join(",")},_setAttributesPayload:function(e){this.attributes=[],this._attributesMap={};for(var t=0;t<e.length;t+=2)this._addAttribute(e[t],e[t+1])},_insertChild:function(e,t){var i=new WebInspector.DOMNode(this.ownerDocument,t);return e?this.children.splice(this.children.indexOf(e)+1,0,i):this.children?this.children.unshift(i):
// First node
this.children=[i],this._renumber(),i},removeChild_:function(e){this.children.splice(this.children.indexOf(e),1),e.parentNode=null,this._renumber()},_setChildrenPayload:function(e){this.children=[];for(var t=0;t<e.length;++t){var i=e[t],n=new WebInspector.DOMNode(this.ownerDocument,i);this.children.push(n)}this._renumber()},_renumber:function(){if(this._childNodeCount=this.children.length,0==this._childNodeCount)return this.firstChild=null,void(this.lastChild=null);this.firstChild=this.children[0],this.lastChild=this.children[this._childNodeCount-1];for(var e=0;e<this._childNodeCount;++e){var t=this.children[e];t.index=e,t.nextSibling=e+1<this._childNodeCount?this.children[e+1]:null,t.prevSibling=0<=e-1?this.children[e-1]:null,t.parentNode=this}},_addAttribute:function(e,t){var i={name:e,value:t,_node:this};this._attributesMap[e]=i,this.attributes.push(i)}},WebInspector.DOMDocument=function(e,t,i){WebInspector.DOMNode.call(this,this,i),this._listeners={},this._domAgent=e,this.defaultView=t},WebInspector.DOMDocument.prototype={addEventListener:function(e,t){var i=this._listeners[e];i||(i=[],this._listeners[e]=i),i.push(t)},removeEventListener:function(e,t){var i=this._listeners[e];if(i){var n=i.indexOf(t);-1!=n&&i.splice(n,1)}},_fireDomEvent:function(e,t){var i=this._listeners[e];if(i)for(var n=0;n<i.length;++n){i[n].call(this,t)}}},WebInspector.DOMDocument.prototype.__proto__=WebInspector.DOMNode.prototype,WebInspector.DOMWindow=function(e){this._domAgent=e},WebInspector.DOMWindow.prototype={get document(){return this._domAgent.document},get Node(){return WebInspector.DOMNode},get Element(){return WebInspector.DOMNode},Object:function(){}},WebInspector.DOMAgent=function(){this._window=new WebInspector.DOMWindow(this),this._idToDOMNode=null,this.document=null,InspectorBackend.registerDomainDispatcher("DOM",new WebInspector.DOMDispatcher(this))},WebInspector.DOMAgent.prototype={get domWindow(){return this._window},getChildNodesAsync:function(e,t){var i=e.children;i?t(i):InspectorBackend.getChildNodes(e.id,function(){t(e.children)})},setAttributeAsync:function(e,t,i,n){var o=this._didApplyDomChange.bind(this,e,n);InspectorBackend.setAttribute(e.id,t,i,o)},removeAttributeAsync:function(e,t,i){var n=this._didApplyDomChange.bind(this,e,i);InspectorBackend.removeAttribute(e.id,t,n)},setTextNodeValueAsync:function(e,t,i){var n=this._didApplyDomChange.bind(this,e,i);InspectorBackend.setTextNodeValue(e.id,t,n)},_didApplyDomChange:function(e,t,i){if(i){t();
// TODO(pfeldman): Fix this hack.
var n=WebInspector.panels.elements.treeOutline.findTreeElement(e);n&&n.updateTitle()}},_attributesUpdated:function(e,t){var i=this._idToDOMNode[e];i._setAttributesPayload(t);var n={target:i};this.document._fireDomEvent("DOMAttrModified",n)},_characterDataModified:function(e,t){var i=this._idToDOMNode[e];i._nodeValue=t,i.textContent=t;var n={target:i};this.document._fireDomEvent("DOMCharacterDataModified",n)},nodeForId:function(e){return this._idToDOMNode[e]},_setDocument:function(e){this._idToDOMNode={},e&&"id"in e?(this.document=new WebInspector.DOMDocument(this,this._window,e),this._idToDOMNode[e.id]=this.document,this._bindNodes(this.document.children),WebInspector.breakpointManager.restoreDOMBreakpoints()):this.document=null,WebInspector.panels.elements.setDocument(this.document)},_setDetachedRoot:function(e){var t=new WebInspector.DOMNode(this.document,e);this._idToDOMNode[e.id]=t},_setChildNodes:function(e,t){var i=this._idToDOMNode[e];i._setChildrenPayload(t),this._bindNodes(i.children)},_bindNodes:function(e){for(var t=0;t<e.length;++t){var i=e[t];(this._idToDOMNode[i.id]=i).children&&this._bindNodes(i.children)}},_childNodeCountUpdated:function(e,t){var i=this._idToDOMNode[e];i._childNodeCount=t;var n=WebInspector.panels.elements.treeOutline.findTreeElement(i);n&&(n.hasChildren=t)},_childNodeInserted:function(e,t,i){var n=this._idToDOMNode[e],o=this._idToDOMNode[t],s=n._insertChild(o,i),r={target:this._idToDOMNode[s.id]=s,relatedNode:n};this.document._fireDomEvent("DOMNodeInserted",r)},_childNodeRemoved:function(e,t){var i=this._idToDOMNode[e],n=this._idToDOMNode[t];i.removeChild_(n);var o={target:n,relatedNode:i};this.document._fireDomEvent("DOMNodeRemoved",o),delete this._idToDOMNode[t],this._removeBreakpoints(n)},_removeBreakpoints:function(e){for(var t in e.breakpoints)e.breakpoints[t].remove();if(e.children)for(var i=0;i<e.children.length;++i)this._removeBreakpoints(e.children[i])}},WebInspector.DOMDispatcher=function(e){this._domAgent=e},WebInspector.DOMDispatcher.prototype={setDocument:function(e){this._domAgent._setDocument(e)},attributesUpdated:function(e,t){this._domAgent._attributesUpdated(e,t)},characterDataModified:function(e,t){this._domAgent._characterDataModified(e,t)},setChildNodes:function(e,t){this._domAgent._setChildNodes(e,t)},setDetachedRoot:function(e){this._domAgent._setDetachedRoot(e)},childNodeCountUpdated:function(e,t){this._domAgent._childNodeCountUpdated(e,t)},childNodeInserted:function(e,t,i){this._domAgent._childNodeInserted(e,t,i)},childNodeRemoved:function(e,t){this._domAgent._childNodeRemoved(e,t)}},WebInspector.ApplicationCacheDispatcher=function(){},WebInspector.ApplicationCacheDispatcher.getApplicationCachesAsync=function(t){InspectorBackend.getApplicationCaches(function(e){
// FIXME: Currently, this list only returns a single application cache.
e&&t(e)})},WebInspector.ApplicationCacheDispatcher.prototype={updateApplicationCacheStatus:function(e){WebInspector.panels.resources.updateApplicationCacheStatus(e)},updateNetworkState:function(e){WebInspector.panels.resources.updateNetworkState(e)}},InspectorBackend.registerDomainDispatcher("ApplicationCache",new WebInspector.ApplicationCacheDispatcher),WebInspector.Cookies={},WebInspector.Cookies.getCookiesAsync=function(i){InspectorBackend.getCookies(function(e,t){t?i(WebInspector.Cookies.buildCookiesFromString(t),!1):i(e,!0)})},WebInspector.Cookies.buildCookiesFromString=function(e){var t=e.split(/;\s*/),i=[];if(!/^\s*$/.test(e))for(var n=0;n<t.length;++n){var o=t[n],s=o.indexOf("="),r=o.substring(0,s),d=o.substring(s+1),h=r.length+d.length;i.push({name:r,value:d,size:h})}return i},WebInspector.Cookies.cookieMatchesResourceURL=function(e,t){var i=t.asParsedURL();return!(!i||!this.cookieDomainMatchesResourceDomain(e.domain,i.host))&&!(0!==i.path.indexOf(e.path)||e.port&&i.port!=e.port||e.secure&&"https"!==i.scheme)},WebInspector.Cookies.cookieDomainMatchesResourceDomain=function(e,t){return"."!==e.charAt(0)?t===e:!!t.match(new RegExp("^([^\\.]+\\.)?"+e.substring(1).escapeForRegExp()+"$"),"i")},WebInspector.EventListeners={},WebInspector.EventListeners.getEventListenersForNodeAsync=function(e,t){e&&InspectorBackend.getEventListenersForNode(e.id,t)};