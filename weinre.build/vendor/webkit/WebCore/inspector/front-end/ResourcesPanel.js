/*
 * Copyright (C) 2007, 2008, 2010 Apple Inc.  All rights reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.ResourcesPanel=function(e){WebInspector.Panel.call(this,"resources"),WebInspector.settings.installApplicationSetting("resourcesLastSelectedItem",{}),this.createSidebar(),this.sidebarElement.addStyleClass("outline-disclosure filter-all children small"),this.sidebarTreeElement.removeStyleClass("sidebar-tree"),this.resourcesListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Frames"),"Frames","frame-storage-tree-item"),this.sidebarTree.appendChild(this.resourcesListTreeElement),this._treeElementForFrameId={},this.databasesListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Databases"),"Databases","database-storage-tree-item"),this.sidebarTree.appendChild(this.databasesListTreeElement),this.localStorageListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Local Storage"),"LocalStorage","domstorage-storage-tree-item local-storage"),this.sidebarTree.appendChild(this.localStorageListTreeElement),this.sessionStorageListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Session Storage"),"SessionStorage","domstorage-storage-tree-item session-storage"),this.sidebarTree.appendChild(this.sessionStorageListTreeElement),this.cookieListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Cookies"),"Cookies","cookie-storage-tree-item"),this.sidebarTree.appendChild(this.cookieListTreeElement),this.applicationCacheListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Application Cache"),"ApplicationCache","application-cache-storage-tree-item"),this.sidebarTree.appendChild(this.applicationCacheListTreeElement),this.storageViews=document.createElement("div"),this.storageViews.id="storage-views",this.storageViews.className="diff-container",this.element.appendChild(this.storageViews),this.storageViewStatusBarItemsContainer=document.createElement("div"),this.storageViewStatusBarItemsContainer.className="status-bar-items",this._databases=[],this._domStorage=[],this._cookieViews={},this._origins={},this._domains={},this.sidebarElement.addEventListener("mousemove",this._onmousemove.bind(this),!1),this.sidebarElement.addEventListener("mouseout",this._onmouseout.bind(this),!1),WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.ResourceUpdated,this._refreshResource,this)},WebInspector.ResourcesPanel.prototype={get toolbarItemLabel(){return WebInspector.UIString("Resources")},get statusBarItems(){return[this.storageViewStatusBarItemsContainer]},elementsToRestoreScrollPositionsFor:function(){return[this.sidebarElement]},show:function(){WebInspector.Panel.prototype.show.call(this),this.visibleView&&this.visibleView.resource&&this._showResourceView(this.visibleView.resource),this._initDefaultSelection()},loadEventFired:function(){this._initDefaultSelection()},_initDefaultSelection:function(){if(!this._initializedDefaultSelection){this._initializedDefaultSelection=!0;var e=WebInspector.settings.resourcesLastSelectedItem;if(e)for(var t=this.sidebarTree.children[0];t;t=t.traverseNextTreeElement(!1,this.sidebarTree,!0))if(t.itemURL===e)return t.select(),void t.reveal();WebInspector.mainResource&&this.resourcesListTreeElement&&this.resourcesListTreeElement.expanded&&this.showResource(WebInspector.mainResource)}},reset:function(){delete this._initializedDefaultSelection,this._origins={},this._domains={};for(var e=0;e<this._databases.length;++e){var t=this._databases[e];delete t._tableViews,delete t._queryView}this._databases=[];for(this._domStorage.length,e=0;e<this._domStorage.length;++e){delete this._domStorage[e]._domStorageView}this._domStorage=[],this._cookieViews={},this._applicationCacheView=null,delete this._cachedApplicationCacheViewStatus,this.databasesListTreeElement.removeChildren(),this.localStorageListTreeElement.removeChildren(),this.sessionStorageListTreeElement.removeChildren(),this.cookieListTreeElement.removeChildren(),this.applicationCacheListTreeElement.removeChildren(),this.storageViews.removeChildren(),this.storageViewStatusBarItemsContainer.removeChildren(),this.sidebarTree.selectedTreeElement&&this.sidebarTree.selectedTreeElement.deselect()},clear:function(){this.resourcesListTreeElement.removeChildren(),this._treeElementForFrameId={},this.reset()},addOrUpdateFrame:function(e,t,s,r){if(o=this._treeElementForFrameId[t])o.setTitles(s,r);else{var i=e?this._treeElementForFrameId[e]:this.resourcesListTreeElement;if(i){var o=new WebInspector.FrameTreeElement(this,t,s,r);this._treeElementForFrameId[t]=o;for(
// Insert in the alphabetical order, first frames, then resources.
var n=i.children,a=0;a<n.length;++a){var l=n[a];if(!(l instanceof WebInspector.FrameTreeElement))return void i.insertChild(o,a);if(0<l.displayName.localeCompare(o.displayName))return void i.insertChild(o,a)}i.appendChild(o)}else console.warning("No frame with id:"+e+" to route "+displayName+" to.")}},removeFrame:function(e){var t=this._treeElementForFrameId[e];t&&(delete this._treeElementForFrameId[e],t.parent&&t.parent.removeChild(t))},addResourceToFrame:function(e,t){if(this.addDocumentURL(t.documentURL),!(301<=t.statusCode&&t.statusCode<=303)){var s=this._treeElementForFrameId[e];if(s){for(var r=new WebInspector.FrameResourceTreeElement(this,t),i=s.children,o=0
// Insert in the alphabetical order, first frames, then resources. Document resource goes first.
;o<i.length;++o){var n=i[o];if(n instanceof WebInspector.FrameResourceTreeElement&&(t.type===WebInspector.Resource.Type.Document||n._resource.type!==WebInspector.Resource.Type.Document&&0<n._resource.displayName.localeCompare(t.displayName)))return void s.insertChild(r,o)}s.appendChild(r)}}},removeResourcesFromFrame:function(e){var t=this._treeElementForFrameId[e];t&&t.removeChildren()},_refreshResource:function(e){var t=e.data;
// FIXME: do not add XHR in the first place based on the native instrumentation.
if(t.type===WebInspector.Resource.Type.XHR){var s=this._findTreeElementForResource(t);s&&s.parent.removeChild(s)}},addDatabase:function(e){this._databases.push(e);var t=new WebInspector.DatabaseTreeElement(this,e);e._databasesTreeElement=t,this.databasesListTreeElement.appendChild(t)},addDocumentURL:function(e){var t=e.asParsedURL();if(t){var s=t.host;if(!this._domains[s]){this._domains[s]=!0;var r=new WebInspector.CookieTreeElement(this,s);this.cookieListTreeElement.appendChild(r);var i=new WebInspector.ApplicationCacheTreeElement(this,s);this.applicationCacheListTreeElement.appendChild(i)}}},addDOMStorage:function(e){this._domStorage.push(e);var t=new WebInspector.DOMStorageTreeElement(this,e,e.isLocalStorage?"local-storage":"session-storage");e._domStorageTreeElement=t,e.isLocalStorage?this.localStorageListTreeElement.appendChild(t):this.sessionStorageListTreeElement.appendChild(t)},selectDatabase:function(e){for(var t,s=0,r=this._databases.length;s<r;++s)if((t=this._databases[s]).id===e)return this.showDatabase(t),void t._databasesTreeElement.select()},selectDOMStorage:function(e){var t=this._domStorageForId(e);t&&(this.showDOMStorage(t),t._domStorageTreeElement.select())},canShowSourceLine:function(e,t){return!!WebInspector.resourceForURL(e)},showSourceLine:function(e,t){WebInspector.resourceForURL(e).type!==WebInspector.Resource.Type.XHR?this.showResource(WebInspector.resourceForURL(e),t):
// Show XHRs in the network panel only.
WebInspector.panels.network&&WebInspector.panels.network.canShowSourceLine(e,t)&&(WebInspector.currentPanel=WebInspector.panels.network,WebInspector.panels.network.showSourceLine(e,t))},showResource:function(e,t){var s=this._findTreeElementForResource(e);if(s&&(s.reveal(),s.select()),t){var r=WebInspector.ResourceView.resourceViewForResource(e);r.revealLine&&r.revealLine(t),r.highlightLine&&r.highlightLine(t)}return!0},_showResourceView:function(t){var s=WebInspector.ResourceView.resourceViewForResource(t);
// Consider rendering diff markup here.
if(t.baseRevision&&s instanceof WebInspector.SourceFrame){t.baseRevision.requestContent(function(e){e&&this._applyDiffMarkup(s,e,t.content)}.bind(this))}this._innerShowView(s)},_applyDiffMarkup:function(e,t,s){for(var r=t.split("\n"),i=s.split("\n"),o={added:[],removed:[],changed:[]},n=0,a=Array.diff(r,i).right,l=0;l<a.length;++l)"string"==typeof a[l]?a.length>l+1&&a[l+1].row===l+1-n?o.changed.push(l):(o.added.push(l),n++):n=l-a[l].row;e.markDiff(o)},showDatabase:function(e,t){var s;e&&(t?("_tableViews"in e||(e._tableViews={}),(s=e._tableViews[t])||(s=new WebInspector.DatabaseTableView(e,t),e._tableViews[t]=s)):(s=e._queryView)||(s=new WebInspector.DatabaseQueryView(e),e._queryView=s),this._innerShowView(s))},showDOMStorage:function(e){var t;e&&((t=e._domStorageView)||(t=new WebInspector.DOMStorageItemsView(e),e._domStorageView=t),this._innerShowView(t))},showCookies:function(e,t){var s=this._cookieViews[t];s||(s=new WebInspector.CookieItemsView(e,t),this._cookieViews[t]=s),this._innerShowView(s)},showApplicationCache:function(e,t){var s=this._applicationCacheView;s||(s=new WebInspector.ApplicationCacheItemsView(e,t),this._applicationCacheView=s),this._innerShowView(s),"_cachedApplicationCacheViewStatus"in this&&this._applicationCacheView.updateStatus(this._cachedApplicationCacheViewStatus)},showCategoryView:function(e){this._categoryView||(this._categoryView=new WebInspector.StorageCategoryView),this._categoryView.setText(e),this._innerShowView(this._categoryView)},_innerShowView:function(e){this.visibleView&&this.visibleView.hide(),e.show(this.storageViews),this.visibleView=e,this.storageViewStatusBarItemsContainer.removeChildren();for(var t=e.statusBarItems||[],s=0;s<t.length;++s)this.storageViewStatusBarItemsContainer.appendChild(t[s])},closeVisibleView:function(){this.visibleView&&this.visibleView.hide(),delete this.visibleView},updateDatabaseTables:function(i){if(i&&i._databasesTreeElement&&(i._databasesTreeElement.shouldRefreshChildren=!0,"_tableViews"in i)){var o={},n=this;i.getTableNames(function(e){for(var t=e.length,s=0;s<t;++s)o[e[s]]=!0;for(var r in i._tableViews)r in o||(n.visibleView===i._tableViews[r]&&n.closeVisibleView(),delete i._tableViews[r])})}},dataGridForResult:function(e,t){var s=e.length;if(!s)return null;for(var r={},i=0;i<e.length;++i){var o={};o.width=e[i].length,o.title=e[i],o.sortable=!0,r[e[i]]=o}var n=[];for(i=0;i<t.length/s;++i){for(var a={},l=0;l<e.length;++l)a[e[l]]=t[s*i+l];var c=new WebInspector.DataGridNode(a,!1);c.selectable=!1,n.push(c)}var h=new WebInspector.DataGrid(r),p=n.length;for(i=0;i<p;++i)h.appendChild(n[i]);return h.addEventListener("sorting changed",this._sortDataGrid.bind(this,h),this),h},_sortDataGrid:function(e){for(var t=e.children.slice(),a=e.sortColumnIdentifier,l="ascending"===e.sortOrder?1:-1,c=!0,s=0;s<t.length;s++)isNaN(Number(t[s].data[a]))&&(c=!1);t.sort(function(e,t){var s,r=e.data[a],i=t.data[a];if(c){
// Sort numbers based on comparing their values rather than a lexicographical comparison.
var o=parseFloat(r),n=parseFloat(i);s=o<n?-1:n<o?1:0}else s=r<i?-1:i<r?1:0;return l*s}),e.removeChildren();for(s=0;s<t.length;s++)e.appendChild(t[s])},updateDOMStorage:function(e){var t=this._domStorageForId(e);if(t){var s=t._domStorageView;this.visibleView&&s===this.visibleView&&t._domStorageView.update()}},updateApplicationCacheStatus:function(e){this._cachedApplicationCacheViewStatus=e,this._applicationCacheView&&this._applicationCacheView===this.visibleView&&this._applicationCacheView.updateStatus(e)},updateNetworkState:function(e){this._applicationCacheView&&this._applicationCacheView===this.visibleView&&this._applicationCacheView.updateNetworkState(e)},updateManifest:function(e){this._applicationCacheView&&this._applicationCacheView===this.visibleView&&this._applicationCacheView.updateManifest(e)},_domStorageForId:function(e){if(!this._domStorage)return null;for(var t=this._domStorage.length,s=0;s<t;++s){var r=this._domStorage[s];if(r.id==e)return r}return null},updateMainViewWidth:function(e){this.storageViews.style.left=e+"px",this.storageViewStatusBarItemsContainer.style.left=e+"px",this.resize()},get searchableViews(){var r=[],i=this.visibleView;return i.performSearch&&r.push(i),this._forAllResourceTreeElements(function(e){var t=e._resource,s=WebInspector.ResourceView.resourceViewForResource(t);s.performSearch&&s!==i&&r.push(s)}),r},_forAllResourceTreeElements:function(e){for(var t=!1,s=this.resourcesListTreeElement;!t&&s;s=s.traverseNextTreeElement(!1,this.resourcesListTreeElement,!0))s instanceof WebInspector.FrameResourceTreeElement&&(t=e(s))},searchMatchFound:function(e,t){if(e.resource){var s=this._findTreeElementForResource(e.resource);s&&s.searchMatchFound(t)}},_findTreeElementForResource:function(e){return this.sidebarTree.findTreeElement(e,function(e,t){
// Redirects, XHRs do not belong to the tree, it is fine to silently return false here.
return!1},function(e){
// Redirects, XHRs do not belong to the tree, it is fine to silently return false here.
return null})},searchCanceled:function(e){WebInspector.Panel.prototype.searchCanceled.call(this,e),e||this._forAllResourceTreeElements(function(e){e._errorsWarningsUpdated()})},performSearch:function(e){this._forAllResourceTreeElements(function(e){e._resetBubble()}),WebInspector.Panel.prototype.performSearch.call(this,e)},showView:function(e){e&&this.showResource(e.resource)},_onmousemove:function(e){var t=document.elementFromPoint(e.pageX,e.pageY);if(t){var s=t.enclosingNodeOrSelfWithNodeName("li");if(s){var r=s.treeElement;this._previousHoveredElement!==r&&(this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement),r instanceof WebInspector.FrameTreeElement&&((this._previousHoveredElement=r).hovered=!0))}}},_onmouseout:function(e){this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement)}},WebInspector.ResourcesPanel.prototype.__proto__=WebInspector.Panel.prototype,WebInspector.BaseStorageTreeElement=function(e,t,s,r,i){TreeElement.call(this,"",t,i),this._storagePanel=e,this._titleText=s,this._iconClass=r},WebInspector.BaseStorageTreeElement.prototype={onattach:function(){this.listItemElement.removeChildren(),this.listItemElement.addStyleClass(this._iconClass);var e=document.createElement("div");e.className="selection",this.listItemElement.appendChild(e),this.imageElement=document.createElement("img"),this.imageElement.className="icon",this.listItemElement.appendChild(this.imageElement),this.titleElement=document.createElement("div"),this.titleElement.className="base-storage-tree-element-title",this.titleElement.textContent=this._titleText,this.listItemElement.appendChild(this.titleElement)},onselect:function(){var e=this.itemURL;e&&(WebInspector.settings.resourcesLastSelectedItem=e)},onreveal:function(){this.listItemElement&&this.listItemElement.scrollIntoViewIfNeeded(!1)},get titleText(){return this._titleText},set titleText(e){this._titleText=e,this.titleElement&&(this.titleElement.textContent=this._titleText)},isEventWithinDisclosureTriangle:function(){
// Override it since we use margin-left in place of treeoutline's text-indent.
// Hence we need to take padding into consideration. This all is needed for leading
// icons in the tree.
var e=this.listItemElement.totalOffsetLeft+14;return event.pageX>=e&&event.pageX<=e+this.arrowToggleWidth&&this.hasChildren}},WebInspector.BaseStorageTreeElement.prototype.__proto__=TreeElement.prototype,WebInspector.StorageCategoryTreeElement=function(e,t,s,r){WebInspector.BaseStorageTreeElement.call(this,e,null,t,r,!0),this._expandedSettingKey="resources"+s+"Expanded",WebInspector.settings.installApplicationSetting(this._expandedSettingKey,"Frames"===s),this._categoryName=t},WebInspector.StorageCategoryTreeElement.prototype={get itemURL(){return"category://"+this._categoryName},onselect:function(){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this),this._storagePanel.showCategoryView(this._categoryName)},onattach:function(){WebInspector.BaseStorageTreeElement.prototype.onattach.call(this),WebInspector.settings[this._expandedSettingKey]&&this.expand()},onexpand:function(){WebInspector.settings[this._expandedSettingKey]=!0},oncollapse:function(){WebInspector.settings[this._expandedSettingKey]=!1}},WebInspector.StorageCategoryTreeElement.prototype.__proto__=WebInspector.BaseStorageTreeElement.prototype,WebInspector.FrameTreeElement=function(e,t,s,r){WebInspector.BaseStorageTreeElement.call(this,e,null,"","frame-storage-tree-item"),this._frameId=t,this.setTitles(s,r)},WebInspector.FrameTreeElement.prototype={get itemURL(){return"frame://"+encodeURI(this._displayName)},onattach:function(){WebInspector.BaseStorageTreeElement.prototype.onattach.call(this),(this._titleToSetOnAttach||this._subtitleToSetOnAttach)&&(this.setTitles(this._titleToSetOnAttach,this._subtitleToSetOnAttach),delete this._titleToSetOnAttach,delete this._subtitleToSetOnAttach)},onselect:function(){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this),this._storagePanel.showCategoryView(this._displayName),this.listItemElement.removeStyleClass("hovered"),InspectorBackend.hideFrameHighlight()},get displayName(){return this._displayName},setTitles:function(e,t){if(this._displayName="",this.parent){if(e&&(this.titleElement.textContent=e,this._displayName=e),t){var s=document.createElement("span");s.className="base-storage-tree-element-subtitle",s.textContent="("+t+")",this._displayName+=" ("+t+")",this.titleElement.appendChild(s)}}else this._titleToSetOnAttach=e,this._subtitleToSetOnAttach=t},set hovered(e){e?(this.listItemElement.addStyleClass("hovered"),InspectorBackend.highlightFrame(this._frameId)):(this.listItemElement.removeStyleClass("hovered"),InspectorBackend.hideFrameHighlight())}},WebInspector.FrameTreeElement.prototype.__proto__=WebInspector.BaseStorageTreeElement.prototype,WebInspector.FrameResourceTreeElement=function(e,t){WebInspector.BaseStorageTreeElement.call(this,e,t,t.displayName,"resource-sidebar-tree-item resources-category-"+t.category.name),this._resource=t,this._resource.addEventListener("errors-warnings-updated",this._errorsWarningsUpdated,this),this._resource.addEventListener("content-changed",this._contentChanged,this),this.tooltip=t.url},WebInspector.FrameResourceTreeElement.prototype={get itemURL(){return this._resource.url},onselect:function(){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this),this._storagePanel._showResourceView(this._resource)},ondblclick:function(e){InspectorBackend.openInInspectedWindow(this._resource.url)},onattach:function(){if(WebInspector.BaseStorageTreeElement.prototype.onattach.call(this),this._resource.category===WebInspector.resourceCategories.images){var e=document.createElement("img");e.className="image-resource-icon-preview",this._resource.populateImageSource(e);var t=document.createElement("div");t.className="icon",t.appendChild(e),this.listItemElement.replaceChild(t,this.imageElement)}this._statusElement=document.createElement("div"),this._statusElement.className="status",this.listItemElement.insertBefore(this._statusElement,this.titleElement),this.listItemElement.draggable=!0,this.listItemElement.addEventListener("dragstart",this._ondragstart.bind(this),!1)},_ondragstart:function(e){return e.dataTransfer.setData("text/plain",this._resource.content),e.dataTransfer.effectAllowed="copy",!0},_setBubbleText:function(e){this._bubbleElement||(this._bubbleElement=document.createElement("div"),this._bubbleElement.className="bubble",this._statusElement.appendChild(this._bubbleElement)),this._bubbleElement.textContent=e},_resetBubble:function(){this._bubbleElement&&(this._bubbleElement.textContent="",this._bubbleElement.removeStyleClass("search-matches"),this._bubbleElement.removeStyleClass("warning"),this._bubbleElement.removeStyleClass("error"))},searchMatchFound:function(e){this._resetBubble(),this._setBubbleText(e),this._bubbleElement.addStyleClass("search-matches");for(
// Expand, do not scroll into view.
var t=this.parent;t&&!t.root;)t.expanded||t.expand(),t=t.parent},_errorsWarningsUpdated:function(){
// FIXME: move to the SourceFrame.
if(!this._resource.warnings&&!this._resource.errors){var e=WebInspector.ResourceView.existingResourceViewForResource(this._resource);e&&e.clearMessages&&e.clearMessages()}this._storagePanel.currentQuery||(this._resetBubble(),(this._resource.warnings||this._resource.errors)&&this._setBubbleText(this._resource.warnings+this._resource.errors),this._resource.warnings&&this._bubbleElement.addStyleClass("warning"),this._resource.errors&&this._bubbleElement.addStyleClass("error"))},_contentChanged:function(e){this.insertChild(new WebInspector.ResourceRevisionTreeElement(this._storagePanel,e.data.revision),0);var t=WebInspector.ResourceView.existingResourceViewForResource(this._resource);if(t){var s=WebInspector.ResourceView.recreateResourceView(this._resource);t===this._storagePanel.visibleView&&(this._storagePanel.visibleView=s)}}},WebInspector.FrameResourceTreeElement.prototype.__proto__=WebInspector.BaseStorageTreeElement.prototype,WebInspector.DatabaseTreeElement=function(e,t){WebInspector.BaseStorageTreeElement.call(this,e,null,t.name,"database-storage-tree-item",!0),this._database=t},WebInspector.DatabaseTreeElement.prototype={get itemURL(){return"database://"+encodeURI(this._database.name)},onselect:function(){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this),this._storagePanel.showDatabase(this._database)},oncollapse:function(){
// Request a refresh after every collapse so the next
// expand will have an updated table list.
this.shouldRefreshChildren=!0},onpopulate:function(){this.removeChildren(),this._database.getTableNames(function(e){for(var t=e.length,s=0;s<t;++s)this.appendChild(new WebInspector.DatabaseTableTreeElement(this._storagePanel,this._database,e[s]))}.bind(this))}},WebInspector.DatabaseTreeElement.prototype.__proto__=WebInspector.BaseStorageTreeElement.prototype,WebInspector.DatabaseTableTreeElement=function(e,t,s){WebInspector.BaseStorageTreeElement.call(this,e,null,s,"database-storage-tree-item"),this._database=t,this._tableName=s},WebInspector.DatabaseTableTreeElement.prototype={get itemURL(){return"database://"+encodeURI(this._database.name)+"/"+encodeURI(this._tableName)},onselect:function(){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this),this._storagePanel.showDatabase(this._database,this._tableName)}},WebInspector.DatabaseTableTreeElement.prototype.__proto__=WebInspector.BaseStorageTreeElement.prototype,WebInspector.DOMStorageTreeElement=function(e,t,s){WebInspector.BaseStorageTreeElement.call(this,e,null,t.domain?t.domain:WebInspector.UIString("Local Files"),"domstorage-storage-tree-item "+s),this._domStorage=t},WebInspector.DOMStorageTreeElement.prototype={get itemURL(){return"storage://"+this._domStorage.domain+"/"+(this._domStorage.isLocalStorage?"local":"session")},onselect:function(){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this),this._storagePanel.showDOMStorage(this._domStorage)}},WebInspector.DOMStorageTreeElement.prototype.__proto__=WebInspector.BaseStorageTreeElement.prototype,WebInspector.CookieTreeElement=function(e,t){WebInspector.BaseStorageTreeElement.call(this,e,null,t||WebInspector.UIString("Local Files"),"cookie-storage-tree-item"),this._cookieDomain=t},WebInspector.CookieTreeElement.prototype={get itemURL(){return"cookies://"+this._cookieDomain},onselect:function(){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this),this._storagePanel.showCookies(this,this._cookieDomain)}},WebInspector.CookieTreeElement.prototype.__proto__=WebInspector.BaseStorageTreeElement.prototype,WebInspector.ApplicationCacheTreeElement=function(e,t){WebInspector.BaseStorageTreeElement.call(this,e,null,t||WebInspector.UIString("Local Files"),"application-cache-storage-tree-item"),this._appcacheDomain=t},WebInspector.ApplicationCacheTreeElement.prototype={get itemURL(){return"appcache://"+this._appcacheDomain},onselect:function(){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this),this._storagePanel.showApplicationCache(this,this._appcacheDomain)}},WebInspector.ApplicationCacheTreeElement.prototype.__proto__=WebInspector.BaseStorageTreeElement.prototype,WebInspector.ResourceRevisionTreeElement=function(e,t){var s=t.timestamp?t.timestamp.toLocaleTimeString():WebInspector.UIString("(original)");WebInspector.BaseStorageTreeElement.call(this,e,null,s,"resource-sidebar-tree-item resources-category-"+t.category.name),t.timestamp&&(this.tooltip=t.timestamp.toLocaleString()),this._resource=t},WebInspector.ResourceRevisionTreeElement.prototype={onattach:function(){WebInspector.BaseStorageTreeElement.prototype.onattach.call(this),this.listItemElement.draggable=!0,this.listItemElement.addEventListener("dragstart",this._ondragstart.bind(this),!1),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)},onselect:function(){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this),this._storagePanel._showResourceView(this._resource)},_ondragstart:function(e){return e.dataTransfer.setData("text/plain",this._resource.content),e.dataTransfer.effectAllowed="copy",!0},_handleContextMenuEvent:function(e){var t=new WebInspector.ContextMenu;t.appendItem(WebInspector.UIString("Revert to this revision"),this._resource.revertToThis.bind(this._resource)),t.show(e)}},WebInspector.ResourceRevisionTreeElement.prototype.__proto__=WebInspector.BaseStorageTreeElement.prototype,WebInspector.StorageCategoryView=function(){WebInspector.View.call(this),this.element.addStyleClass("storage-view"),this._emptyMsgElement=document.createElement("div"),this._emptyMsgElement.className="storage-empty-view",this.element.appendChild(this._emptyMsgElement)},WebInspector.StorageCategoryView.prototype={setText:function(e){this._emptyMsgElement.textContent=e}},WebInspector.StorageCategoryView.prototype.__proto__=WebInspector.View.prototype;