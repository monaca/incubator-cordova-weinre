/*
 * Copyright (C) 2009 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.SourceFrame=function(e,t,i){WebInspector.View.call(this),this.element.addStyleClass("script-view"),this._contentProvider=e,this._url=t,this._isScript=i,this._textModel=new WebInspector.TextEditorModel,this._textModel.replaceTabsWithSpaces=!0,this._currentSearchResultIndex=-1,this._searchResults=[],this._messages=[],this._rowMessages={},this._messageBubbles={},this._popoverObjectGroup="popover"},WebInspector.SourceFrame.prototype={show:function(e){WebInspector.View.prototype.show.call(this,e),this._contentRequested||(this._contentRequested=!0,this._contentProvider.requestContent(this._createTextViewer.bind(this))),this._textViewer&&(this._scrollTop&&(this._textViewer.scrollTop=this._scrollTop),this._scrollLeft&&(this._textViewer.scrollLeft=this._scrollLeft),this._textViewer.resize())},hide:function(){this._textViewer&&(this._scrollTop=this._textViewer.scrollTop,this._scrollLeft=this._textViewer.scrollLeft,this._textViewer.freeCachedElements()),WebInspector.View.prototype.hide.call(this),this._hidePopup(),this._clearLineHighlight()},hasContent:function(){return!0},markDiff:function(e){this._diffLines&&this._textViewer&&this._removeDiffDecorations(),this._diffLines=e,this._textViewer&&this._updateDiffDecorations()},revealLine:function(e){this._textViewer?this._textViewer.revealLine(e-1,0):this._lineNumberToReveal=e},addMessage:function(e){
// Don't add the message if there is no message or valid line or if the msg isn't an error or warning.
!e.message||e.line<=0||!e.isErrorOrWarning()||(this._messages.push(e),this._textViewer&&this._addMessageToSource(e))},clearMessages:function(){for(var e in this._messageBubbles){var t=this._messageBubbles[e];t.parentNode.removeChild(t)}this._messages=[],this._rowMessages={},this._messageBubbles={},this._textViewer&&this._textViewer.resize()},sizeToFitContentHeight:function(){this._textViewer&&this._textViewer.revalidateDecorationsAndPaint()},get textModel(){return this._textModel},get scrollTop(){return this._textViewer?this._textViewer.scrollTop:this._scrollTop},set scrollTop(e){this._scrollTop=e,this._textViewer&&(this._textViewer.scrollTop=e)},highlightLine:function(e){this._textViewer?this._textViewer.highlightLine(e-1):this._lineToHighlight=e},_clearLineHighlight:function(){this._textViewer?this._textViewer.clearLineHighlight():delete this._lineToHighlight},_createTextViewer:function(e,t){this._content=t,this._textModel.setText(null,t.text),this._textViewer=new WebInspector.TextViewer(this._textModel,WebInspector.platform,this._url);var i=this._textViewer.element;i.addEventListener("contextmenu",this._contextMenu.bind(this),!0),i.addEventListener("mousedown",this._mouseDown.bind(this),!0),i.addEventListener("mousemove",this._mouseMove.bind(this),!0),i.addEventListener("scroll",this._scroll.bind(this),!0),i.addEventListener("dblclick",this._doubleClick.bind(this),!0),this.element.appendChild(i),this._textViewer.beginUpdates(),this._textViewer.mimeType=e,this._setTextViewerDecorations(),this._lineNumberToReveal&&(this.revealLine(this._lineNumberToReveal),delete this._lineNumberToReveal),this._lineToHighlight&&(this.highlightLine(this._lineToHighlight),delete this._lineToHighlight),this._delayedFindSearchMatches&&(this._delayedFindSearchMatches(),delete this._delayedFindSearchMatches),this._textViewer.endUpdates(),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.BreakpointAdded,this._breakpointAdded,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.BreakpointRemoved,this._breakpointRemoved,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.BreakpointResolved,this._breakpointResolved,this)},_setTextViewerDecorations:function(){this._rowMessages={},this._messageBubbles={},this._textViewer.beginUpdates(),this._addExistingMessagesToSource(),this._updateDiffDecorations(),this._executionLocation&&this._setExecutionLocation(),this._breakpointIdToTextViewerLineNumber={},this._textViewerLineNumberToBreakpointId={};var e=WebInspector.debuggerModel.breakpoints;for(var t in e)this._breakpointAdded({data:e[t]});this._textViewer.resize(),this._textViewer.endUpdates()},_shouldDisplayBreakpoint:function(e){if(this._url)return this._url===e.url;for(var t=this._content.scriptRanges,i=0;i<t.length;++i)if(e.sourceID===t[i].sourceID)return!0;return!1},performSearch:function(e,i){function t(e){this._currentSearchResultIndex=-1,this._searchResults=[];
// First do case-insensitive search.
var t=createSearchRegex(e);this._collectRegexMatches(t,this._searchResults);
// Then try regex search if user knows the / / hint.
try{/^\/.*\/$/.test(e)&&this._collectRegexMatches(new RegExp(e.substring(1,e.length-1)),this._searchResults)}catch(e){
// Silent catch.
}i(this,this._searchResults.length)}
// Call searchCanceled since it will reset everything we need before doing a new search.
this.searchCanceled(),this._textViewer?t.call(this,e):this._delayedFindSearchMatches=t.bind(this,e)},searchCanceled:function(){delete this._delayedFindSearchMatches,this._textViewer&&(this._currentSearchResultIndex=-1,this._searchResults=[],this._textViewer.markAndRevealRange(null))},jumpToFirstSearchResult:function(){this._jumpToSearchResult(0)},jumpToLastSearchResult:function(){this._jumpToSearchResult(this._searchResults.length-1)},jumpToNextSearchResult:function(){this._jumpToSearchResult(this._currentSearchResultIndex+1)},jumpToPreviousSearchResult:function(){this._jumpToSearchResult(this._currentSearchResultIndex-1)},showingFirstSearchResult:function(){return this._searchResults.length&&0===this._currentSearchResultIndex},showingLastSearchResult:function(){return this._searchResults.length&&this._currentSearchResultIndex===this._searchResults.length-1},_jumpToSearchResult:function(e){this._textViewer&&this._searchResults.length&&(this._currentSearchResultIndex=(e+this._searchResults.length)%this._searchResults.length,this._textViewer.markAndRevealRange(this._searchResults[this._currentSearchResultIndex]))},_collectRegexMatches:function(e,t){for(var i=0;i<this._textModel.linesCount;++i){var n=this._textModel.line(i),s=0;do{var o=e.exec(n);o&&(t.push(new WebInspector.TextRange(i,s+o.index,i,s+o.index+o[0].length)),s+=o.index+1,n=n.substring(o.index+1))}while(o)}return t},_incrementMessageRepeatCount:function(e,t){if(e._resourceMessageLineElement){if(!e._resourceMessageRepeatCountElement){var i=document.createElement("span");e._resourceMessageLineElement.appendChild(i),e._resourceMessageRepeatCountElement=i}e.repeatCount+=t,e._resourceMessageRepeatCountElement.textContent=WebInspector.UIString(" (repeated %d times)",e.repeatCount)}},setExecutionLocation:function(e,t){this._executionLocation={lineNumber:e,columnNumber:t},this._textViewer&&this._setExecutionLocation()},clearExecutionLocation:function(){if(this._textViewer){var e=this._content.actualLocationToSourceFrameLineNumber(this._executionLocation.lineNumber,this._executionLocation.columnNumber);this._textViewer.removeDecoration(e,"webkit-execution-line")}delete this._executionLocation},_setExecutionLocation:function(){var e=this._content.actualLocationToSourceFrameLineNumber(this._executionLocation.lineNumber,this._executionLocation.columnNumber);this._textViewer.addDecoration(e,"webkit-execution-line")},_updateDiffDecorations:function(){function e(e,t,i){for(var n=0;n<t.length;++n)e.addDecoration(t[n],i)}this._diffLines&&(e(this._textViewer,this._diffLines.added,"webkit-added-line"),e(this._textViewer,this._diffLines.removed,"webkit-removed-line"),e(this._textViewer,this._diffLines.changed,"webkit-changed-line"))},_removeDiffDecorations:function(){function e(e,t,i){for(var n=0;n<t.length;++n)e.removeDecoration(t[n],i)}e(this._textViewer,this._diffLines.added,"webkit-added-line"),e(this._textViewer,this._diffLines.removed,"webkit-removed-line"),e(this._textViewer,this._diffLines.changed,"webkit-changed-line")},_addExistingMessagesToSource:function(){for(var e=this._messages.length,t=0;t<e;++t)this._addMessageToSource(this._messages[t])},_addMessageToSource:function(e){if(!(e.line>this._textModel.linesCount)){var t=this._messageBubbles[e.line];t&&t.nodeType===Node.ELEMENT_NODE&&t.hasStyleClass("webkit-html-message-bubble")||((t=document.createElement("div")).className="webkit-html-message-bubble",this._messageBubbles[e.line]=t,this._textViewer.addDecoration(e.line-1,t));var i,n=this._rowMessages[e.line];n||(n=[],this._rowMessages[e.line]=n);for(var s=0;s<n.length;++s)if(n[s].isEqual(e))return void this._incrementMessageRepeatCount(n[s],e.repeatDelta);switch(n.push(e),e.level){case WebInspector.ConsoleMessage.MessageLevel.Error:t.addStyleClass("webkit-html-error-message"),i="Images/errorIcon.png";break;case WebInspector.ConsoleMessage.MessageLevel.Warning:t.addStyleClass("webkit-html-warning-message"),i="Images/warningIcon.png"}var o=document.createElement("div");o.className="webkit-html-message-line",t.appendChild(o);
// Create the image element in the Inspector's document so we can use relative image URLs.
var r=document.createElement("img");r.src=i,r.className="webkit-html-message-icon",o.appendChild(r),o.appendChild(document.createTextNode(e.message)),e._resourceMessageLineElement=o}},_breakpointAdded:function(e){var t=e.data;if(this._shouldDisplayBreakpoint(t)){var i=t.locations.length,n=i?t.locations[0]:t,s=this._content.actualLocationToSourceFrameLineNumber(n.lineNumber,n.columnNumber);if(!(s>=this._textModel.linesCount))this._textViewerLineNumberToBreakpointId[s]?WebInspector.debuggerModel.removeBreakpoint(t.id):(this._breakpointIdToTextViewerLineNumber[t.id]=s,this._textViewerLineNumberToBreakpointId[s]=t.id,this._setBreakpointDecoration(s,i,t.enabled,!!t.condition))}},_breakpointRemoved:function(e){var t=e.data,i=this._breakpointIdToTextViewerLineNumber[t];void 0!==i&&(delete this._breakpointIdToTextViewerLineNumber[t],delete this._textViewerLineNumberToBreakpointId[i],this._removeBreakpointDecoration(i))},_breakpointResolved:function(e){var t=e.data;this._breakpointRemoved({data:t.id}),this._breakpointAdded({data:t})},_setBreakpointDecoration:function(e,t,i,n){this._textViewer.beginUpdates(),this._textViewer.addDecoration(e,"webkit-breakpoint"),i||this._textViewer.addDecoration(e,"webkit-breakpoint-disabled"),n&&this._textViewer.addDecoration(e,"webkit-breakpoint-conditional"),this._textViewer.endUpdates()},_removeBreakpointDecoration:function(e){this._textViewer.beginUpdates(),this._textViewer.removeDecoration(e,"webkit-breakpoint"),this._textViewer.removeDecoration(e,"webkit-breakpoint-disabled"),this._textViewer.removeDecoration(e,"webkit-breakpoint-conditional"),this._textViewer.endUpdates()},_contextMenu:function(e){if(WebInspector.panels.scripts){var t=e.target.enclosingNodeOrSelfWithClass("webkit-line-number");if(t){var i=t.lineNumber,n=new WebInspector.ContextMenu;n.appendItem(WebInspector.UIString("Continue to Here"),this._continueToLine.bind(this,i));var s=this._findBreakpoint(i);if(s){function o(e){WebInspector.debuggerModel.updateBreakpoint(s.id,s.condition,e)}n.appendItem(WebInspector.UIString("Remove Breakpoint"),
// This row has a breakpoint, we want to show edit and remove breakpoint, and either disable or enable.
function(){WebInspector.debuggerModel.removeBreakpoint(s.id)}),n.appendItem(WebInspector.UIString("Edit Breakpoint…"),function(){this._editBreakpointCondition(i,s.condition,function(e,t){e&&WebInspector.debuggerModel.updateBreakpoint(s.id,t,s.enabled)}.bind(this))}.bind(this)),s.enabled?n.appendItem(WebInspector.UIString("Disable Breakpoint"),o.bind(this,!1)):n.appendItem(WebInspector.UIString("Enable Breakpoint"),o.bind(this,!0))}else{
// This row doesn't have a breakpoint: We want to show Add Breakpoint and Add and Edit Breakpoint.
n.appendItem(WebInspector.UIString("Add Breakpoint"),this._setBreakpoint.bind(this,i,"",!0)),n.appendItem(WebInspector.UIString("Add Conditional Breakpoint…"),function(){this._setBreakpointDecoration(i,!0,!0,!0),this._editBreakpointCondition(i,"",function(e,t){this._removeBreakpointDecoration(i),e&&this._setBreakpoint(i,t,!0)}.bind(this))}.bind(this))}n.show(e)}}},_scroll:function(e){this._hidePopup()},_mouseDown:function(e){if(this._resetHoverTimer(),this._hidePopup(),!(0!=e.button||e.altKey||e.ctrlKey||e.metaKey)){var t=e.target.enclosingNodeOrSelfWithClass("webkit-line-number");if(t){var i=t.lineNumber,n=this._findBreakpoint(i);n?e.shiftKey?WebInspector.debuggerModel.updateBreakpoint(n.id,n.condition,!n.enabled):WebInspector.debuggerModel.removeBreakpoint(n.id):this._setBreakpoint(i,"",!0),e.preventDefault()}}},_mouseMove:function(e){
// Pretend that nothing has happened.
if(this._hoverElement!==e.target&&!e.target.hasStyleClass("source-frame-eval-expression")){
// User has 500ms to reach the popup.
if(this._resetHoverTimer(),this._popup){var t=this;"_hidePopupTimer"in this||(this._hidePopupTimer=setTimeout(function(){t._hidePopup(),delete t._hidePopupTimer},500))}
// Now that cleanup routines are set up above, leave this in case we are not on a break.
if(this._hoverElement=e.target,WebInspector.panels.scripts&&WebInspector.panels.scripts.paused){
// We are interested in identifiers and "this" keyword.
if(this._hoverElement.hasStyleClass("webkit-javascript-keyword")){if("this"!==this._hoverElement.textContent)return}else if(!this._hoverElement.hasStyleClass("webkit-javascript-ident"))return;var i=this._popup?600:1e3;this._hoverTimer=setTimeout(this._mouseHover.bind(this,this._hoverElement),i)}}},_resetHoverTimer:function(){this._hoverTimer&&(clearTimeout(this._hoverTimer),delete this._hoverTimer)},_hidePopup:function(){if(this._popup){for(
// Replace higlight element with its contents inplace.
var e=this._popup.highlightElement.parentElement,t=this._popup.highlightElement.firstChild;t;){var i=t.nextSibling;e.insertBefore(t,this._popup.highlightElement),t=i}e.removeChild(this._popup.highlightElement),this._popup.hide(),delete this._popup,InspectorBackend.releaseWrapperObjectGroup(0,this._popoverObjectGroup)}},_mouseHover:function(e){if((delete this._hoverTimer,WebInspector.panels.scripts&&WebInspector.panels.scripts.paused)&&e.enclosingNodeOrSelfWithClass("webkit-line-content")){for(
// Collect tokens belonging to evaluated exression.
var t=[e],i=e.previousSibling;i&&("webkit-javascript-ident"===i.className||"webkit-javascript-keyword"===i.className||"."===i.textContent.trim());)t.push(i),i=i.previousSibling;t.reverse();for(
// Wrap them with highlight element.
var n=e.parentElement,s=e.nextSibling,o=document.createElement("span"),r=0;r<t.length;++r)o.appendChild(t[r]);n.insertBefore(o,s),this._showPopup(o)}},_showPopup:function(s){function t(e){if(WebInspector.panels.scripts.paused){var t=null;if("object"!==e.type&&"node"!==e.type&&"array"!==e.type)(t=document.createElement("span")).className="monospace console-formatted-"+e.type,t.style.whiteSpace="pre",t.textContent=e.description,"string"===e.type&&(t.textContent='"'+t.textContent+'"'),this._popup=new WebInspector.Popover(t),this._popup.show(s);else{t=document.createElement("div");var i=document.createElement("div");i.className="source-frame-popover-title monospace",i.textContent=e.description,t.appendChild(i);var n=new WebInspector.ObjectPropertiesSection(e,"",null,!1);n.expanded=!0,n.element.addStyleClass("source-frame-popover-tree"),n.headerElement.addStyleClass("hidden"),t.appendChild(n.element),this._popup=new WebInspector.Popover(t);this._popup.show(s,300,250)}this._popup.highlightElement=s,this._popup.highlightElement.addStyleClass("source-frame-eval-expression"),t.addEventListener("mousemove",function(){this._hidePopupTimer&&(clearTimeout(this._hidePopupTimer),delete this._hidePopupTimer,
// We know that we reached the popup, but we might have moved over other elements.
// Discard pending command.
this._resetHoverTimer())}.bind(this),!0)}}WebInspector.panels.scripts.evaluateInSelectedCallFrame(s.textContent,!1,this._popoverObjectGroup,!1,function(e){e.isError()||WebInspector.panels.scripts.paused&&t.call(this,e)}.bind(this))},_editBreakpointCondition:function(n,e,s){function t(e,t,i){this._textViewer.removeDecoration(n,this._conditionElement),delete this._conditionEditorElement,delete this._conditionElement,s(e,i)}this._conditionElement=this._createConditionElement(n),this._textViewer.addDecoration(n,this._conditionElement),WebInspector.startEditing(this._conditionEditorElement,{context:null,commitHandler:t.bind(this,!0),cancelHandler:t.bind(this,!1)}),this._conditionEditorElement.value=e,this._conditionEditorElement.select()},_createConditionElement:function(e){var t=document.createElement("div");t.className="source-frame-breakpoint-condition";var i=document.createElement("label");i.className="source-frame-breakpoint-message",i.htmlFor="source-frame-breakpoint-condition",i.appendChild(document.createTextNode(WebInspector.UIString("The breakpoint on line %d will stop only if this expression is true:",e))),t.appendChild(i);var n=document.createElement("input");return n.id="source-frame-breakpoint-condition",n.className="monospace",n.type="text",t.appendChild(n),this._conditionEditorElement=n,t},_evalSelectionInCallFrame:function(e){if(WebInspector.panels.scripts&&WebInspector.panels.scripts.paused){var t=this.element.contentWindow.getSelection();if(t.rangeCount){var i=t.getRangeAt(0).toString().trim();WebInspector.panels.scripts.evaluateInSelectedCallFrame(i,!1,"console",function(e){WebInspector.showConsole();var t=new WebInspector.ConsoleCommand(i);WebInspector.console.addMessage(t),WebInspector.console.addMessage(new WebInspector.ConsoleCommandResult(e,t))})}}},resize:function(){this._textViewer&&this._textViewer.resize()},formatSource:function(){this._content&&(new WebInspector.ScriptFormatter).formatContent(this._content,function(e){this._content=e,this._textModel.setText(null,e.text),this._setTextViewerDecorations()}.bind(this))},_continueToLine:function(e){var t=this._content.sourceFrameLineNumberToActualLocation(e);t.sourceID&&WebInspector.debuggerModel.continueToLocation(t.sourceID,t.lineNumber,t.columnNumber)},_doubleClick:function(e){if(Preferences.canEditScriptSource&&this._isScript){var t=e.target.enclosingNodeOrSelfWithClass("webkit-line-content");if(t){// Do not trigger editing from line numbers.
var s=t.lineNumber,o=this._content.sourceFrameLineNumberToActualLocation(s);o.sourceID&&this._textViewer.editLine(t,function(e){for(var t=[],i=this._content.text.split("\n"),n=0;n<i.length;++n)n===s?t.push(e):t.push(i[n]);WebInspector.debuggerModel.editScriptSource(o.sourceID,t.join("\n"))}.bind(this))}}},_setBreakpoint:function(e,t,i){var n=this._content.sourceFrameLineNumberToActualLocation(e);if(this._url)WebInspector.debuggerModel.setBreakpoint(this._url,n.lineNumber,n.columnNumber,t,i);else{if(!n.sourceID)return;WebInspector.debuggerModel.setBreakpointBySourceId(n.sourceID,n.lineNumber,n.columnNumber,t,i)}WebInspector.panels.scripts.breakpointsActivated||WebInspector.panels.scripts.toggleBreakpointsClicked()},_findBreakpoint:function(e){var t=this._textViewerLineNumberToBreakpointId[e];return WebInspector.debuggerModel.breakpointForId(t)}},WebInspector.SourceFrame.prototype.__proto__=WebInspector.View.prototype,WebInspector.SourceFrameContentProvider=function(){},WebInspector.SourceFrameContentProvider.prototype={requestContent:function(e){
// Should be implemented by subclasses.
}};