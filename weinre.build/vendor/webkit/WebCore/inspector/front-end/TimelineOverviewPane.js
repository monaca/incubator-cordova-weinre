/*
 * Copyright (C) 2009 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
WebInspector.TimelineOverviewPane=function(e){for(var t in this._categories=e,this.statusBarFilters=document.createElement("div"),this.statusBarFilters.className="status-bar-items",this._categories){var i=this._categories[t];this.statusBarFilters.appendChild(this._createTimelineCategoryStatusBarCheckbox(i,this._onCheckboxClicked.bind(this,i)))}this._overviewGrid=new WebInspector.TimelineGrid,this._overviewGrid.element.id="timeline-overview-grid",this._overviewGrid.itemsGraphsElement.id="timeline-overview-timelines",this._overviewGrid.element.addEventListener("mousedown",this._dragWindow.bind(this),!0),this._heapGraph=new WebInspector.HeapGraph,this._heapGraph.element.id="timeline-overview-memory",this._overviewGrid.element.insertBefore(this._heapGraph.element,this._overviewGrid.itemsGraphsElement),this.element=this._overviewGrid.element,this._categoryGraphs={};var n=0;for(var i in this._categories){var r=new WebInspector.TimelineCategoryGraph(this._categories[i],n++%2);this._categoryGraphs[i]=r,this._overviewGrid.itemsGraphsElement.appendChild(r.graphElement)}this._overviewGrid.setScrollAndDividerTop(0,0),this._overviewWindowElement=document.createElement("div"),this._overviewWindowElement.id="timeline-overview-window",this._overviewGrid.element.appendChild(this._overviewWindowElement),this._overviewWindowBordersElement=document.createElement("div"),this._overviewWindowBordersElement.className="timeline-overview-window-rulers",this._overviewGrid.element.appendChild(this._overviewWindowBordersElement);var s=document.createElement("div");s.className="timeline-overview-dividers-background",this._overviewGrid.element.appendChild(s),this._leftResizeElement=document.createElement("div"),this._leftResizeElement.className="timeline-window-resizer",this._leftResizeElement.style.left=0,this._overviewGrid.element.appendChild(this._leftResizeElement),this._rightResizeElement=document.createElement("div"),this._rightResizeElement.className="timeline-window-resizer timeline-window-resizer-right",this._rightResizeElement.style.right=0,this._overviewGrid.element.appendChild(this._rightResizeElement),this._overviewCalculator=new WebInspector.TimelineOverviewCalculator,this.windowLeft=0,this.windowRight=1},WebInspector.TimelineOverviewPane.minSelectableSize=12,WebInspector.TimelineOverviewPane.prototype={showTimelines:function(e){this._heapGraph.hide(),this._overviewGrid.itemsGraphsElement.removeStyleClass("hidden")},showMemoryGraph:function(e){this._heapGraph.show(),this._heapGraph.update(e),this._overviewGrid.itemsGraphsElement.addStyleClass("hidden")},_onCheckboxClicked:function(e,t){t.target.checked?e.hidden=!1:e.hidden=!0,this._categoryGraphs[e.name].dimmed=!t.target.checked,this.dispatchEventToListeners("filter changed")},_forAllRecords:function(e,t){if(e)for(var i=0;i<e.length;++i)t(e[i]),this._forAllRecords(e[i].children,t)},update:function(e,t){this._showShortEvents=t;
// Clear summary bars.
var s={};for(var i in this._categories)s[i]=[],this._categoryGraphs[i].clearChunks();
// Create sparse arrays with 101 cells each to fill with chunks for a given category.
// Convert sparse arrays to continuous segments, render graphs for each.
for(var i in this._overviewCalculator.reset(),this._forAllRecords(e,this._overviewCalculator.updateBoundaries.bind(this._overviewCalculator)),this._forAllRecords(e,function(e){if(this._showShortEvents||e.isLong())for(var t=this._overviewCalculator.computeBarGraphPercentages(e),i=Math.round(t.end),n=e.category.name,r=Math.round(t.start);r<=i;++r)s[n][r]=!0}.bind(this)),this._categories){var n=s[i];window.timelineSaved=n;for(var r=-1,o=0;o<101;++o)n[o]?-1===r&&(r=o):-1!==r&&(this._categoryGraphs[i].addChunk(r,o),r=-1);-1!==r&&(this._categoryGraphs[i].addChunk(r,100),r=-1)}this._heapGraph.setSize(this._overviewGrid.element.offsetWidth,60),this._heapGraph.visible&&this._heapGraph.update(e),this._overviewGrid.updateDividers(!0,this._overviewCalculator)},updateEventDividers:function(e,t){this._overviewGrid.removeEventDividers();for(var i=[],n=0;n<e.length;++n){var r=e[n],s=this._overviewCalculator.computeBarGraphPercentages(r),o=Math.round(10*s.start);if(!i[o]){var a=t(r);a.style.left=s.start+"%",i[o]=a}}this._overviewGrid.addEventDividers(i)},updateMainViewWidth:function(e,t){this._overviewGrid.element.style.left=e+"px",this.statusBarFilters.style.left=Math.max(155,e)+"px"},reset:function(){this.windowLeft=0,this.windowRight=1,this._overviewWindowElement.style.left="0%",this._overviewWindowElement.style.width="100%",this._overviewWindowBordersElement.style.left="0%",this._overviewWindowBordersElement.style.right="0%",this._leftResizeElement.style.left="0%",this._rightResizeElement.style.left="100%",this._overviewCalculator.reset(),this._overviewGrid.updateDividers(!0,this._overviewCalculator)},_resizeWindow:function(e,t){WebInspector.elementDragStart(e,this._windowResizeDragging.bind(this,e),this._endWindowDragging.bind(this),t,"col-resize")},_windowResizeDragging:function(e,t){e===this._leftResizeElement?this._resizeWindowLeft(t.pageX-this._overviewGrid.element.offsetLeft):this._resizeWindowRight(t.pageX-this._overviewGrid.element.offsetLeft),t.preventDefault()},_dragWindow:function(e){for(var t=e.target;t;){if(t===this._overviewGrid._dividersLabelBarElement){WebInspector.elementDragStart(this._overviewWindowElement,this._windowDragging.bind(this,e.pageX,this._leftResizeElement.offsetLeft,this._rightResizeElement.offsetLeft),this._endWindowDragging.bind(this),e,"ew-resize");break}if(t===this._overviewGrid.element){var i=e.pageX-this._overviewGrid.element.offsetLeft;this._overviewWindowSelector=new WebInspector.TimelinePanel.WindowSelector(this._overviewGrid.element,i,e),WebInspector.elementDragStart(null,this._windowSelectorDragging.bind(this),this._endWindowSelectorDragging.bind(this),e,"col-resize");break}if(t===this._leftResizeElement||t===this._rightResizeElement){this._resizeWindow(t,e);break}t=t.parentNode}},_windowSelectorDragging:function(e){this._overviewWindowSelector._updatePosition(e.pageX-this._overviewGrid.element.offsetLeft),e.preventDefault()},_endWindowSelectorDragging:function(e){WebInspector.elementDragEnd(e);var t=this._overviewWindowSelector._close(e.pageX-this._overviewGrid.element.offsetLeft);delete this._overviewWindowSelector,t.end-t.start<WebInspector.TimelineOverviewPane.minSelectableSize&&(this._overviewGrid.itemsGraphsElement.offsetWidth-t.end>WebInspector.TimelineOverviewPane.minSelectableSize?t.end=t.start+WebInspector.TimelineOverviewPane.minSelectableSize:t.start=t.end-WebInspector.TimelineOverviewPane.minSelectableSize),this._setWindowPosition(t.start,t.end)},_windowDragging:function(e,t,i,n){var r=n.pageX-e,s=t+r,o=i+r,a=i-t;s<0&&(s=0,o=a),o>this._overviewGrid.element.clientWidth&&(s=(o=this._overviewGrid.element.clientWidth)-a),this._setWindowPosition(s,o),n.preventDefault()},_resizeWindowLeft:function(e){
// Glue to edge.
e<10?e=0:e>this._rightResizeElement.offsetLeft-4&&(e=this._rightResizeElement.offsetLeft-4),this._setWindowPosition(e,null)},_resizeWindowRight:function(e){
// Glue to edge.
e>this._overviewGrid.element.clientWidth-10?e=this._overviewGrid.element.clientWidth:e<this._leftResizeElement.offsetLeft+WebInspector.TimelineOverviewPane.minSelectableSize&&(e=this._leftResizeElement.offsetLeft+WebInspector.TimelineOverviewPane.minSelectableSize),this._setWindowPosition(null,e)},_setWindowPosition:function(e,t){var i=1/this._overviewGrid.element.clientWidth;"number"==typeof e&&(this.windowLeft=e/this._overviewGrid.element.clientWidth,this._leftResizeElement.style.left=100*this.windowLeft+"%",this._overviewWindowElement.style.left=100*this.windowLeft+"%",this._overviewWindowBordersElement.style.left=100*(this.windowLeft-i)+"%"),"number"==typeof t&&(this.windowRight=t/this._overviewGrid.element.clientWidth,this._rightResizeElement.style.left=100*this.windowRight+"%"),this._overviewWindowElement.style.width=100*(this.windowRight-this.windowLeft)+"%",this._overviewWindowBordersElement.style.right=100*(1-this.windowRight+2*i)+"%",this.dispatchEventToListeners("window changed")},_endWindowDragging:function(e){WebInspector.elementDragEnd(e)},_createTimelineCategoryStatusBarCheckbox:function(e,t){var i=document.createElement("div");i.addStyleClass("timeline-category-statusbar-item"),i.addStyleClass("timeline-category-"+e.name),i.addStyleClass("status-bar-item");var n=document.createElement("label"),r=document.createElement("input");r.type="checkbox",r.className="timeline-category-checkbox",r.checked=!0,r.addEventListener("click",t),n.appendChild(r);var s=document.createElement("span");return s.className="type",s.textContent=e.title,n.appendChild(s),i.appendChild(n),i}},WebInspector.TimelineOverviewPane.prototype.__proto__=WebInspector.Object.prototype,WebInspector.TimelineOverviewCalculator=function(){},WebInspector.TimelineOverviewCalculator.prototype={computeBarGraphPercentages:function(e){return{start:(e.startTime-this.minimumBoundary)/this.boundarySpan*100,end:(e.endTime-this.minimumBoundary)/this.boundarySpan*100}},reset:function(){delete this.minimumBoundary,delete this.maximumBoundary},updateBoundaries:function(e){return void 0===this.minimumBoundary||e.startTime<this.minimumBoundary?(this.minimumBoundary=e.startTime,!0):(void 0===this.maximumBoundary||e.endTime>this.maximumBoundary)&&(this.maximumBoundary=e.endTime,!0)},get boundarySpan(){return this.maximumBoundary-this.minimumBoundary},formatValue:function(e){return Number.secondsToString(e)}},WebInspector.TimelineCategoryGraph=function(e,t){this._category=e,this._graphElement=document.createElement("div"),this._graphElement.className="timeline-graph-side timeline-overview-graph-side"+(t?" even":""),this._barAreaElement=document.createElement("div"),this._barAreaElement.className="timeline-graph-bar-area timeline-category-"+e.name,this._graphElement.appendChild(this._barAreaElement)},WebInspector.TimelineCategoryGraph.prototype={get graphElement(){return this._graphElement},addChunk:function(e,t){var i=document.createElement("div");i.className="timeline-graph-bar",this._barAreaElement.appendChild(i),i.style.setProperty("left",e+"%"),i.style.setProperty("width",t-e+"%")},clearChunks:function(){this._barAreaElement.removeChildren()},set dimmed(e){e?this._barAreaElement.removeStyleClass("timeline-category-"+this._category.name):this._barAreaElement.addStyleClass("timeline-category-"+this._category.name)}},WebInspector.TimelinePanel.WindowSelector=function(e,t,i){this._startPosition=t,this._width=e.offsetWidth,this._windowSelector=document.createElement("div"),this._windowSelector.className="timeline-window-selector",this._windowSelector.style.left=this._startPosition+"px",this._windowSelector.style.right=this._width-this._startPosition+NaN,e.appendChild(this._windowSelector)},WebInspector.TimelinePanel.WindowSelector.prototype={_createSelectorElement:function(e,t,i,n){var r=document.createElement("div");return r.className="timeline-window-selector",r.style.left=t+"px",r.style.width=i+"px",r.style.top="0px",r.style.height=n+"px",e.appendChild(r),r},_close:function(e){return e=Math.max(0,Math.min(e,this._width)),this._windowSelector.parentNode.removeChild(this._windowSelector),this._startPosition<e?{start:this._startPosition,end:e}:{start:e,end:this._startPosition}},_updatePosition:function(e){(e=Math.max(0,Math.min(e,this._width)))<this._startPosition?(this._windowSelector.style.left=e+"px",this._windowSelector.style.right=this._width-this._startPosition+"px"):(this._windowSelector.style.left=this._startPosition+"px",this._windowSelector.style.right=this._width-e+"px")}},WebInspector.HeapGraph=function(){this._canvas=document.createElement("canvas"),this._maxHeapSizeLabel=document.createElement("div"),this._maxHeapSizeLabel.addStyleClass("memory-graph-label"),this._element=document.createElement("div"),this._element.addStyleClass("hidden"),this._element.appendChild(this._canvas),this._element.appendChild(this._maxHeapSizeLabel)},WebInspector.HeapGraph.prototype={get element(){
//    return this._canvas;
return this._element},get visible(){return!this.element.hasStyleClass("hidden")},show:function(){this.element.removeStyleClass("hidden")},hide:function(){this.element.addStyleClass("hidden")},setSize:function(e,t){this._canvas.width=e,this._canvas.height=t-5},update:function(e){if(e.length){var n,t,i=0;this._forAllRecords(e,function(e){e.totalHeapSize&&e.totalHeapSize>i&&(i=e.totalHeapSize),(void 0===n||e.startTime<n)&&(n=e.startTime),(void 0===t||e.endTime>t)&&(t=e.endTime)});var r=this._canvas.width,s=this._canvas.height,o=r/(t-n),a=s/i,l=new Array(r);this._forAllRecords(e,function(e){if(e.usedHeapSize){var t=Math.round((e.endTime-n)*o),i=Math.round(e.usedHeapSize*a);l[t]=Math.max(l[t]||0,i)}});var h=this._canvas.getContext("2d");this._clear(h),
// +1 so that the border always fit into the canvas area.
s+=1,h.beginPath();for(var d=0,m=0;m<l.length;m++)if(l[m]){d=l[m];break}h.moveTo(0,s-d);for(var v=0;v<l.length;v++)l[v]&&h.lineTo(v,s-l[v]);h.lineWidth=.5,h.strokeStyle="rgba(20,0,0,0.8)",h.stroke(),h.fillStyle="rgba(214,225,254, 0.8);",h.lineTo(r,60),h.lineTo(0,60),h.lineTo(0,s-d),h.fill(),h.closePath(),this._maxHeapSizeLabel.textContent=Number.bytesToString(i)}},_clear:function(e){e.fillStyle="rgba(255,255,255,0.8)",e.fillRect(0,0,this._canvas.width,this._canvas.height)},_forAllRecords:WebInspector.TimelineOverviewPane.prototype._forAllRecords};